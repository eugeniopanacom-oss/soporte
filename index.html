Mi admin.html:
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A.S. Studio - Panel de Administración</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <style>
        /* Variables de tema oscuro */
        :root {
            --primary: #d4af37;
            --primary-dark: #b8941f;
            --dark: #121212;
            --darker: #0a0a0a;
            --light: #f5f5f5;
            --gray: #2a2a2a;
            --gray-light: #3a3a3a;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
            --info: #2196f3;
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        /* Reset y estilos base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--dark);
            color: var(--light);
            line-height: 1.6;
            min-height: 100vh;
        }

        .calendar-day.disabled-pasado {
            background-color: var(--darker) !important;
            color: #666 !important;
            cursor: not-allowed !important;
            opacity: 0.5 !important;
            position: relative;
        }

        .calendar-day.disabled-pasado:hover {
            background-color: var(--darker) !important;
            transform: none !important;
        }

        .calendar-day.disabled-pasado:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: var(--border-radius);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .admin-header {
            background-color: var(--darker);
            padding: 20px;
            border-bottom: 2px solid var(--primary);
            margin-bottom: 30px;
            border-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            color: var(--primary);
            font-size: 2.5rem;
        }

        .logo h1 {
            font-size: 2.5rem;
            color: var(--primary);
            letter-spacing: 2px;
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .admin-tag {
            background-color: var(--primary);
            color: var(--dark);
            padding: 8px 15px;
            border-radius: var(--border-radius);
            font-weight: bold;
        }

        .logout-btn {
            background-color: var(--error);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            transition: var(--transition);
        }

        .logout-btn:hover {
            background-color: #d32f2f;
        }

        /* Navegación del dashboard */
        .dashboard-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
            padding: 15px;
            background-color: var(--gray);
            border-radius: var(--border-radius);
        }

        .nav-btn {
            background-color: transparent;
            color: var(--light);
            border: 2px solid transparent;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-btn:hover,
        .nav-btn.active {
            background-color: var(--primary);
            color: var(--dark);
        }

        /* Secciones del dashboard */
        .dashboard-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .dashboard-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .section-title {
            color: var(--primary);
            font-size: 1.8rem;
            margin-bottom: 25px;
            position: relative;
            padding-bottom: 10px;
        }

        .section-title:after {
            content: '';
            display: block;
            width: 60px;
            height: 3px;
            background-color: var(--primary);
            margin-top: 10px;
        }

        /* Grid de dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .dashboard-card {
            background-color: var(--gray);
            padding: 25px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary);
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        /* Estadísticas rápidas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background-color: var(--gray);
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            border-top: 4px solid var(--primary);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
        }

        .stat-label {
            color: #aaa;
            font-size: 0.9rem;
        }

        /* Tarjetas de turnos */
        .turnos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .turno-card {
            background-color: var(--dark);
            border-radius: var(--border-radius);
            padding: 20px;
            border: 2px solid var(--gray-light);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .turno-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
        }

        .turno-card.active {
            border-color: var(--primary);
            background-color: rgba(212, 175, 55, 0.05);
        }

        .turno-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .turno-hora {
            background-color: var(--primary);
            color: var(--dark);
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .turno-estado {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .estado-pendiente {
            background-color: var(--warning);
            color: var(--dark);
        }

        .estado-confirmado {
            background-color: var(--info);
            color: white;
        }

        .estado-asistio {
            background-color: var(--success);
            color: white;
        }

        .estado-cancelado {
            background-color: var(--error);
            color: white;
        }

        .estado-no-asistio {
            background-color: #666;
            color: white;
        }

        .turno-cliente {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--light);
        }

        .turno-servicio {
            color: #aaa;
            margin-bottom: 5px;
            font-size: 0.95rem;
        }

        .turno-precio {
            color: var(--primary);
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .turno-whatsapp {
            color: #25D366;
            font-size: 0.9rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Botones de acción */
        .acciones-turno {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-accion {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-asistio {
            background-color: var(--success);
            color: white;
        }

        .btn-no-asistio {
            background-color: #666;
            color: white;
        }

        .btn-cancelar {
            background-color: var(--error);
            color: white;
        }

        .btn-confirmar {
            background-color: var(--info);
            color: white;
        }

        .btn-accion:hover {
            opacity: 0.8;
            transform: translateY(-2px);
        }

        /* Formularios */
        .form-container {
            background-color: var(--gray);
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 800px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary);
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            background-color: var(--dark);
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            color: var(--light);
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
            min-width: 250px;
        }

        /* ========== AGENDA MEJORADA ========== */
        .agenda-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .agenda-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Calendario de trabajo */
        .agenda-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            margin-top: 20px;
            background-color: var(--dark);
            padding: 10px;
            border-radius: var(--border-radius);
        }

        .calendar-header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }

        .calendar-day-name {
            text-align: center;
            padding: 8px 3px;
            font-weight: bold;
            color: var(--primary);
            background-color: var(--darker);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
        }

        .calendar-day {
            background-color: var(--gray);
            padding: 10px 5px;
            border-radius: var(--border-radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }

        .calendar-day:hover {
            background-color: var(--gray-light);
        }

        .calendar-day.active {
            background-color: var(--success);
            color: white;
        }

        .calendar-day.inactive {
            background-color: var(--error);
            color: white;
        }

        .calendar-day.today {
            border: 2px solid var(--primary);
        }

        .calendar-day.disabled {
            background-color: var(--darker);
            color: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .day-number {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .day-status {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            margin-bottom: 3px;
        }

        .day-hours {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 3px;
        }

        /* Configuración de horarios */
        .horarios-config {
            background-color: var(--dark);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 20px;
        }

        .horario-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        /* Descansos removibles mejorados */
        .descanso-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            border: 1px solid var(--gray-light);
            transition: var(--transition);
        }

        .descanso-item:hover {
            border-color: var(--primary);
        }

        .btn-eliminar-descanso {
            background-color: var(--error);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
        }

        .btn-eliminar-descanso:hover {
            background-color: #d32f2f;
        }

        /* Opciones de repetición */
        .opciones-repeticion {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .opcion-repeticion {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            background-color: var(--dark);
            border: 2px solid var(--gray-light);
            border-radius: var(--border-radius);
            cursor: pointer;
            text-align: center;
            transition: var(--transition);
        }

        .opcion-repeticion:hover {
            border-color: var(--primary);
        }

        .opcion-repeticion.active {
            background-color: var(--primary);
            color: var(--dark);
            border-color: var(--primary);
        }

        /* ========== CUADRO DE HORARIOS OCUPADOS EN TURNOS ========== */
        .cuadro-horarios {
            background-color: var(--dark);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .grid-horarios {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .celda-horario {
            background-color: var(--gray);
            padding: 12px;
            border-radius: var(--border-radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .celda-horario:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .celda-horario.ocupado {
            background-color: rgba(244, 67, 54, 0.3);
            border-color: var(--error);
        }

        .celda-horario.disponible {
            background-color: rgba(76, 175, 80, 0.3);
            border-color: var(--success);
        }

        .hora-texto {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--light);
        }

        .estado-texto {
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-top: 5px;
        }

        /* Modal para detalles de turno ocupado */
        .modal-detalle-turno {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--gray);
            padding: 25px;
            border-radius: var(--border-radius);
            border: 2px solid var(--primary);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            z-index: 10000;
            max-width: 400px;
            width: 90%;
            display: none;
        }

        .modal-detalle-turno.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        /* ========== OFERTAS MEJORADAS ========== */
        .opciones-duracion {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .opcion-duracion {
            background-color: var(--dark);
            padding: 15px;
            border-radius: var(--border-radius);
            border: 2px solid var(--gray-light);
            cursor: pointer;
            transition: var(--transition);
        }

        .opcion-duracion:hover {
            border-color: var(--primary);
        }

        .opcion-duracion.active {
            background-color: rgba(212, 175, 55, 0.2);
            border-color: var(--primary);
        }

        .rango-horario {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        /* ========== MÉTRICAS MENSUALES ========== */
        .metricas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .grafico-container {
            background-color: var(--dark);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--gray-light);
        }
        
        .grafico-title {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filtros-metricas {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .filtro-metrica {
            flex: 1;
            min-width: 200px;
        }
        
        .filtro-metrica label {
            display: block;
            margin-bottom: 5px;
            color: var(--primary);
            font-weight: bold;
        }
        
        .resumen-metricas {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .metrica-resumen {
            background-color: var(--gray);
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            border-top: 4px solid var(--primary);
        }
        
        .metrica-valor {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
        }
        
        .metrica-tendencia {
            font-size: 0.9rem;
            padding: 5px 10px;
            border-radius: 15px;
            display: inline-block;
            margin-top: 5px;
        }
        
        .tendencia-positiva {
            background-color: rgba(36, 222, 42, 0.48);
            color: var(--success);
        }
        
        .tendencia-negativa {
            background-color: rgba(244, 67, 54, 0.463);
            color: var(--error);
        }
        
        .tendencia-neutral {
            background-color: rgba(255, 193, 7, 0.39);
            color: var(--warning);
        }
        
        .tabla-metricas {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .tabla-metricas th {
            background-color: var(--darker);
            color: var(--primary);
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid var(--primary);
        }
        
        .tabla-metricas td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .tabla-metricas tr:hover {
            background-color: rgba(176, 144, 41, 0.886);
        }
        
        .badge-estado {
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .clientes-top {
            margin-top: 20px;
        }
        
        .cliente-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--dark);
            border-radius: var(--border-radius);
            margin-bottom: 8px;
            border-left: 4px solid var(--primary);
        }
        
        .cliente-visitas {
            background-color: var(--primary);
            color: var(--dark);
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: bold;
        }

        /* Notificaciones */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: bold;
            z-index: 10000;
            display: none;
            animation: slideInRight 0.5s ease;
        }

        .notification.success {
            background-color: var(--success);
        }

        .notification.error {
            background-color: var(--error);
        }

        .notification.info {
            background-color: var(--info);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 10001;
            display: none;
            justify-content: center;
            align-items: center;
            color: var(--primary);
            font-size: 1.5rem;
            flex-direction: column;
            gap: 20px;
        }

        .loading-overlay.active {
            display: flex;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                text-align: center;
            }

            .logo h1 {
                font-size: 2rem;
            }

            .dashboard-nav {
                justify-content: center;
            }

            .nav-btn {
                padding: 8px 15px;
                font-size: 0.9rem;
            }

            .turnos-grid {
                grid-template-columns: 1fr;
            }

            .agenda-grid {
                grid-template-columns: 1fr;
            }

            .grid-horarios {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .celda-horario {
                min-height: 70px;
                padding: 8px;
            }

            .opciones-repeticion {
                flex-direction: column;
            }

            .opcion-repeticion {
                min-width: 100%;
            }

            .rango-horario {
                grid-template-columns: 1fr;
            }
            
            .filtros-metricas {
                flex-direction: column;
            }
            
            .filtro-metrica {
                min-width: 100%;
            }
            
            .tabla-metricas {
                display: block;
                overflow-x: auto;
            }
        }

        @media (max-width: 480px) {
            .calendar-day {
                padding: 8px 3px;
                min-height: 60px;
            }

            .acciones-turno {
                flex-direction: column;
            }

            .btn-accion {
                width: 100%;
                justify-content: center;
            }

            .grid-horarios {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }

            .celda-horario {
                min-height: 60px;
                padding: 5px;
            }

            .hora-texto {
                font-size: 0.9rem;
            }

            .estado-texto {
                font-size: 0.7rem;
            }

/* Estados de turnos en la sección Turnos */
.celda-horario.ocupado {
    background-color: rgba(76, 175, 80, 0.3) !important; /* VERDE para ocupado */
    border-color: var(--success) !important;
}

.celda-horario.disponible {
    background-color: rgba(158, 158, 158, 0.3) !important; /* GRIS CLARO para disponible */
    border-color: #9e9e9e !important;
}

.celda-horario.descanso {
    background-color: rgba(33, 150, 243, 0.3) !important; /* CELESTE SUAVE para descanso */
    border-color: var(--info) !important;
}

/* ESTILOS PARA SELECCIÓN DE DÍA - SOLO BORDE VIOLETA */
.calendar-day.selected {
    border: 3px solid #9c27b0 !important;
    box-shadow: 0 0 10px rgba(156, 39, 176, 0.5) !important;
    position: relative !important;
    z-index: 10 !important;
}

/* Remover cualquier borde por defecto de otros estados */
.calendar-day {
    border: 2px solid transparent !important;
}

/* Día actual mantiene su estilo DORADO */
.calendar-day.today {
    border: 2px solid var(--primary) !important;
}

/* Si un día es hoy Y está seleccionado */
.calendar-day.today.selected {
    border: 3px solid #9c27b0 !important;
    box-shadow: 
        0 0 10px rgba(156, 39, 176, 0.5),
        0 0 15px rgba(212, 175, 55, 0.3) !important;
}

/* Estados activo/inactivo - solo color de fondo */
.calendar-day.active {
    background-color: rgba(76, 175, 80, 0.2) !important;
}

.calendar-day.inactive {
    background-color: rgba(244, 67, 54, 0.2) !important;
}

/* Días pasados deshabilitados */
.calendar-day.disabled-pasado {
    opacity: 0.5 !important;
    background-color: var(--darker) !important;
}

/* El borde seleccionado debe verse sobre días deshabilitados */
.calendar-day.disabled-pasado.selected {
    opacity: 1 !important;
    border: 3px solid #9c27b0 !important;
    box-shadow: 0 0 10px rgba(156, 39, 176, 0.5) !important;
}

/* Ajustes específicos para la sección Turnos */
.grid-horarios {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 12px;
}

.celda-horario {
    background-color: var(--gray);
    padding: 15px;
    border-radius: var(--border-radius);
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
    border: 3px solid transparent;
    min-height: 90px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: relative;
}

.celda-horario:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.celda-horario.ocupado {
    background-color: rgba(76, 175, 80, 0.3);
    border-color: var(--success);
}

.celda-horario.disponible {
    background-color: rgba(158, 158, 158, 0.3);
    border-color: #9e9e9e;
}

.celda-horario.descanso {
    background-color: rgba(33, 150, 243, 0.3);
    border-color: var(--info);
}

.hora-texto {
    font-weight: bold;
    margin-bottom: 8px;
    color: var(--light);
    font-size: 1.1rem;
}

.estado-texto {
    font-size: 0.75rem;
    padding: 4px 8px;
    border-radius: 12px;
    margin-top: 5px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.cuadro-horarios {
    background-color: var(--dark);
    padding: 20px;
    border-radius: var(--border-radius);
    margin-top: 15px;
    max-height: 600px;
    overflow-y: auto;
    border: 1px solid var(--gray-light);
}

/* Responsive para mobile */
@media (max-width: 768px) {
    .grid-horarios {
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        gap: 8px;
    }
    
    .celda-horario {
        min-height: 80px;
        padding: 10px;
    }
    
    .hora-texto {
        font-size: 1rem;
    }
    
    .estado-texto {
        font-size: 0.7rem;
    }
}

@media (max-width: 480px) {
    .grid-horarios {
        grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
    }
    
    .celda-horario {
        min-height: 70px;
        padding: 8px;
    }
}

/* Contador de fidelidad mejorado */
.contador-fidelidad {
    background: rgba(156, 39, 176, 0.15);
    border: 2px solid #9c27b0;
    border-radius: var(--border-radius);
    padding: 15px;
    margin-top: 10px;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.contador-fidelidad.contador-proximo-gratis {
    background: rgba(255, 235, 59, 0.15);
    border: 2px solid #ffeb3b;
    animation: pulse-gratis 2s infinite;
}

@keyframes pulse-gratis {
    0%, 100% { 
        box-shadow: 0 0 20px rgba(255, 235, 59, 0.7);
        border-color: #ffeb3b;
    }
    50% { 
        box-shadow: 0 0 30px rgba(255, 235, 59, 1);
        border-color: #ffcc00;
    }
}

.contador-titulo {
    color: #e0aaff;
    font-size: 0.9rem;
    margin-bottom: 8px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.contador-numero {
    color: #ff00ff;
    font-size: 2rem;
    font-weight: bold;
    margin: 10px 0;
    font-family: 'Arial Black', sans-serif;
}

.contador-subtitulo {
    color: #d8b4fe;
    font-size: 0.85rem;
    opacity: 0.9;
}

/* Estilos para contenedores de gráficos */
.grafico-container {
    background-color: var(--dark);
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid var(--gray-light);
    position: relative;
    min-height: 300px;
    height: 300px;
}

/* Asegurar que los canvas se ajusten al contenedor */
.grafico-container canvas {
    width: 100% !important;
    height: 100% !important;
    max-height: 260px;
}

/* Títulos de gráficos */
.grafico-title {
    color: var(--primary);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.1rem;
    border-bottom: 2px solid var(--primary);
    padding-bottom: 8px;
}

/* Responsive para gráficos */
@media (max-width: 768px) {
    .grafico-container {
        min-height: 250px;
        height: 250px;
    }
    
    .grafico-container canvas {
        max-height: 200px;
    }
}
}

/* Estilo para horas de turnos pasados */
.turno-hora.pasado {
    background-color: #666 !important;
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 1.1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
}

/* Indicador visual para turnos próximos */
.turno-hora.hoy {
    background-color: var(--primary) !important;
    color: var(--dark);
    padding: 5px 12px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 1.1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
}

/* Indicador de turno próximo */
.turno-proximo {
    position: absolute;
    top: 10px;
    right: 10px;
    background-color: #4caf50;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: bold;
}

/* Contador de turnos próximos */
.contador-proximos {
    background-color: rgba(212, 175, 55, 0.1);
    border: 1px solid var(--primary);
    border-radius: var(--border-radius);
    padding: 10px;
    margin-bottom: 15px;
    text-align: center;
}

.contador-proximos .numero {
    color: var(--primary);
    font-size: 2rem;
    font-weight: bold;
}

.contador-proximos .texto {
    color: #aaa;
    font-size: 0.9rem;
}

/* Agregar estos estilos al CSS existente */
.celda-horario.pasado {
    background-color: rgba(128, 128, 128, 0.2) !important;
    border-color: #666 !important;
    opacity: 0.5 !important;
    position: relative;
}

.celda-horario.pasado:after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.1) 100%);
    border-radius: var(--border-radius);
    pointer-events: none;
}

.celda-horario.pasado .hora-texto {
    color: #999 !important;
}

.celda-horario.pasado .estado-texto {
    background-color: #666 !important;
    color: #ccc !important;
}

/* Agregar estos estilos al CSS existente */
#turnos .cuadro-horarios {
    margin-top: 0 !important;
}

/* Estilo para el botón Volver a Hoy */
.btn-accion.btn-asistio {
    background-color: var(--primary) !important;
    color: var(--dark) !important;
    border: 2px solid var(--primary-dark) !important;
}

.btn-accion.btn-asistio:hover {
    background-color: var(--primary-dark) !important;
    transform: translateY(-2px) !important;
}

/* Ajustar altura del grid */
#turnos .grid-horarios {
    min-height: 450px;
}

/* Estilos para servicio adicional */
.btn-servicio-adicional {
    background-color: #2196f3 !important;
    color: white !important;
    border: none;
    padding: 8px 15px;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-size: 0.9rem;
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: var(--transition);
}

.btn-servicio-adicional:hover {
    background-color: #0b7dda !important;
    transform: translateY(-2px);
}

/* Modal de servicios adicionales */
.modal-servicios-adicionales {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: var(--gray);
    padding: 25px;
    border-radius: var(--border-radius);
    border: 2px solid var(--primary);
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
    z-index: 10002;
    max-width: 500px;
    width: 90%;
    display: none;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-servicios-adicionales.active {
    display: block;
    animation: slideIn 0.3s ease;
}

.lista-servicios-adicionales {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin: 20px 0;
}

.servicio-adicional-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background-color: var(--dark);
    border-radius: var(--border-radius);
    border: 1px solid var(--gray-light);
    transition: var(--transition);
}

.servicio-adicional-item:hover {
    border-color: var(--primary);
}

.servicio-adicional-item.seleccionado {
    background-color: rgba(33, 150, 243, 0.2);
    border-color: #2196f3;
}

.servicio-adicional-info {
    flex: 1;
}

.servicio-adicional-nombre {
    font-weight: bold;
    color: var(--light);
}

.servicio-adicional-precio {
    color: var(--primary);
    font-weight: bold;
}

.contador-servicio {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-left: 15px;
}

.btn-contador {
    background-color: var(--gray-light);
    color: var(--light);
    border: none;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
}

.btn-contador:hover {
    background-color: var(--primary);
    color: var(--dark);
}

.contador-valor {
    min-width: 30px;
    text-align: center;
    font-weight: bold;
    color: var(--primary);
}

/* Total a pagar */
.total-a-pagar {
    background-color: var(--dark);
    padding: 15px;
    border-radius: var(--border-radius);
    margin-top: 20px;
    border: 2px solid var(--primary);
}

.total-linea {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--gray-light);
}

.total-final {
    display: flex;
    justify-content: space-between;
    font-size: 1.2rem;
    font-weight: bold;
    color: var(--primary);
    margin-top: 10px;
    padding-top: 10px;
    border-top: 2px solid var(--primary);
}

/* Gestión de servicios adicionales */
.gestion-servicios-adicionales {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 2px solid var(--gray-light);
}

.grid-servicios-adicionales {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.card-servicio-adicional {
    background-color: var(--dark);
    padding: 15px;
    border-radius: var(--border-radius);
    border: 1px solid var(--gray-light);
}

.btn-eliminar-servicio {
    background-color: var(--error);
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-size: 0.8rem;
    margin-top: 10px;
    transition: var(--transition);
}

.btn-eliminar-servicio:hover {
    background-color: #d32f2f;
}

/* Estilos para el programa de fidelidad */
.contador-manual {
    background-color: rgba(156, 39, 176, 0.1);
    border: 2px solid #9c27b0;
    border-radius: var(--border-radius);
    padding: 15px;
    margin-top: 15px;
}

.controles-contador {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
}

.btn-contador-manual {
    background-color: var(--gray-light);
    color: var(--light);
    border: none;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    cursor: pointer;
    font-weight: bold;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
}

.btn-contador-manual:hover {
    background-color: var(--primary);
    color: var(--dark);
}

.valor-contador {
    min-width: 40px;
    text-align: center;
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--primary);
}

/* Modal de edición de fidelidad */
.modal-editar-fidelidad {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: var(--gray);
    padding: 25px;
    border-radius: var(--border-radius);
    border: 2px solid var(--primary);
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
    z-index: 10002;
    max-width: 500px;
    width: 90%;
    display: none;
}

.modal-editar-fidelidad.active {
    display: block;
    animation: slideIn 0.3s ease;
}

/* Lista de clientes en programa de fidelidad */
.lista-clientes-fidelidad {
    max-height: 400px;
    overflow-y: auto;
    margin-top: 15px;
}

.cliente-fidelidad-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background-color: var(--dark);
    border-radius: var(--border-radius);
    margin-bottom: 8px;
    border-left: 4px solid var(--primary);
    transition: var(--transition);
}

.cliente-fidelidad-item:hover {
    background-color: rgba(212, 175, 55, 0.1);
}

.contador-cliente {
    display: flex;
    align-items: center;
    gap: 10px;
}

.badge-proximo-gratis {
    background-color: #ffeb3b;
    color: var(--dark);
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 0.8rem;
    font-weight: bold;
    animation: pulse 2s infinite;
}

/* Modal de configuración de horarios semanales */
.modal-horarios-semana {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: var(--gray);
    padding: 25px;
    border-radius: var(--border-radius);
    border: 2px solid var(--primary);
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
    z-index: 10003;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    display: none;
}

.modal-horarios-semana.active {
    display: block;
    animation: slideIn 0.3s ease;
}

/* Configuración de día de la semana */
.dia-semana-config {
    background-color: var(--dark);
    padding: 15px;
    border-radius: var(--border-radius);
    margin-bottom: 15px;
    border-left: 4px solid var(--primary);
}

.dia-semana-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    cursor: pointer;
}

.dia-semana-nombre {
    font-weight: bold;
    color: var(--primary);
    font-size: 1.1rem;
}

.horarios-dia-container {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid var(--gray-light);
}

/* Botón para notificar cambios */
.btn-notificar {
    background: linear-gradient(135deg, #25D366, #128C7E);
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: var(--transition);
}

.btn-notificar:hover {
    background: linear-gradient(135deg, #128C7E, #075E54);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(37, 211, 102, 0.4);
}

/* Historial de notificaciones */
.notificacion-item {
    background-color: var(--dark);
    padding: 15px;
    border-radius: var(--border-radius);
    margin-bottom: 10px;
    border-left: 4px solid var(--info);
}

.notificacion-item.success {
    border-left-color: var(--success);
}

.notificacion-item.error {
    border-left-color: var(--error);
}

.notificacion-fecha {
    color: #aaa;
    font-size: 0.8rem;
    margin-bottom: 5px;
}

.notificacion-mensaje {
    color: var(--light);
    margin-bottom: 5px;
}

.programa-fidelidad {
    background-color: #1a2a1a !important;
    color: white !important;
}

.programa-fidelidad * {
    color: white !important;
}

.programa-fidelidad .card-title {
    color: #d4af37 !important;
}

.programa-fidelidad .btn-accion {
    color: #121212 !important;
}

/* Estilos para la lista compacta de turnos afectados */
.turno-afectado-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background-color: var(--dark);
    border-radius: var(--border-radius);
    margin-bottom: 8px;
    border-left: 4px solid var(--warning);
    transition: var(--transition);
    cursor: pointer;
}

.turno-afectado-item:hover {
    background-color: rgba(255, 152, 0, 0.1);
    transform: translateX(5px);
}

.turno-afectado-info {
    flex: 1;
}

.turno-afectado-fecha {
    font-weight: bold;
    color: var(--light);
    margin-bottom: 3px;
    font-size: 0.95rem;
}

.turno-afectado-hora {
    color: var(--primary);
    font-weight: bold;
    font-size: 0.9rem;
    margin-bottom: 3px;
}

.turno-afectado-cliente {
    color: #aaa;
    font-size: 0.85rem;
}

.btn-whatsapp-directo {
    background-color: #25D366;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: var(--transition);
}

.btn-whatsapp-directo:hover {
    background-color: #128C7E;
    transform: scale(1.05);
}

.btn-whatsapp-directo i {
    font-size: 1rem;
}

/* Indicador de turnos pendientes */
.notificacion-badge {
    background-color: var(--error);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: bold;
    margin-left: 10px;
}
    </style>
</head>

<body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner" style="width: 50px; height: 50px; border-width: 5px;"></div>
        <div>Cargando datos...</div>
    </div>

    <!-- Panel de administración -->
    <div class="container">
        <!-- Header -->
        <header class="admin-header">
            <div class="logo">
                <i class="fas fa-cut"></i>
                <h1>A.S. Studio</h1>
                <span class="admin-tag">PANEL DE ADMINISTRACIÓN</span>
            </div>

            <div class="admin-info">
                <div class="admin-user">
                    <i class="fas fa-user-shield"></i> Alexis - Barbero
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </button>
            </div>
        </header>

        <!-- Navegación del dashboard -->
        <nav class="dashboard-nav">
            <button class="nav-btn active" data-section="dashboard">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
            <button class="nav-btn" data-section="turnos">
                <i class="fas fa-calendar-alt"></i> Turnos
            </button>
            <button class="nav-btn" data-section="agenda">
                <i class="fas fa-clock"></i> Agenda
            </button>
            <button class="nav-btn" data-section="servicios">
                <i class="fas fa-cut"></i> Servicios
            </button>
            <button class="nav-btn" data-section="ofertas">
                <i class="fas fa-tag"></i> Ofertas
            </button>
            <button class="nav-btn" data-section="metricas">
                <i class="fas fa-chart-line"></i> Métricas
            </button>
        </nav>

        <!-- Dashboard principal -->
        <section id="dashboard" class="dashboard-section active">
            <h2 class="section-title">Resumen del Negocio</h2>

            <!-- Estadísticas rápidas -->
            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-calendar-check fa-2x"></i>
                    <div class="stat-number" id="turnosHoy">0</div>
                    <div class="stat-label">Turnos Hoy</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-users fa-2x"></i>
                    <div class="stat-number" id="clientesMes">0</div>
                    <div class="stat-label">Clientes este Mes</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-money-bill-wave fa-2x"></i>
                    <div class="stat-number" id="ingresosMes">$0</div>
                    <div class="stat-label">Ingresos del Mes</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-crown fa-2x"></i>
                    <div class="stat-number" id="clientesFieles">0</div>
                    <div class="stat-label">Clientes Fieles (3+ visitas)</div>
                </div>
            </div>

            <!-- Turnos próximos -->
            <div class="dashboard-card">
                <h3 class="card-title">
                    <i class="fas fa-calendar-day"></i> Turnos Próximos (Hoy)
                </h3>
                <div class="turnos-grid" id="proximosTurnosGrid">
                    <div style="text-align: center; padding: 30px; color: #aaa;">
                        <i class="fas fa-spinner loading-spinner"></i>
                        <p>Cargando turnos...</p>
                    </div>
                </div>
            </div>
        </section>

<!-- En la sección de Turnos, eliminar todo el bloque de filtros y dejar solo esto -->
<section id="turnos" class="dashboard-section">
    <h2 class="section-title">Gestión de Turnos</h2>

    <!-- CUADRO DE HORARIOS OCUPADOS/DISPONIBLES -->
    <div class="dashboard-card" style="margin-top: 20px;">
        <h3 class="card-title">
            <i class="fas fa-calendar-day"></i> Horarios Ocupados - <span id="fechaHorariosTexto">Hoy</span>
        </h3>
        
        <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 15px;">
            <div style="flex: 1;">
                <label for="fechaHorarios">Seleccionar fecha:</label>
                <input type="date" id="fechaHorarios" class="form-control" style="width: 200px; margin-top: 5px;">
            </div>
            <div style="display: flex; gap: 10px;">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background-color: rgba(76, 175, 80, 0.3); border: 2px solid var(--success); border-radius: 4px;"></div>
                    <span style="font-size: 0.8rem; color: #aaa;">Ocupado</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background-color: rgba(158, 158, 158, 0.3); border: 2px solid #9e9e9e; border-radius: 4px;"></div>
                    <span style="font-size: 0.8rem; color: #aaa;">Disponible</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background-color: rgba(33, 150, 243, 0.3); border: 2px solid var(--info); border-radius: 4px;"></div>
                    <span style="font-size: 0.8rem; color: #aaa;">Descanso</span>
                </div>
            </div>
        </div>

        <!-- Contenedor del grid de horarios con altura aumentada -->
        <div class="cuadro-horarios" style="max-height: 600px; min-height: 400px;">
            <div class="grid-horarios" id="gridHorarios" style="grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));">
                <div style="text-align: center; padding: 30px; color: #aaa; grid-column: 1 / -1;">
                    <i class="fas fa-spinner loading-spinner"></i>
                    <p>Cargando horarios...</p>
                </div>
            </div>
        </div>
        
        <!-- Información del día seleccionado -->
        <div id="infoDiaSeleccionado" style="margin-top: 15px; padding: 10px; background-color: var(--darker); border-radius: var(--border-radius); display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: bold; color: var(--primary);" id="infoFecha"></div>
                    <div style="color: #aaa; font-size: 0.9rem;" id="infoHorarios"></div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-accion btn-confirmar" onclick="cargarGridHorarios()" style="padding: 5px 10px; font-size: 0.8rem;">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                    <button class="btn-accion btn-asistio" onclick="volverAHoy()" style="padding: 5px 10px; font-size: 0.8rem;">
                        <i class="fas fa-calendar-day"></i> Volver a Hoy
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

        <!-- AGENDA MEJORADA -->
        <section id="agenda" class="dashboard-section">
            <h2 class="section-title">Configuración de Agenda</h2>

            <div class="agenda-grid">
                <!-- Calendario de trabajo -->
                <div class="dashboard-card">
                    <h3 class="card-title">
                        <i class="fas fa-calendar-alt"></i> Calendario de Trabajo
                    </h3>

                    <!-- Controles del calendario -->
                    <div class="calendar-header">
                        <button class="btn-accion btn-confirmar" onclick="AdminApp.cambiarMesAgenda(-1)" style="padding: 8px 15px; font-size: 0.9rem;">
                            <i class="fas fa-chevron-left"></i> Anterior
                        </button>
                        <h3 id="mesActualAgenda" style="color: var(--primary); font-size: 1.2rem;">Enero 2026</h3>
                        <button class="btn-accion btn-confirmar" onclick="AdminApp.cambiarMesAgenda(1)" style="padding: 8px 15px; font-size: 0.9rem;">
                            Siguiente <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>

                    <!-- Días de la semana -->
                    <div class="agenda-calendar">
                        <div class="calendar-day-name">Dom</div>
                        <div class="calendar-day-name">Lun</div>
                        <div class="calendar-day-name">Mar</div>
                        <div class="calendar-day-name">Mié</div>
                        <div class="calendar-day-name">Jue</div>
                        <div class="calendar-day-name">Vie</div>
                        <div class="calendar-day-name">Sáb</div>
                    </div>

                    <!-- Instrucción -->
                    <div style="margin-top: 15px; color: #aaa; font-size: 0.9rem; text-align: center;">
                        <i class="fas fa-hand-point-up"></i> Haz clic en un día para configurar sus horarios
                    </div>
                </div>

                <!-- Configuración del día seleccionado -->
                <div class="dashboard-card" id="cardConfigDia">
                    <h3 class="card-title">
                        <i class="fas fa-cog"></i> Configurar Día: <span id="fechaConfigTitulo">Selecciona un día</span>
                    </h3>

                    <div class="horarios-config">
                        <div class="form-group">
                            <label>Estado del Día</label>
                            <div style="display: flex; gap: 15px; margin-top: 10px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="estadoDia" value="activo" checked>
                                    <span style="color: var(--success);">
                                        <i class="fas fa-check-circle"></i> Habilitar día
                                    </span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="estadoDia" value="inactivo">
                                    <span style="color: var(--error);">
                                        <i class="fas fa-times-circle"></i> Deshabilitar día
                                    </span>
                                    <div class="horario-inputs">
                                </label>
                            </div>
                        </div>

                        <div id="configHorariosContenedor">
                            <div class="form-group">
                                <label>Horario de Trabajo</label>
                                <div class="horario-inputs">
                                    <div>
                                        <label>Hora de inicio</label>
                                        <input type="time" id="horaInicio" class="form-control" value="09:00">
                                    </div>
                                    <div>
                                        <label>Hora de fin</label>
                                        <input type="time" id="horaFin" class="form-control" value="19:00">
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Horarios de Descanso</label>
                                <div id="descansosContainer">
                                    <!-- Se generan dinámicamente -->
                                </div>
                                <button class="btn-accion btn-confirmar" onclick="AdminApp.agregarDescanso()" style="margin-top: 10px;">
                                    <i class="fas fa-plus"></i> Agregar Horario de Descanso
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Aplicar esta configuración a:</label>
                            <div class="opciones-repeticion">
                                <div class="opcion-repeticion active" data-repeticion="unico">
                                    <i class="fas fa-calendar-day"></i>
                                    <div style="margin-top: 5px;">Solo este día</div>
                                </div>
                                <div class="opcion-repeticion" data-repeticion="semanal">
                                    <i class="fas fa-calendar-week"></i>
                                    <div style="margin-top: 5px;">Mismo día todas las semanas</div>
                                </div>
                                <div class="opcion-repeticion" data-repeticion="resto-mes">
                                    <i class="fas fa-calendar-alt"></i>
                                    <div style="margin-top: 5px;">Resto del mes</div>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 25px;">
                            <button class="btn-accion btn-asistio" id="guardarConfigDia" style="flex: 1;">
                                <i class="fas fa-save"></i> Guardar Configuración
                            </button>
                            <button class="btn-accion btn-cancelar" onclick="AdminApp.resetConfigDia()" style="flex: 1;">
                                <i class="fas fa-undo"></i> Restablecer
                            </button>
                        </div>
                    </div>
                </div>
    <!-- HERRAMIENTA DE NOTIFICACIÓN POR CAMBIOS EN AGENDA -->
<div class="dashboard-card" style="margin-top: 20px;">
    <h3 class="card-title">
        <i class="fab fa-whatsapp"></i> Notificar Cambios de Agenda
    </h3>
    
    <div style="color: #aaa; font-size: 0.9rem; margin-bottom: 15px;">
        <i class="fas fa-info-circle"></i> Cuando modifiques horarios, aparecerán aquí los turnos afectados para notificar.
    </div>
    
    <!-- Lista compacta de turnos afectados -->
    <div id="listaTurnosAfectados" style="max-height: 300px; overflow-y: auto; margin-top: 15px;">
        <div style="text-align: center; padding: 20px; color: #aaa;">
            <i class="fas fa-bell-slash fa-2x" style="margin-bottom: 10px;"></i>
            <p>No hay turnos afectados por cambios recientes</p>
        </div>
    </div>
    
    <!-- Botón para probar notificación -->
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button class="btn-notificar" onclick="notificarTodosLosTurnos()" style="flex: 1;">
            <i class="fab fa-whatsapp"></i> Notificar a Todos
        </button>
        <button class="btn-accion btn-confirmar" onclick="verHistorialNotificaciones()" style="flex: 1;">
            <i class="fas fa-history"></i> Ver Historial
        </button>
    </div>
</div>
    
    <!-- Resumen de configuración actual -->
    <div id="resumenHorariosSemanales" style="margin-top: 20px; padding: 15px; background-color: rgba(0,0,0,0.2); border-radius: var(--border-radius);">
        <div style="color: #aaa; font-size: 0.9rem;">
            <i class="fas fa-sync-alt loading-spinner"></i> Cargando configuración actual...
        </div>
    </div>
</div>
            </div>
        </section>



        <!-- Gestión de Servicios -->
        <section id="servicios" class="dashboard-section">
            <h2 class="section-title">Gestión de Servicios</h2>

            <div class="dashboard-grid">
                <!-- Lista de servicios -->
                <div class="dashboard-card">
                    <h3 class="card-title">
                        <i class="fas fa-list-alt"></i> Servicios Actuales
                    </h3>
                    <div id="listaServicios">
                        <div style="text-align: center; padding: 30px; color: #aaa;">
                            <i class="fas fa-spinner loading-spinner"></i>
                            <p>Cargando servicios...</p>
                        </div>
                    </div>
                </div>

                <!-- Formulario para agregar/editar servicio -->
                <div class="dashboard-card">
                    <h3 class="card-title">
                        <i class="fas fa-edit"></i> <span id="formTitle">Agregar Nuevo Servicio</span>
                    </h3>
                    <form id="servicioForm">
                        <input type="hidden" id="servicioId">

                        <div class="form-group">
                            <label for="servicioNombre">Nombre del Servicio *</label>
                            <input type="text" id="servicioNombre" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="servicioDescripcion">Descripción</label>
                            <textarea id="servicioDescripcion" class="form-control" rows="3"
                                placeholder="Ej: Corte tradicional o moderno según tu preferencia"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="servicioPrecio">Precio *</label>
                            <input type="number" id="servicioPrecio" class="form-control" min="0" required>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 25px;">
                            <button type="submit" class="btn-accion btn-asistio" style="flex: 1;">
                                <i class="fas fa-save"></i> <span id="submitText">Guardar Servicio</span>
                            </button>

                            <button type="button" class="btn-accion btn-cancelar" id="cancelarEdicion" style="flex: 1;">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>

                        <!-- Gestión de servicios adicionales -->
<div class="gestion-servicios-adicionales">
    <h4 style="color: var(--primary); margin-bottom: 15px;">
        <i class="fas fa-plus-circle"></i> Servicios Adicionales
    </h4>
    
    <div style="margin-bottom: 15px;">
        <button class="btn-accion btn-confirmar" onclick="abrirModalNuevoServicio()">
            <i class="fas fa-plus"></i> Agregar Nuevo Servicio Adicional
        </button>
    </div>
    
    <div class="grid-servicios-adicionales" id="listaServiciosAdmin">
        <!-- Se llena dinámicamente -->
    </div>
</div>
                    </form>
                </div>
            </div>
        </section>

        <!-- OFERTAS MEJORADAS -->
        <section id="ofertas" class="dashboard-section">
            <h2 class="section-title">Gestión de Ofertas Promocionales</h2>

            <div class="dashboard-grid">
                <!-- Configuración de oferta -->
                <div class="dashboard-card">
                    <h3 class="card-title">
                        <i class="fas fa-cog"></i> Configurar Oferta
                    </h3>

                    <div class="oferta-config">
                        <div class="form-group">
                            <label for="ofertaNombre">Nombre de la Oferta</label>
                            <input type="text" id="ofertaNombre" class="form-control" value="Corte + Afeitado Especial"
                                placeholder="Ej: Combo Premium">
                        </div>

                        <div class="form-group">
                            <label for="ofertaDescripcion">Descripción</label>
                            <textarea id="ofertaDescripcion" class="form-control" rows="2"
                                placeholder="Describe la oferta...">¡Oferta limitada! Corte de cabello + afeitado clásico</textarea>
                        </div>

                        <div class="oferta-precios">
                            <div class="precio-group" style="background-color: var(--dark); padding: 15px; border-radius: var(--border-radius);">
                                <div class="precio-label">Precio Normal</div>
                                <div class="precio-valor">
                                    $<input type="number" id="precioNormal" value="4700" style="width: 100px; background: transparent; border: none; color: var(--primary); font-size: 1.5rem; font-weight: bold;">
                                </div>
                            </div>

                            <div class="precio-group" style="background-color: var(--dark); padding: 15px; border-radius: var(--border-radius);">
                                <div class="precio-label">Precio con Oferta</div>
                                <div class="precio-valor">
                                    $<input type="number" id="precioOferta" value="3900" style="width: 100px; background: transparent; border: none; color: var(--primary); font-size: 1.5rem; font-weight: bold;">
                                </div>
                                <div class="precio-descuento" id="descuentoCalculado">
                                    Ahorro: $800 (17%)
                                </div>
                            </div>
                        </div>

                        <!-- DURACIÓN DE LA OFERTA -->
                        <div class="form-group">
                            <label>Tipo de Duración</label>
                            <div class="opciones-duracion">
                                <div class="opcion-duracion active" data-tipo="horas">
                                    <i class="fas fa-clock"></i>
                                    <div style="font-weight: bold; margin: 5px 0;">Por horas</div>
                                    <div style="color: #aaa; font-size: 0.9rem;">Desde ahora por X horas</div>
                                </div>
                                <div class="opcion-duracion" data-tipo="rango-fecha">
                                    <i class="fas fa-calendar-alt"></i>
                                    <div style="font-weight: bold; margin: 5px 0;">Rango de fecha</div>
                                    <div style="color: #aaa; font-size: 0.9rem;">Fecha específica con horarios</div>
                                </div>
                            </div>
                        </div>

                        <!-- Configuración por horas -->
                        <div id="configHoras" class="form-group">
                            <label>Duración en horas</label>
                            <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                                <input type="number" id="duracionHoras" class="form-control" value="24" min="1" style="width: 100px;">
                                <span>horas</span>
                                <div style="background-color: var(--info); color: white; padding: 5px 10px; border-radius: var(--border-radius);">
                                    <i class="fas fa-clock"></i> <span id="textoDuracion">1 día</span>
                                </div>
                            </div>
                        </div>

                        <!-- Configuración por rango de fecha -->
                        <div id="configRangoFecha" class="form-group" style="display: none;">
                            <label>Rango de fecha y horarios</label>
                            <div style="margin-top: 10px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                    <div>
                                        <label>Fecha de inicio</label>
                                        <input type="date" id="fechaInicioOferta" class="form-control">
                                    </div>
                                    <div>
                                        <label>Fecha de fin</label>
                                        <input type="date" id="fechaFinOferta" class="form-control">
                                    </div>
                                </div>
                                
                                <div class="rango-horario">
                                    <div>
                                        <label>Hora de inicio diario</label>
                                        <input type="time" id="horaInicioOferta" class="form-control" value="09:00">
                                    </div>
                                    <div>
                                        <label>Hora de fin diario</label>
                                        <input type="time" id="horaFinOferta" class="form-control" value="19:00">
                                    </div>
                                </div>
                                
                                <div style="margin-top: 10px; color: #aaa; font-size: 0.9rem;">
                                    <i class="fas fa-info-circle"></i> La oferta solo estará disponible en estos horarios
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Estado de la Oferta</label>
                            <div style="display: flex; gap: 15px; margin-top: 10px;">
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="radio" name="estadoOferta" value="activa" checked>
                                    <span style="background-color: var(--success); color: white; padding: 8px 15px; border-radius: var(--border-radius); display: inline-flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-check-circle"></i> Activa
                                    </span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="radio" name="estadoOferta" value="inactiva">
                                    <span style="background-color: var(--error); color: white; padding: 8px 15px; border-radius: var(--border-radius); display: inline-flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-times-circle"></i> Inactiva
                                    </span>
                                </label>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 25px;">
                            <button class="btn-accion btn-asistio" id="activarOferta" style="flex: 1;">
                                <i class="fas fa-play-circle"></i> Activar Oferta
                            </button>
                            <button class="btn-accion btn-confirmar" id="verVistaPrevia" style="flex: 1;">
                                <i class="fas fa-eye"></i> Ver Vista Previa
                            </button>
                        </div>

<!-- Fidelidad en el apartado ofertas-->
 <div class="dashboard-card programa-fidelidad">
    <h3 class="card-title">
        <i class="fas fa-crown"></i> Programa de Fidelidad
    </h3>
    
    <div class="oferta-config">
        <!-- Estado del programa -->
        <div class="form-group">
            <label>Estado del Programa de Fidelidad</label>
            <div style="display: flex; gap: 15px; margin-top: 10px;">
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="radio" name="estadoFidelidad" value="activo" checked>
                    <span style="background-color: var(--success); color: white; padding: 8px 15px; border-radius: var(--border-radius); display: inline-flex; align-items: center; gap: 8px;">
                        <i class="fas fa-check-circle"></i> Activo
                    </span>
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="radio" name="estadoFidelidad" value="inactivo">
                    <span style="background-color: var(--error); color: white; padding: 8px 15px; border-radius: var(--border-radius); display: inline-flex; align-items: center; gap: 8px;">
                        <i class="fas fa-times-circle"></i> Inactivo
                    </span>
                </label>
            </div>
        </div>
        
        <!-- Configuración de turnos -->
        <div class="form-group">
            <label for="turnosParaGratis">Cantidad de turnos para obtener uno gratis</label>
            <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span>Después de</span>
                    <input type="number" id="turnosParaGratis" class="form-control" value="3" min="1" max="10" style="width: 80px;">
                    <span>turnos confirmados y asistidos</span>
                </div>
                <div style="font-size: 1.5rem; color: var(--primary);">→</div>
                <div style="background-color: rgba(212, 175, 55, 0.2); color: var(--primary); padding: 10px 15px; border-radius: var(--border-radius); font-weight: bold;">
                    El siguiente es GRATIS
                </div>
            </div>
            <div style="color: #aaa; font-size: 0.9rem; margin-top: 5px;">
                <i class="fas fa-info-circle"></i> Ej: 3 turnos asistidos = 4to gratis
            </div>
        </div>
        
        <!-- Instrucciones -->
        <div style="background-color: rgba(33, 150, 243, 0.1); padding: 15px; border-radius: var(--border-radius); margin-top: 20px; border-left: 4px solid var(--info);">
            <div style="color: var(--info); font-weight: bold; margin-bottom: 10px;">
                <i class="fas fa-info-circle"></i> Cómo funciona:
            </div>
            <ol style="color: #aaa; margin-left: 15px; font-size: 0.9rem;">
                <li>El cliente debe tener <strong id="turnosRequeridosEjemplo">3 turnos</strong> con estado "Asistió"</li>
                <li>El sistema cuenta automáticamente los turnos asistidos por teléfono</li>
                <li>Cuando complete la cantidad requerida, el próximo turno se marcará como GRATIS</li>
                <li>Puedes editar manualmente el contador en los detalles del turno</li>
            </ol>
        </div>
        
        <!-- Botones de acción -->
        <div style="display: flex; gap: 10px; margin-top: 25px;">
            <button class="btn-accion btn-asistio" id="guardarConfigFidelidad" style="flex: 1;">
                <i class="fas fa-save"></i> Guardar Configuración
            </button>
            <button class="btn-accion btn-confirmar" onclick="verClientesConFidelidad()" style="flex: 1;">
                <i class="fas fa-users"></i> Ver Clientes en Programa
            </button>
        </div>
    </div>
</div>
                    </div>
                </div>

                <!-- Lista de ofertas vigentes -->
                <div class="dashboard-card">
                    <h3 class="card-title">
                        <i class="fas fa-list"></i> Ofertas Vigentes
                    </h3>

                    <div class="ofertas-lista" id="listaOfertas" style="max-height: 850px; overflow-y: auto;">
                        <div style="text-align: center; padding: 20px; color: #aaa;">
                            <i class="fas fa-spinner loading-spinner"></i>
                            <p>Cargando ofertas...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- SECCIÓN MÉTRICAS MENSUALES -->
        <section id="metricas" class="dashboard-section">
            <h2 class="section-title">Métricas Mensuales</h2>
            
            <!-- Filtros de métricas -->
            <div class="dashboard-card">
                <h3 class="card-title">
                    <i class="fas fa-filter"></i> Filtros de Período
                </h3>
                <div class="filtros-metricas">
                    <div class="filtro-metrica">
                        <label for="filtroMesMetricas">Mes</label>
                        <select id="filtroMesMetricas" class="form-control">
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                    </div>
                    <div class="filtro-metrica">
                        <label for="filtroAnioMetricas">Año</label>
                        <select id="filtroAnioMetricas" class="form-control">
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026" selected>2026</option>
                            <option value="2027">2027</option>
                        </select>
                    </div>
                    <div class="filtro-metrica">
                        <label for="filtroComparar">Comparar con</label>
                        <select id="filtroComparar" class="form-control">
                            <option value="mes_anterior">Mes Anterior</option>
                            <option value="mismo_mes_anio_anterior">Mismo Mes Año Anterior</option>
                            <option value="promedio_anual">Promedio Anual</option>
                            <option value="sin_comparacion">Sin Comparación</option>
                        </select>
                    </div>
                    <button class="btn-accion btn-confirmar" id="aplicarFiltrosMetricas" style="height: 42px; align-self: flex-end;">
                        <i class="fas fa-chart-line"></i> Generar Reporte
                    </button>
                    <button class="btn-accion btn-no-asistio" id="exportarMetricas" style="height: 42px; align-self: flex-end;">
                        <i class="fas fa-file-export"></i> Exportar
                    </button>
                </div>
            </div>
            
            <!-- Resumen de métricas -->
            <div class="dashboard-card">
                <h3 class="card-title">
                    <i class="fas fa-chart-bar"></i> Resumen Mensual - <span id="mesMetricasTexto">Enero 2026</span>
                </h3>
                
                <div class="resumen-metricas" id="resumenMetricas">
                    <div class="metrica-resumen">
                        <i class="fas fa-calendar-check fa-2x"></i>
                        <div class="metrica-valor">0</div>
                        <div class="stat-label">Total Turnos</div>
                        <div class="metrica-tendencia tendencia-neutral">Sin datos previos</div>
                    </div>
                    <div class="metrica-resumen">
                        <i class="fas fa-money-bill-wave fa-2x"></i>
                        <div class="metrica-valor">$0</div>
                        <div class="stat-label">Ingresos Totales</div>
                        <div class="metrica-tendencia tendencia-neutral">Sin datos previos</div>
                    </div>
                    <div class="metrica-resumen">
                        <i class="fas fa-users fa-2x"></i>
                        <div class="metrica-valor">0</div>
                        <div class="stat-label">Clientes Únicos</div>
                        <div class="metrica-tendencia tendencia-neutral">Sin datos previos</div>
                    </div>
                    <div class="metrica-resumen">
                        <i class="fas fa-percentage fa-2x"></i>
                        <div class="metrica-valor">0%</div>
                        <div class="stat-label">Asistencia</div>
                        <div class="metrica-tendencia tendencia-neutral">Sin datos previos</div>
                    </div>
                </div>
            </div>
            
            <!-- Gráficos de métricas -->
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3 class="card-title">
                        <i class="fas fa-chart-line"></i> Ingresos por Día
                    </h3>
                    <div class="grafico-container">
                        <canvas id="graficoIngresos"></canvas>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <h3 class="card-title">
                        <i class="fas fa-chart-pie"></i> Servicios Más Populares
                    </h3>
                    <div class="grafico-container">
                        <canvas id="graficoServicios"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Tabla de turnos del mes -->
            <div class="dashboard-card">
                <h3 class="card-title">
                    <i class="fas fa-table"></i> Turnos del Mes
                </h3>
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="tabla-metricas" id="tablaTurnosMes">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Servicio</th>
                                <th>Precio</th>
                                <th>Estado</th>
                                <th>Fidelidad</th>
                            </tr>
                        </thead>
                        <tbody id="tablaTurnosMesBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 30px; color: #aaa;">
                                    <i class="fas fa-spinner loading-spinner"></i> Cargando datos...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Top clientes y servicios -->
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3 class="card-title">
                        <i class="fas fa-crown"></i> Top 5 Clientes del Mes
                    </h3>
                    <div class="clientes-top" id="topClientes">
                        <div style="text-align: center; padding: 20px; color: #aaa;">
                            <i class="fas fa-spinner loading-spinner"></i>
                            <p>Cargando clientes...</p>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <h3 class="card-title">
                        <i class="fas fa-chart-bar"></i> Métricas de Asistencia
                    </h3>
                    <div class="grafico-container">
                        <canvas id="graficoAsistencia"></canvas>
                    </div>
                    <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="text-align: center; padding: 15px; background-color: var(--dark); border-radius: var(--border-radius);">
                            <div style="color: var(--success); font-size: 1.5rem; font-weight: bold;" id="tasaAsistencia">0%</div>
                            <div style="color: #aaa; font-size: 0.9rem;">Tasa de Asistencia</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background-color: var(--dark); border-radius: var(--border-radius);">
                            <div style="color: var(--error); font-size: 1.5rem; font-weight: bold;" id="tasaCancelacion">0%</div>
                            <div style="color: #aaa; font-size: 0.9rem;">Tasa de Cancelación</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Modal para detalles de turno ocupado -->
    <div class="modal-detalle-turno" id="modalDetalleTurno">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="color: var(--primary);">
                <i class="fas fa-info-circle"></i> Detalles del Turno
            </h3>
<button class="btn-eliminar-descanso" onclick="AdminApp.cerrarModalDetalle()">
            <i class="fas fa-times"></i>
            </button>
        </div>

        <div id="detallesTurnoModal">
            <!-- Se llena dinámicamente -->
        </div>

        <div class="acciones-turno" id="accionesTurnoModal" style="margin-top: 20px;">
            <!-- Botones de acción se generan aquí -->
        </div>
    </div>

    <!-- Overlay para modal -->
    <div class="overlay" id="overlayDetalle"></div>

    <!-- Notificación -->
    <div class="notification" id="notification"></div>

    <!-- Modal de Login para Admin -->
<div id="loginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; justify-content: center; align-items: center;">
    <div style="background: var(--gray); padding: 30px; border-radius: var(--border-radius); max-width: 400px; width: 90%; border: 2px solid var(--primary);">
        <div style="text-align: center; margin-bottom: 25px;">
            <i class="fas fa-lock fa-3x" style="color: var(--primary); margin-bottom: 15px;"></i>
            <h2 style="color: var(--primary);">PANEL ADMINISTRATIVO</h2>
            <p style="color: #aaa;">Acceso restringido</p>
        </div>
        
        <div class="form-group">
            <label for="loginEmail" style="color: var(--primary);">Email</label>
            <input type="email" id="loginEmail" class="form-control" placeholder="admin@asstudio.com" autocomplete="username">
        </div>
        
        <div class="form-group">
            <label for="loginPassword" style="color: var(--primary);">Contraseña</label>
            <input type="password" id="loginPassword" class="form-control" placeholder="••••••••" autocomplete="current-password">
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 25px;">
            <button onclick="login()" class="btn-accion btn-asistio" style="flex: 1;">
                <i class="fas fa-sign-in-alt"></i> Ingresar
            </button>
            <button onclick="window.location.href='index.html'" class="btn-accion btn-no-asistio" style="flex: 1;">
                <i class="fas fa-home"></i> Volver al inicio
            </button>
        </div>
        
        <div style="margin-top: 20px; text-align: center; color: #aaa; font-size: 0.9rem;">
            <i class="fas fa-info-circle"></i> Contacta al administrador para obtener credenciales
        </div>
    </div>
</div>

<!-- Agrega esto en el header, junto al logo -->
<div class="connection-status" id="connectionStatus" 
     style="display: flex; align-items: center; gap: 8px; padding: 5px 12px; background: var(--dark); border-radius: 20px; border: 1px solid var(--success);">
    <div class="status-dot" style="width: 10px; height: 10px; background-color: var(--success); border-radius: 50%; animation: pulse 2s infinite;"></div>
    <span style="color: var(--success); font-size: 0.9rem;">En tiempo real</span>
</div>

<!-- Modal de servicios adicionales -->
<div class="modal-servicios-adicionales" id="modalServiciosAdicionales">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="color: var(--primary);">
            <i class="fas fa-plus-circle"></i> Servicios Adicionales
        </h3>
        <button class="btn-eliminar-descanso" onclick="cerrarModalServiciosAdicionales()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <p style="color: #aaa; margin-bottom: 15px;">
        Selecciona uno o más servicios adicionales. Puedes agregar múltiples veces el mismo servicio.
    </p>
    
    <div class="lista-servicios-adicionales" id="listaServiciosAdicionales">
        <!-- Se llena dinámicamente -->
    </div>
    
    <div class="total-a-pagar">
        <div class="total-linea">
            <span>Servicio principal:</span>
            <span id="precioServicioPrincipal">$0</span>
        </div>
        <div class="total-linea">
            <span>Servicios adicionales:</span>
            <span id="totalServiciosAdicionales">$0</span>
        </div>
        <div class="total-final">
            <span>TOTAL A PAGAR:</span>
            <span id="totalPagar">$0</span>
        </div>
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn-accion btn-confirmar" onclick="aplicarServiciosAdicionales()" style="flex: 1;">
            <i class="fas fa-check"></i> Aplicar Servicios
        </button>
        <button class="btn-accion btn-cancelar" onclick="cerrarModalServiciosAdicionales()" style="flex: 1;">
            <i class="fas fa-times"></i> Cancelar
        </button>
    </div>
</div>

<!-- Modal para agregar nuevo servicio adicional -->
<div class="modal-servicios-adicionales" id="modalNuevoServicioAdicional">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="color: var(--primary);">
            <i class="fas fa-plus"></i> Nuevo Servicio Adicional
        </h3>
        <button class="btn-eliminar-descanso" onclick="cerrarModalNuevoServicio()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <form id="formNuevoServicioAdicional">
        <div class="form-group">
            <label for="nombreServicioAdicional">Nombre del servicio *</label>
            <input type="text" id="nombreServicioAdicional" class="form-control" required>
        </div>
        
        <div class="form-group">
            <label for="precioServicioAdicional">Precio *</label>
            <input type="number" id="precioServicioAdicional" class="form-control" min="0" step="100" required>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 25px;">
            <button type="submit" class="btn-accion btn-confirmar" style="flex: 1;">
                <i class="fas fa-save"></i> Guardar Servicio
            </button>
            <button type="button" class="btn-accion btn-cancelar" onclick="cerrarModalNuevoServicio()" style="flex: 1;">
                <i class="fas fa-times"></i> Cancelar
            </button>
        </div>
    </form>
</div>

<!-- Overlay para modales de servicios -->
<div class="overlay" id="overlayServiciosAdicionales"></div>

<style>
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}
</style>

<!--Modal para configuración de horarios semanales--> 
<div class="modal-horarios-semana" id="modalHorariosSemanales">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="color: var(--primary);">
            <i class="fas fa-calendar-week"></i> Configurar Horarios Semanales
        </h3>
        <button class="btn-eliminar-descanso" onclick="cerrarModalHorariosSemanales()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div style="margin-bottom: 20px; color: #aaa; font-size: 0.9rem;">
        <i class="fas fa-info-circle"></i> Configura los horarios base para cada día de la semana. 
        Luego podrás hacer excepciones en días específicos.
    </div>
    
    <div id="horariosSemanalesContainer">
        <!-- Se llena dinámicamente -->
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 25px;">
        <button class="btn-accion btn-asistio" onclick="guardarHorariosSemanales()" style="flex: 1;">
            <i class="fas fa-save"></i> Guardar Horarios Semanales
        </button>
        <button class="btn-accion btn-cancelar" onclick="cerrarModalHorariosSemanales()" style="flex: 1;">
            <i class="fas fa-times"></i> Cancelar
        </button>
    </div>
</div>

<!-- Modal para notificar cambios a clientes -->
<div class="modal-horarios-semana" id="modalNotificarCambios">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="color: var(--primary);">
            <i class="fab fa-whatsapp"></i> Notificar Cambios a Clientes
        </h3>
        <button class="btn-eliminar-descanso" onclick="cerrarModalNotificarCambios()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div id="resumenCambios">
        <!-- Se llena dinámicamente -->
    </div>
    
    <div style="background-color: var(--dark); padding: 15px; border-radius: var(--border-radius); margin-top: 20px;">
        <div class="form-group">
            <label for="mensajeNotificacion">Mensaje personalizado:</label>
            <textarea id="mensajeNotificacion" class="form-control" rows="4" placeholder="Hola [Nombre], lamentamos informarte que tu turno del [Fecha] a las [Hora] necesita ser reagendado debido a un cambio en nuestros horarios. ¿Podrías seleccionar un nuevo horario?">
Hola [Nombre], lamentamos informarte que tu turno del [Fecha] a las [Hora] necesita ser reagendado debido a un cambio en nuestros horarios. 

Por favor, selecciona un nuevo horario disponible:
🔗 [Link para reagendar]

¡Disculpas por las molestias!
            </textarea>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn-accion btn-confirmar" onclick="enviarNotificacionesWhatsApp()" style="flex: 1;">
                <i class="fab fa-whatsapp"></i> Enviar por WhatsApp
            </button>
            <button class="btn-accion btn-no-asistio" onclick="soloGuardarCambios()" style="flex: 1;">
                <i class="fas fa-save"></i> Solo Guardar Cambios
            </button>
        </div>
    </div>
</div>

<!-- Historial de notificaciones -->
<div class="modal-horarios-semana" id="modalHistorialNotificaciones">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="color: var(--primary);">
            <i class="fas fa-history"></i> Historial de Notificaciones
        </h3>
        <button class="btn-eliminar-descanso" onclick="cerrarModalHistorial()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div id="historialNotificacionesContainer">
        <!-- Se llena dinámicamente -->
    </div>
</div>

<!-- Overlay para los nuevos modales -->
<div class="overlay" id="overlayHorariosSemanales"></div>

</body>
   <script>

// Al inicio del código, después de las variables globales
if (typeof activarOferta !== 'undefined') {
    console.warn('La función activarOferta ya está definida. Verificar duplicados.');
}

    // ========== VARIABLES GLOBALES ==========
let db = null;
let auth = null;
let serviciosData = [];
let turnosData = [];
let clientesFidelidad = {};
let turnoSeleccionado = null;
let mesAgendaActual = new Date().getMonth();
let anioAgendaActual = new Date().getFullYear();
let fechaSeleccionadaAgenda = null;
let configuracionAgenda = {};
let horariosAgenda = {};
let ofertasActivas = [];
let graficoIngresos = null;
let graficoServicios = null;
let graficoAsistencia = null;
let isLoadingData = false;
let serviciosAdicionalesData = [];
let serviciosSeleccionados = {};
let turnoParaServiciosAdicionales = null;
let horariosSemanales = {};
let cambiosPendientes = [];


// Configuración de oferta
let ofertaConfig = {
    activa: false,
    nombre: "Corte + Afeitado Especial",
    descripcion: "¡Oferta limitada! Corte de cabello + afeitado clásico",
    precioNormal: 4700,
    precioOferta: 3900,
    duracionHoras: 24,
    inicio: null,
    fin: null,
    tipoDuracion: "horas",
    fechaInicio: null,
    fechaFin: null,
    horaInicio: "09:00",
    horaFin: "19:00"
}
        // Configuración de Firebase
const firebaseConfig = {
      apiKey: "AIzaSyB3xCos-qTAOs8VIgcZk3ntUnPeI13YqR8",
  authDomain: "as-studio-d02c4.firebaseapp.com",
  projectId: "as-studio-d02c4",
  storageBucket: "as-studio-d02c4.firebasestorage.app",
  messagingSenderId: "1021827477452",
  appId: "1:1021827477452:web:4bd7fa03063720f1cdb769",
};

// ========== INICIALIZACIÓN DE FIREBASE ==========
function initializeFirebase() {
    try {
        // Verificar si Firebase ya está inicializado
        if (!firebase.apps.length) {
            console.log('Inicializando Firebase por primera vez...');
            const app = firebase.initializeApp(firebaseConfig);
            
            // Configurar Firestore
            db = firebase.firestore();
            auth = firebase.auth();
            
            // Configurar settings con manejo de errores
            try {
                db.settings({
                    experimentalForceLongPolling: true,
                    ignoreUndefinedProperties: true
                });
            } catch (settingsError) {
                console.log('Firestore settings ya estaban configurados:', settingsError.message);
            }
            
            console.log('✅ Firebase inicializado correctamente');
            return true;
        } else {
            console.log('Firebase ya estaba inicializado, usando instancia existente');
            db = firebase.firestore();
            auth = firebase.auth();
            return true;
        }
        
    } catch (error) {
        console.error('❌ Error al inicializar Firebase:', error);
        
        // Mostrar error amigable
        if (error.code === 'failed-precondition') {
            showNotification('Firebase ya está inicializado en otra pestaña', 'warning');
        } else {
            showNotification('Error crítico: No se pudo conectar con la base de datos', 'error');
        }
        
        return false;
    }
}

// ========== CARGA INICIAL ==========
document.addEventListener('DOMContentLoaded', function () {
    console.log('Panel de administración cargado');
    
    showLoading();

    // 1. Inicializar Firebase primero
    const firebaseInitialized = initializeFirebase();
    
    if (!firebaseInitialized) {
        hideLoading();
        showNotification('Error al inicializar la base de datos', 'error');
        return;
    }

    // 2. Configurar fechas
    const hoy = new Date();
    const hoyFormatted = formatDate(hoy);
    console.log('Fecha hoy formateada:', hoyFormatted);
    
    const fechaHorarios = document.getElementById('fechaHorarios');
    const filtroFecha = document.getElementById('filtroFecha');
    
    if (fechaHorarios) fechaHorarios.value = hoyFormatted;
    if (filtroFecha) filtroFecha.value = hoyFormatted;
    
    // Configurar fecha de ofertas
    const manana = new Date();
    manana.setDate(manana.getDate() + 1);
    
    const fechaInicioOferta = document.getElementById('fechaInicioOferta');
    const fechaFinOferta = document.getElementById('fechaFinOferta');
    
    if (fechaInicioOferta) fechaInicioOferta.value = hoyFormatted;
    if (fechaFinOferta) fechaFinOferta.value = formatDate(manana);
    
    // Configurar mes actual en métricas
    const mesActual = hoy.getMonth() + 1;
    const filtroMesMetricas = document.getElementById('filtroMesMetricas');
    const filtroAnioMetricas = document.getElementById('filtroAnioMetricas');
    
    if (filtroMesMetricas) filtroMesMetricas.value = mesActual;
    if (filtroAnioMetricas) filtroAnioMetricas.value = hoy.getFullYear();
    
    // 3. Configurar listeners
    setupNavigation();
    setupEventListeners();
    
    // 4. Inicializar funciones de ofertas
    calcularDescuento();
    actualizarTextoDuracion();
    
    // 5. Cargar datos iniciales
    loadInitialData();

    cargarServiciosAdicionales();
    
    // Configurar formulario de nuevo servicio
    const formNuevoServicio = document.getElementById('formNuevoServicioAdicional');
    if (formNuevoServicio) {
        formNuevoServicio.addEventListener('submit', guardarNuevoServicioAdicional);
    }
});

// Función para manejar consultas con timeout y errores
async function safeFirebaseQuery(queryFunc, errorMessage) {
    try {
        // Verificar que db esté inicializado
        if (!db) {
            console.error('Firebase no está inicializado');
            showNotification('Base de datos no disponible. Recarga la página.', 'error');
            return null;
        }
        
        return await queryFunc();
    } catch (error) {
        console.error(`${errorMessage}:`, error);
        
        if (error.code === 'permission-denied') {
            showNotification('Error de permisos. Contacta al administrador.', 'error');
        } else if (error.code === 'failed-precondition') {
            showNotification('La consulta requiere un índice. Contacta al administrador.', 'error');
        } else {
            showNotification(errorMessage, 'error');
        }
        
        return null;
    }
}

// ========== CONFIGURACIÓN DE ESCUCHADORES EN TIEMPO REAL ==========
function setupRealTimeListeners() {
    console.log('🔔 Configurando escuchadores en tiempo real...');

     // Si ya hay listeners activos, no crear nuevos
    if (window.firebaseListenersActive) {
        console.log('⚠️ Listeners ya activos, omitiendo...');
        return;
    }
    
    // Marcar como activos
    window.firebaseListenersActive = true;
    
    // Variable para controlar si ya tenemos listeners activos
    if (window.realTimeListeners) {
        console.log('⚠️ Los listeners ya estaban activos, limpiando...');
        cleanupRealTimeListeners();
    }
    
    window.realTimeListeners = {
        turnos: null,
        servicios: null,
        ofertas: null,
        agenda: null
    };
    
    // 1. LISTENER PARA TURNOS (el más importante)
    setupTurnosListener();
    
    // 2. LISTENER PARA SERVICIOS
    setupServiciosListener();
    
    // 3. LISTENER PARA OFERTAS
    setupOfertasListener();
    
    // 4. LISTENER PARA AGENDA
    setupAgendaListener();
    
    // 5. NOTIFICACIONES DE NUEVOS TURNOS
    setupNuevosTurnosNotifications();
    
    console.log('✅ Todos los escuchadores configurados');
}

// Función para limpiar listeners antiguos
function cleanupRealTimeListeners() {
    if (window.realTimeListeners) {
        Object.values(window.realTimeListeners).forEach(unsubscribe => {
            if (unsubscribe && typeof unsubscribe === 'function') {
                unsubscribe();
            }
        });
        window.realTimeListeners = null;
    }
}

// ========== ESCUCHADOR DE TURNOS EN TIEMPO REAL ==========
function setupTurnosListener() {
    try {
        console.log('🎯 Configurando escuchador de turnos...');
        
        // Obtener fecha actual para filtrar
        const hoy = formatDate(new Date());
        
        // Listener para turnos de HOY
        const unsubscribeTurnosHoy = db.collection('turnos')
            .where('fecha', '>=', hoy)
            .orderBy('fecha')
            .orderBy('hora')
            .onSnapshot(
                // ÉXITO
                (snapshot) => {
                    console.log('🔄 Turnos actualizados en tiempo real. Cambios:', snapshot.docChanges().length);
                    
                    // Procesar cambios
                    snapshot.docChanges().forEach(change => {
                        const turno = { id: change.doc.id, ...change.doc.data() };
                        
                        // Mostrar notificación para NUEVOS turnos
                        if (change.type === 'added') {
                            // Verificar si es un turno nuevo (no durante carga inicial)
                            if (!isInitialLoad) {
                                mostrarNotificacionNuevoTurno(turno);
                            }
                        }
                        
                        // Registrar en consola para debugging
                        console.log(`Turno ${change.type}:`, turno.nombre, turno.fecha, turno.hora);
                    });
                    
                    // Actualizar todas las vistas que muestran turnos
                    actualizarVistasDeTurnos(snapshot);
                    
                    // Marcar que la carga inicial ya pasó
                    setTimeout(() => { isInitialLoad = false; }, 2000);
                },
                // ERROR
                (error) => {
                    console.error('❌ Error en escuchador de turnos:', error);
                    
                    // Reintentar después de 10 segundos si hay error
                    setTimeout(() => {
                        console.log('🔄 Reintentando conectar escuchador de turnos...');
                        setupTurnosListener();
                    }, 10000);
                }
            );
        
        // Guardar referencia para poder limpiarlo después
        window.realTimeListeners.turnos = unsubscribeTurnosHoy;
        
        console.log('✅ Escuchador de turnos activo');
        
    } catch (error) {
        console.error('Error al configurar escuchador de turnos:', error);
    }
}

// ========== ACTUALIZAR VISTAS DE TURNOS ==========
async function actualizarVistasDeTurnos(snapshot) {
    try {
        // 1. Obtener datos actualizados
        const turnosActualizados = snapshot.docs.map(doc => ({ 
            id: doc.id, 
            ...doc.data() 
        }));
        
        // 2. Actualizar variable global
        turnosData = turnosActualizados;
        
        // 3. Obtener fecha actual para filtrar
        const hoy = formatDate(new Date());
        const turnosHoy = turnosActualizados.filter(t => 
    t.fecha === hoy && 
    t.estado !== 'cancelado' && 
    t.estado !== 'no_asistio'
);
        
        // 4. Actualizar DASHBOARD (si está visible)
        if (document.getElementById('dashboard').classList.contains('active')) {
            // Actualizar contador
            document.getElementById('turnosHoy').textContent = turnosHoy.length;
            
            // Actualizar lista de turnos próximos
            renderProximosTurnos(turnosHoy);
            
            // Actualizar turnos para acción
            renderTurnosParaAccion(turnosHoy);
        }
        
        // 5. Actualizar SECCIÓN DE TURNOS (si está visible)
        if (document.getElementById('turnos').classList.contains('active')) {
            await loadTurnos(); // Esto recargará con filtros actuales
            
            // También actualizar el grid de horarios
            const fechaSeleccionada = document.getElementById('fechaHorarios').value || hoy;
            if (fechaSeleccionada === hoy || fechaSeleccionada === document.getElementById('filtroFecha').value) {
                await cargarGridHorarios();
            }
        }
        
        // 6. Actualizar MÉTRICAS (si está visible)
        if (document.getElementById('metricas').classList.contains('active')) {
            await loadMetricas();
        }
        
        // 7. Actualizar estadísticas rápidas
        actualizarEstadisticasRapidas(turnosActualizados);
        
    } catch (error) {
        console.error('Error al actualizar vistas:', error);
    }
}

// ========== NOTIFICACIONES DE NUEVOS TURNOS ==========
function setupNuevosTurnosNotifications() {
    console.log('🔔 Configurando sistema de notificaciones...');
    
    // Sonido para nueva notificación (opcional)
    const notificationSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3');
    
    // Array para evitar notificaciones duplicadas
    window.notifiedTurnos = window.notifiedTurnos || new Set();
}

function mostrarNotificacionNuevoTurno(turno) {
    try {
        // Evitar notificar el mismo turno múltiples veces
        const turnoKey = `${turno.id}_${turno.fecha}_${turno.hora}`;
        if (window.notifiedTurnos.has(turnoKey)) {
            return;
        }
        window.notifiedTurnos.add(turnoKey);
        
        // Limpiar IDs antiguos después de 1 hora
        setTimeout(() => {
            window.notifiedTurnos.delete(turnoKey);
        }, 3600000);
        
        console.log('🔔 Nuevo turno recibido:', turno.nombre, turno.fecha, turno.hora);
        
        // Crear notificación visual
        const notificationId = 'new-turno-' + Date.now();
        const notificationHTML = `
            <div id="${notificationId}" class="notification success" style="
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #4caf50, #2e7d32);
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideInRight 0.5s ease;
                border-left: 5px solid #d4af37;
                max-width: 400px;
                cursor: pointer;
            ">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <i class="fas fa-calendar-plus" style="font-size: 1.2rem;"></i>
                    <strong style="font-size: 1.1rem;">NUEVO TURNO</strong>
                </div>
                <div style="margin-bottom: 5px;">
                    <strong>${turno.nombre}</strong> - ${turno.servicio}
                </div>
                <div style="font-size: 0.9rem; opacity: 0.9;">
                    📅 ${parseDateInput(turno.fecha).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' })}
                    ⏰ ${turno.hora}
                </div>
                <div style="font-size: 0.8rem; margin-top: 8px; color: #e0e0e0;">
                    Click para ver detalles
                </div>
                <button onclick="document.getElementById('${notificationId}').remove()" 
                        style="position: absolute; top: 5px; right: 5px; background: none; border: none; color: white; cursor: pointer; font-size: 1rem;">
                    ×
                </button>
            </div>
        `;
        
        // Agregar al DOM
        const div = document.createElement('div');
        div.innerHTML = notificationHTML;
        document.body.appendChild(div.firstElementChild);
        
        // Hacer clickable para abrir detalles
        const notificationElement = document.getElementById(notificationId);
        notificationElement.addEventListener('click', function() {
            mostrarDetallesTurno(turno.id);
            this.remove();
        });
        
        // Reproducir sonido (opcional)
        try {
            notificationSound.currentTime = 0;
            notificationSound.play().catch(e => console.log('No se pudo reproducir sonido:', e));
        } catch (e) {
            console.log('Sonido no disponible');
        }
        
        // Auto-eliminar después de 10 segundos
        setTimeout(() => {
            const elem = document.getElementById(notificationId);
            if (elem) {
                elem.style.animation = 'slideOutRight 0.5s ease';
                setTimeout(() => elem.remove(), 500);
            }
        }, 10000);
        
        // Lanzar confeti para notificación importante
        if (turno.estado === 'confirmado') {
            setTimeout(() => {
                confetti({
                    particleCount: 30,
                    spread: 60,
                    origin: { y: 0.6, x: 0.95 }
                });
            }, 300);
        }
        
    } catch (error) {
        console.error('Error al mostrar notificación:', error);
    }
}

// Agregar esta animación CSS
const notificationStyle = document.createElement('style');
notificationStyle.textContent = `
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(notificationStyle);

// ========== ESCUCHADOR DE SERVICIOS ==========
function setupServiciosListener() {
    try {
        const unsubscribeServicios = db.collection('servicios')
            .orderBy('nombre')
            .onSnapshot(
                (snapshot) => {
                    console.log('🔄 Servicios actualizados. Cambios:', snapshot.docChanges().length);
                    
                    serviciosData = snapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data() 
                    }));
                    
                    // Solo actualizar si estamos en la sección de servicios
                    if (document.getElementById('servicios').classList.contains('active')) {
                        renderServicios();
                    }
                },
                (error) => {
                    console.error('Error en escuchador de servicios:', error);
                }
            );
        
        window.realTimeListeners.servicios = unsubscribeServicios;
        
    } catch (error) {
        console.error('Error al configurar escuchador de servicios:', error);
    }
}

// ========== ESCUCHADOR DE OFERTAS ==========
function setupOfertasListener() {
    try {
        const unsubscribeOfertas = db.collection('ofertas')
            .orderBy('creado_en', 'desc')
            .onSnapshot(
                (snapshot) => {
                    console.log('🔄 Ofertas actualizadas. Cambios:', snapshot.docChanges().length);
                    
                    ofertasActivas = snapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data() 
                    }));
                    
                    // Solo actualizar si estamos en la sección de ofertas
                    if (document.getElementById('ofertas').classList.contains('active')) {
                        renderOfertas();
                    }
                },
                (error) => {
                    console.error('Error en escuchador de ofertas:', error);
                }
            );
        
        window.realTimeListeners.ofertas = unsubscribeOfertas;
        
    } catch (error) {
        console.error('Error al configurar escuchador de ofertas:', error);
    }
}

// ========== ESCUCHADOR DE AGENDA ==========
function setupAgendaListener() {
    try {
        const unsubscribeAgenda = db.collection('horarios_agenda')
            .onSnapshot(
                (snapshot) => {
                    console.log('🔄 Agenda actualizada. Cambios:', snapshot.docChanges().length);
                    
                    // Actualizar cache local
                    horariosAgenda = {};
                    snapshot.docs.forEach(doc => {
                        const data = { id: doc.id, ...doc.data() };
                        horariosAgenda[data.fecha] = data;
                    });
                    
                    // Actualizar calendario si estamos en la sección de agenda
                    if (document.getElementById('agenda').classList.contains('active')) {
                        generarCalendarioAgenda();
                    }
                    
                    // Actualizar grid de horarios si estamos en la sección de turnos
                    if (document.getElementById('turnos').classList.contains('active')) {
                        cargarGridHorarios();
                    }
                },
                (error) => {
                    console.error('Error en escuchador de agenda:', error);
                }
            );
        
        window.realTimeListeners.agenda = unsubscribeAgenda;
        
    } catch (error) {
        console.error('Error al configurar escuchador de agenda:', error);
    }
}

// ========== VARIABLES GLOBALES PARA FIDELIDAD ==========
let configFidelidad = {
    activa: true,
    turnosParaGratis: 3,
    turnosConfirmadosRequeridos: true,
    turnosAsistidosRequeridos: true
};

// ========== FUNCIONES PARA EL PROGRAMA DE FIDELIDAD ==========

// Cargar configuración de fidelidad
async function cargarConfigFidelidad() {
    try {
        const doc = await db.collection('configuracion').doc('programa_fidelidad').get();
        
        if (doc.exists) {
            configFidelidad = { ...configFidelidad, ...doc.data() };
        }
        
        // Actualizar UI
        actualizarUIConfigFidelidad();
        
    } catch (error) {
        console.error('Error al cargar configuración de fidelidad:', error);
        // Crear configuración por defecto
        await guardarConfigFidelidad();
    }
}

// Actualizar UI de configuración
function actualizarUIConfigFidelidad() {
    // Estado
    const estadoActivo = document.querySelector(`input[name="estadoFidelidad"][value="activo"]`);
    const estadoInactivo = document.querySelector(`input[name="estadoFidelidad"][value="inactivo"]`);
    
    if (estadoActivo) estadoActivo.checked = configFidelidad.activa;
    if (estadoInactivo) estadoInactivo.checked = !configFidelidad.activa;
    
    // Cantidad de turnos
    const turnosInput = document.getElementById('turnosParaGratis');
    if (turnosInput) {
        turnosInput.value = configFidelidad.turnosParaGratis;
        // Actualizar ejemplo
        const ejemplo = document.getElementById('turnosRequeridosEjemplo');
        if (ejemplo) {
            ejemplo.textContent = `${configFidelidad.turnosParaGratis} turnos`;
        }
    }
}

// Guardar configuración de fidelidad
async function guardarConfigFidelidad() {
    try {
        showLoading();
        
        // Obtener valores del formulario
        const activa = document.querySelector('input[name="estadoFidelidad"][value="activo"]').checked;
        const turnosParaGratis = parseInt(document.getElementById('turnosParaGratis').value) || 3;
        
        configFidelidad = {
            activa,
            turnosParaGratis,
            turnosConfirmadosRequeridos: true,
            turnosAsistidosRequeridos: true,
            actualizado_en: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Guardar en Firebase
        await db.collection('configuracion').doc('programa_fidelidad').set(configFidelidad);
        
        showNotification('Configuración de fidelidad guardada', 'success');
        hideLoading();
        
    } catch (error) {
        console.error('Error al guardar configuración de fidelidad:', error);
        showNotification('Error al guardar configuración', 'error');
        hideLoading();
    }
}

// Función mejorada para verificar y actualizar fidelidad
async function verificarYActualizarFidelidad(turnoId, telefonoCliente) {
    try {
        console.log('Verificando fidelidad para:', telefonoCliente);
        
        if (!telefonoCliente || !configFidelidad.activa) {
            return { 
                totalAsistidos: 0, 
                faltanParaGratis: configFidelidad.turnosParaGratis,
                esProximoGratis: false, 
                esTurnoGratis: false 
            };
        }
        
        // Limpiar teléfono
        const telefonoLimpio = telefonoCliente.replace(/\D/g, '');
        
        // Buscar TODOS los turnos del cliente
        const querySnapshot = await db.collection('turnos')
            .where('telefono', '>=', telefonoLimpio)
            .where('telefono', '<=', telefonoLimpio + '\uf8ff')
            .get();
        
        // Filtrar turnos según configuración
        let turnosValidos = [];
        querySnapshot.docs.forEach(doc => {
            const turno = doc.data();
            
            // Verificar condiciones según configuración
            let esValido = true;
            
            if (configFidelidad.turnosAsistidosRequeridos && turno.estado !== 'asistio') {
                esValido = false;
            }
            
            if (configFidelidad.turnosConfirmadosRequeridos && 
                !['confirmado', 'asistio'].includes(turno.estado)) {
                esValido = false;
            }
            
            if (esValido) {
                turnosValidos.push(turno);
            }
        });
        
        const totalValidos = turnosValidos.length;
        
        // Calcular según la configuración
        const turnosEnCiclo = totalValidos % configFidelidad.turnosParaGratis;
        const faltanParaGratis = turnosEnCiclo === 0 ? 
            configFidelidad.turnosParaGratis : 
            configFidelidad.turnosParaGratis - turnosEnCiclo;
        
        const esProximoGratis = faltanParaGratis === 1;
        const esTurnoGratis = turnosEnCiclo === 0 && totalValidos > 0;
        
        console.log(`Fidelidad - Válidos: ${totalValidos}, Faltan: ${faltanParaGratis}, Próximo gratis: ${esProximoGratis}, Turno gratis: ${esTurnoGratis}`);
        
        return {
            totalAsistidos: totalValidos,
            faltanParaGratis,
            esProximoGratis,
            esTurnoGratis,
            configuracion: configFidelidad
        };
        
    } catch (error) {
        console.error('Error en verificarYActualizarFidelidad:', error);
        return { 
            totalAsistidos: 0, 
            faltanParaGratis: configFidelidad.turnosParaGratis,
            esProximoGratis: false, 
            esTurnoGratis: false 
        };
    }
}

// MODIFICAR la función generarContadorFidelidad para usar la configuración:
async function generarContadorFidelidad(turno) {
    try {
        const telefono = turno.telefono;
        if (!telefono || !configFidelidad.activa) return '';
        
        const fidelidad = await verificarYActualizarFidelidad(turno.id, telefono);
        
        let html = '';
        const turnosNecesarios = configFidelidad.turnosParaGratis;
        
        if (fidelidad.esProximoGratis) {
            html = `
                <div class="contador-fidelidad contador-proximo-gratis" style="margin-top: 15px;">
                    <div class="contador-titulo">
                        <i class="fas fa-gift"></i> ¡FELICIDADES!
                    </div>
                    <div class="contador-numero">${fidelidad.totalAsistidos + 1}/${turnosNecesarios}</div>
                    <div class="contador-subtitulo" style="color: #ffeb3b; font-weight: bold;">
                        ¡PRÓXIMO TURNO GRATIS!
                    </div>
                    <div style="font-size: 0.8rem; color: #d8b4fe; margin-top: 5px;">
                        ${turno.nombre} ha completado ${fidelidad.totalAsistidos} turnos válidos
                    </div>
                    <!-- Botón para editar manualmente -->
                    <button class="btn-accion btn-confirmar" onclick="editarContadorFidelidadManual('${turno.id}', '${turno.nombre}', '${telefono}')" style="margin-top: 10px; width: 100%; padding: 8px; font-size: 0.8rem;">
                        <i class="fas fa-edit"></i> Editar Contador Manualmente
                    </button>
                </div>
            `;
        } else if (fidelidad.esTurnoGratis) {
            html = `
                <div class="contador-fidelidad" style="background: rgba(0, 255, 0, 0.15); border: 2px solid #00ff00; margin-top: 15px;">
                    <div class="contador-titulo" style="color: #00ff00;">
                        <i class="fas fa-crown"></i> TURNO GRATIS
                    </div>
                    <div class="contador-numero" style="color: #00ff00; text-shadow: 0 0 10px #00ff00;">
                        ${turnosNecesarios}/${turnosNecesarios}
                    </div>
                    <div class="contador-subtitulo" style="color: #00ff00;">
                        ¡Este turno es GRATIS!
                    </div>
                    <button class="btn-accion btn-confirmar" onclick="editarContadorFidelidadManual('${turno.id}', '${turno.nombre}', '${telefono}')" style="margin-top: 10px; width: 100%; padding: 8px; font-size: 0.8rem;">
                        <i class="fas fa-edit"></i> Editar Contador Manualmente
                    </button>
                </div>
            `;
        } else if (fidelidad.totalAsistidos > 0) {
            html = `
                <div class="contador-fidelidad" style="margin-top: 15px;">
                    <div class="contador-titulo">
                        <i class="fas fa-crown"></i> PROGRAMA DE FIDELIDAD
                    </div>
                    <div class="contador-numero">${fidelidad.totalAsistidos % turnosNecesarios || turnosNecesarios}/${turnosNecesarios}</div>
                    <div class="contador-subtitulo">
                        Faltan ${fidelidad.faltanParaGratis} turno${fidelidad.faltanParaGratis !== 1 ? 's' : ''} para el próximo gratis
                    </div>
                    <div style="font-size: 0.8rem; color: #d8b4fe; margin-top: 5px;">
                        ${turno.nombre} tiene ${fidelidad.totalAsistidos} turno${fidelidad.totalAsistidos !== 1 ? 's' : ''} válido${fidelidad.totalAsistidos !== 1 ? 's' : ''}
                    </div>
                    <button class="btn-accion btn-confirmar" onclick="editarContadorFidelidadManual('${turno.id}', '${turno.nombre}', '${telefono}')" style="margin-top: 10px; width: 100%; padding: 8px; font-size: 0.8rem;">
                        <i class="fas fa-edit"></i> Editar Contador Manualmente
                    </button>
                </div>
            `;
        } else {
            html = `
                <div class="contador-fidelidad" style="margin-top: 15px; background: rgba(158, 158, 158, 0.15); border: 2px solid #9e9e9e;">
                    <div class="contador-titulo" style="color: #9e9e9e;">
                        <i class="fas fa-crown"></i> PROGRAMA DE FIDELIDAD
                    </div>
                    <div class="contador-numero" style="color: #9e9e9e;">0/${turnosNecesarios}</div>
                    <div class="contador-subtitulo" style="color: #9e9e9e;">
                        Primer turno - ¡Comienza a acumular!
                    </div>
                    <div style="font-size: 0.8rem; color: #aaa; margin-top: 5px;">
                        Cada ${turnosNecesarios - 1} turnos asistidos, el ${turnosNecesarios}º es GRATIS
                    </div>
                    <button class="btn-accion btn-confirmar" onclick="editarContadorFidelidadManual('${turno.id}', '${turno.nombre}', '${telefono}')" style="margin-top: 10px; width: 100%; padding: 8px; font-size: 0.8rem;">
                        <i class="fas fa-edit"></i> Editar Contador Manualmente
                    </button>
                </div>
            `;
        }
        
        return html;
        
    } catch (error) {
        console.error('Error al generar contador:', error);
        return '';
    }
}

// Función para editar manualmente el contador de fidelidad
async function editarContadorFidelidadManual(turnoId, nombreCliente, telefonoCliente) {
    try {
        showLoading();
        
        // Obtener información actual de fidelidad
        const fidelidadActual = await verificarYActualizarFidelidad(turnoId, telefonoCliente);
        
        // Crear modal de edición
        const modalHTML = `
            <div class="modal-editar-fidelidad active" id="modalEditarFidelidad">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: var(--primary);">
                        <i class="fas fa-edit"></i> Editar Contador de Fidelidad
                    </h3>
                    <button class="btn-eliminar-descanso" onclick="cerrarModalEditarFidelidad()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: bold; color: var(--light);">Cliente: ${nombreCliente}</div>
                    <div style="color: #aaa; font-size: 0.9rem;">Teléfono: ${telefonoCliente}</div>
                </div>
                
                <div class="contador-manual">
                    <div style="color: var(--primary); font-weight: bold; margin-bottom: 10px;">
                        Turnos asistidos actuales: <span id="valorActualContador">${fidelidadActual.totalAsistidos}</span>
                    </div>
                    
                    <div style="color: #aaa; font-size: 0.9rem; margin-bottom: 15px;">
                        Configuración actual: ${configFidelidad.turnosParaGratis - 1} turnos → ${configFidelidad.turnosParaGratis}º gratis
                    </div>
                    
                    <div class="controles-contador">
                        <button class="btn-contador-manual" onclick="cambiarContadorFidelidad(-1)">-</button>
                        <div class="valor-contador" id="nuevoContadorValor">${fidelidadActual.totalAsistidos}</div>
                        <button class="btn-contador-manual" onclick="cambiarContadorFidelidad(1)">+</button>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <input type="number" id="inputContadorExacto" class="form-control" value="${fidelidadActual.totalAsistidos}" style="flex: 1;" min="0" max="100">
                        <button class="btn-accion btn-confirmar" onclick="aplicarContadorExacto()" style="padding: 8px 15px;">
                            <i class="fas fa-check"></i> Aplicar
                        </button>
                    </div>
                    
                    <div style="margin-top: 15px; color: #aaa; font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i> 
                        Al guardar, se actualizarán todos los turnos de este teléfono
                    </div>
                </div>
                
                <!-- Estado del próximo turno -->
                <div id="estadoProximoTurno" style="margin-top: 15px; padding: 10px; border-radius: var(--border-radius); background-color: ${fidelidadActual.esProximoGratis ? 'rgba(255, 235, 59, 0.1)' : 'rgba(158, 158, 158, 0.1)'}; border: 1px solid ${fidelidadActual.esProximoGratis ? '#ffeb3b' : '#9e9e9e'};">
                    <div style="color: ${fidelidadActual.esProximoGratis ? '#ffeb3b' : '#aaa'}; font-weight: bold;">
                        <i class="fas ${fidelidadActual.esProximoGratis ? 'fa-gift' : 'fa-clock'}"></i>
                        ${fidelidadActual.esProximoGratis ? '¡PRÓXIMO TURNO GRATIS!' : 'Aún no es próximo turno gratis'}
                    </div>
                    <div style="color: #aaa; font-size: 0.8rem; margin-top: 5px;">
                        Con ${fidelidadActual.totalAsistidos} turnos, faltan ${fidelidadActual.faltanParaGratis} para el gratis
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-accion btn-asistio" onclick="guardarContadorFidelidadManual('${turnoId}', '${telefonoCliente}')" style="flex: 1;">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                    <button class="btn-accion btn-cancelar" onclick="cerrarModalEditarFidelidad()" style="flex: 1;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </div>
        `;
        
        // Agregar modal al DOM
        const div = document.createElement('div');
        div.innerHTML = modalHTML;
        document.body.appendChild(div);
        
        // Agregar overlay
        const overlay = document.createElement('div');
        overlay.className = 'overlay active';
        overlay.id = 'overlayEditarFidelidad';
        overlay.onclick = cerrarModalEditarFidelidad;
        document.body.appendChild(overlay);
        
        hideLoading();
        
    } catch (error) {
        console.error('Error al abrir modal de edición:', error);
        showNotification('Error al abrir editor de fidelidad', 'error');
        hideLoading();
    }
}

// Variables para el contador en edición
let contadorEditando = 0;
let telefonoEditando = '';

// Función para cambiar el contador
function cambiarContadorFidelidad(delta) {
    const valorElement = document.getElementById('nuevoContadorValor');
    const inputElement = document.getElementById('inputContadorExacto');
    
    if (valorElement && inputElement) {
        let nuevoValor = parseInt(valorElement.textContent) + delta;
        if (nuevoValor < 0) nuevoValor = 0;
        if (nuevoValor > 100) nuevoValor = 100;
        
        valorElement.textContent = nuevoValor;
        inputElement.value = nuevoValor;
        
        // Actualizar estado del próximo turno
        actualizarEstadoProximoTurno(nuevoValor);
    }
}

// Función para aplicar valor exacto
function aplicarContadorExacto() {
    const inputElement = document.getElementById('inputContadorExacto');
    const valorElement = document.getElementById('nuevoContadorValor');
    
    if (inputElement && valorElement) {
        let valor = parseInt(inputElement.value) || 0;
        if (valor < 0) valor = 0;
        if (valor > 100) valor = 100;
        
        valorElement.textContent = valor;
        
        // Actualizar estado del próximo turno
        actualizarEstadoProximoTurno(valor);
    }
}

// Función para actualizar estado del próximo turno
function actualizarEstadoProximoTurno(totalTurnos) {
    const estadoElement = document.getElementById('estadoProximoTurno');
    if (!estadoElement) return;
    
    const turnosEnCiclo = totalTurnos % configFidelidad.turnosParaGratis;
    const faltanParaGratis = turnosEnCiclo === 0 ? 
        configFidelidad.turnosParaGratis : 
        configFidelidad.turnosParaGratis - turnosEnCiclo;
    
    const esProximoGratis = faltanParaGratis === 1;
    const esTurnoGratis = turnosEnCiclo === 0 && totalTurnos > 0;
    
    if (esTurnoGratis) {
        estadoElement.innerHTML = `
            <div style="color: #00ff00; font-weight: bold;">
                <i class="fas fa-crown"></i> ¡TURNO GRATIS ACTUAL!
            </div>
            <div style="color: #aaa; font-size: 0.8rem; margin-top: 5px;">
                Con ${totalTurnos} turnos, este turno debería ser GRATIS
            </div>
        `;
        estadoElement.style.backgroundColor = 'rgba(0, 255, 0, 0.1)';
        estadoElement.style.borderColor = '#00ff00';
    } else if (esProximoGratis) {
        estadoElement.innerHTML = `
            <div style="color: #ffeb3b; font-weight: bold;">
                <i class="fas fa-gift"></i> ¡PRÓXIMO TURNO GRATIS!
            </div>
            <div style="color: #aaa; font-size: 0.8rem; margin-top: 5px;">
                Con ${totalTurnos} turnos, el próximo será GRATIS
            </div>
        `;
        estadoElement.style.backgroundColor = 'rgba(255, 235, 59, 0.1)';
        estadoElement.style.borderColor = '#ffeb3b';
    } else {
        estadoElement.innerHTML = `
            <div style="color: #aaa; font-weight: bold;">
                <i class="fas fa-clock"></i> Aún no es próximo turno gratis
            </div>
            <div style="color: #aaa; font-size: 0.8rem; margin-top: 5px;">
                Con ${totalTurnos} turnos, faltan ${faltanParaGratis} para el gratis
            </div>
        `;
        estadoElement.style.backgroundColor = 'rgba(158, 158, 158, 0.1)';
        estadoElement.style.borderColor = '#9e9e9e';
    }
}

// Función para guardar cambios manuales
async function guardarContadorFidelidadManual(turnoId, telefonoCliente) {
    try {
        showLoading();
        
        const valorElement = document.getElementById('nuevoContadorValor');
        const nuevoContador = parseInt(valorElement.textContent) || 0;
        
        // Limpiar teléfono
        const telefonoLimpio = telefonoCliente.replace(/\D/g, '');
        
        // Buscar todos los turnos del cliente
        const querySnapshot = await db.collection('turnos')
            .where('telefono', '>=', telefonoLimpio)
            .where('telefono', '<=', telefonoLimpio + '\uf8ff')
            .get();
        
        if (querySnapshot.empty) {
            showNotification('No se encontraron turnos para este cliente', 'error');
            hideLoading();
            return;
        }
        
        // Obtener turnos ordenados por fecha
        const turnosCliente = querySnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        })).sort((a, b) => new Date(a.fecha + 'T' + a.hora) - new Date(b.fecha + 'T' + b.hora));
        
        // Aquí podrías implementar lógica para marcar manualmente qué turnos contar
        // Por ahora, solo registramos el cambio en la configuración
        await db.collection('configuracion').doc(`fidelidad_manual_${telefonoLimpio}`).set({
            telefono: telefonoCliente,
            contador_manual: nuevoContador,
            actualizado_en: firebase.firestore.FieldValue.serverTimestamp(),
            actualizado_por: 'admin'
        });
        
        showNotification(`Contador actualizado a ${nuevoContador} turnos`, 'success');
        
        // Cerrar modal
        cerrarModalEditarFidelidad();
        
        // Actualizar vista del turno si está abierto
        if (document.getElementById('modalDetalleTurno').classList.contains('active')) {
            await mostrarDetallesTurno(turnoId);
        }
        
        hideLoading();
        
    } catch (error) {
        console.error('Error al guardar contador manual:', error);
        showNotification('Error al guardar cambios', 'error');
        hideLoading();
    }
}

// Función para cerrar modal de edición
function cerrarModalEditarFidelidad() {
    const modal = document.getElementById('modalEditarFidelidad');
    const overlay = document.getElementById('overlayEditarFidelidad');
    
    if (modal) modal.remove();
    if (overlay) overlay.remove();
}

// Función para ver clientes en el programa de fidelidad
async function verClientesConFidelidad() {
    try {
        showLoading();
        
        // Buscar todos los turnos
        const querySnapshot = await db.collection('turnos').get();
        
        const clientesMap = new Map();
        
        // Procesar todos los turnos
        querySnapshot.docs.forEach(doc => {
            const turno = doc.data();
            if (!turno.telefono) return;
            
            const telefonoLimpio = turno.telefono.replace(/\D/g, '');
            const clave = `${telefonoLimpio}_${turno.nombre}`;
            
            if (!clientesMap.has(clave)) {
                clientesMap.set(clave, {
                    nombre: turno.nombre,
                    telefono: turno.telefono,
                    turnos: [],
                    totalAsistidos: 0
                });
            }
            
            const cliente = clientesMap.get(clave);
            cliente.turnos.push(turno);
            
            // Contar solo turnos asistidos
            if (turno.estado === 'asistio') {
                cliente.totalAsistidos++;
            }
        });
        
        // Crear modal con la lista
        const clientesArray = Array.from(clientesMap.values())
            .filter(cliente => cliente.totalAsistidos > 0) // Solo clientes con turnos asistidos
            .sort((a, b) => b.totalAsistidos - a.totalAsistidos);
        
        const modalHTML = `
            <div class="modal-editar-fidelidad active" id="modalClientesFidelidad" style="max-width: 600px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: var(--primary);">
                        <i class="fas fa-users"></i> Clientes en Programa de Fidelidad
                    </h3>
                    <button class="btn-eliminar-descanso" onclick="cerrarModalClientesFidelidad()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div style="color: #aaa; margin-bottom: 15px; font-size: 0.9rem;">
                    <i class="fas fa-info-circle"></i> 
                    Mostrando ${clientesArray.length} clientes con turnos asistidos. 
                    Configuración actual: ${configFidelidad.turnosParaGratis - 1} turnos → ${configFidelidad.turnosParaGratis}º gratis
                </div>
                
                <div class="lista-clientes-fidelidad">
                    ${clientesArray.length > 0 ? clientesArray.map(cliente => {
                        const fidelidadInfo = {
                            totalAsistidos: cliente.totalAsistidos,
                            faltanParaGratis: cliente.totalAsistidos % configFidelidad.turnosParaGratis === 0 ? 
                                configFidelidad.turnosParaGratis : 
                                configFidelidad.turnosParaGratis - (cliente.totalAsistidos % configFidelidad.turnosParaGratis),
                            esProximoGratis: (cliente.totalAsistidos % configFidelidad.turnosParaGratis) === (configFidelidad.turnosParaGratis - 1)
                        };
                        
                        return `
                            <div class="cliente-fidelidad-item">
                                <div>
                                    <div style="font-weight: bold; color: var(--light);">${cliente.nombre}</div>
                                    <div style="color: #aaa; font-size: 0.8rem;">${cliente.telefono}</div>
                                    <div style="color: var(--primary); font-size: 0.9rem; margin-top: 5px;">
                                        <i class="fas fa-calendar-check"></i> ${cliente.totalAsistidos} turnos asistidos
                                    </div>
                                </div>
                                <div class="contador-cliente">
                                    <div style="text-align: right;">
                                        <div style="color: ${fidelidadInfo.esProximoGratis ? '#ffeb3b' : '#aaa'}; font-weight: bold;">
                                            ${fidelidadInfo.totalAsistidos}/${configFidelidad.turnosParaGratis}
                                        </div>
                                        <div style="color: #aaa; font-size: 0.8rem;">
                                            Faltan ${fidelidadInfo.faltanParaGratis}
                                        </div>
                                    </div>
                                    ${fidelidadInfo.esProximoGratis ? 
                                        '<div class="badge-proximo-gratis">¡PRÓXIMO GRATIS!</div>' : 
                                        '<button class="btn-accion btn-confirmar" onclick="editarContadorFidelidadManual(\'\', \'' + cliente.nombre + '\', \'' + cliente.telefono + '\')" style="padding: 5px 10px; font-size: 0.8rem;">Editar</button>'
                                    }
                                </div>
                            </div>
                        `;
                    }).join('') : `
                        <div style="text-align: center; padding: 30px; color: #aaa;">
                            <i class="fas fa-users-slash fa-3x" style="margin-bottom: 15px;"></i>
                            <p>No hay clientes con turnos asistidos</p>
                        </div>
                    `}
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn-accion btn-confirmar" onclick="exportarReporteFidelidad()" style="flex: 1;">
                        <i class="fas fa-file-export"></i> Exportar Reporte
                    </button>
                    <button class="btn-accion btn-cancelar" onclick="cerrarModalClientesFidelidad()" style="flex: 1;">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
            </div>
        `;
        
        // Agregar modal al DOM
        const div = document.createElement('div');
        div.innerHTML = modalHTML;
        document.body.appendChild(div);
        
        // Agregar overlay
        const overlay = document.createElement('div');
        overlay.className = 'overlay active';
        overlay.id = 'overlayClientesFidelidad';
        overlay.onclick = cerrarModalClientesFidelidad;
        document.body.appendChild(overlay);
        
        hideLoading();
        
    } catch (error) {
        console.error('Error al cargar clientes de fidelidad:', error);
        showNotification('Error al cargar lista de clientes', 'error');
        hideLoading();
    }
}

// Función para cerrar modal de clientes
function cerrarModalClientesFidelidad() {
    const modal = document.getElementById('modalClientesFidelidad');
    const overlay = document.getElementById('overlayClientesFidelidad');
    
    if (modal) modal.remove();
    if (overlay) overlay.remove();
}

// Función para exportar reporte
async function exportarReporteFidelidad() {
    try {
        showLoading();
        
        // Buscar todos los turnos
        const querySnapshot = await db.collection('turnos').get();
        
        const clientesMap = new Map();
        
        querySnapshot.docs.forEach(doc => {
            const turno = doc.data();
            if (!turno.telefono) return;
            
            const telefonoLimpio = turno.telefono.replace(/\D/g, '');
            const clave = `${telefonoLimpio}_${turno.nombre}`;
            
            if (!clientesMap.has(clave)) {
                clientesMap.set(clave, {
                    nombre: turno.nombre,
                    telefono: turno.telefono,
                    totalAsistidos: 0,
                    totalTurnos: 0,
                    primerTurno: null,
                    ultimoTurno: null
                });
            }
            
            const cliente = clientesMap.get(clave);
            cliente.totalTurnos++;
            
            if (turno.estado === 'asistio') {
                cliente.totalAsistidos++;
            }
            
            const fechaTurno = new Date(turno.fecha + 'T' + turno.hora);
            
            if (!cliente.primerTurno || fechaTurno < cliente.primerTurno) {
                cliente.primerTurno = fechaTurno;
            }
            
            if (!cliente.ultimoTurno || fechaTurno > cliente.ultimoTurno) {
                cliente.ultimoTurno = fechaTurno;
            }
        });
        
        const clientesArray = Array.from(clientesMap.values())
            .filter(cliente => cliente.totalAsistidos > 0)
            .sort((a, b) => b.totalAsistidos - a.totalAsistidos);
        
        // Crear CSV
        let csv = 'Cliente,Teléfono,Turnos Asistidos,Total Turnos,Primer Turno,Último Turno,Faltan para Gratis,Estado\n';
        
        clientesArray.forEach(cliente => {
            const faltanParaGratis = cliente.totalAsistidos % configFidelidad.turnosParaGratis === 0 ? 
                configFidelidad.turnosParaGratis : 
                configFidelidad.turnosParaGratis - (cliente.totalAsistidos % configFidelidad.turnosParaGratis);
            
            const esProximoGratis = faltanParaGratis === 1;
            
            csv += `"${cliente.nombre}","${cliente.telefono}",${cliente.totalAsistidos},${cliente.totalTurnos},"${cliente.primerTurno ? cliente.primerTurno.toLocaleDateString() : ''}","${cliente.ultimoTurno ? cliente.ultimoTurno.toLocaleDateString() : ''}",${faltanParaGratis},"${esProximoGratis ? 'PRÓXIMO GRATIS' : 'EN PROGRESO'}"\n`;
        });
        
        // Crear y descargar archivo
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `reporte_fidelidad_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Reporte exportado correctamente', 'success');
        hideLoading();
        
    } catch (error) {
        console.error('Error al exportar reporte:', error);
        showNotification('Error al exportar reporte', 'error');
        hideLoading();
    }
}

// ========== LOGOUT MEJORADO ==========
async function logout() {
    try {
        if (!confirm('¿Estás seguro de cerrar sesión?')) {
            return;
        }
        
        showLoading();
        
        console.log('Iniciando logout...');
        
        // 1. LIMPIAR ESCUCHADORES EN TIEMPO REAL
        cleanupRealTimeListeners();
        
        // 2. Limpiar localStorage
        localStorage.removeItem('admin_logged_in');
        localStorage.removeItem('admin_email');
        localStorage.removeItem('admin_uid');
        localStorage.removeItem('login_timestamp');
        
        // 3. Intentar cerrar sesión de Firebase
        try {
            if (auth.currentUser) {
                await auth.signOut();
            }
        } catch (authError) {
            console.warn('Error al cerrar sesión de Firebase:', authError);
        }
        
        // 4. Limpiar datos en caché
        serviciosData = [];
        turnosData = [];
        ofertasActivas = [];
        horariosAgenda = {};
        
        // 5. Mostrar mensaje
        showNotification('Sesión cerrada exitosamente', 'info');
        
        // 6. Ocultar panel y mostrar login
        setTimeout(() => {
            document.querySelector('.container').style.display = 'none';
            document.getElementById('loginModal').style.display = 'flex';
            
            // Limpiar formulario
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            
            // Reiniciar variable de carga inicial
            window.isInitialLoad = true;
            
            hideLoading();
        }, 1000);
        
    } catch (error) {
        console.error('Error en logout:', error);
        showNotification('Error al cerrar sesión: ' + error.message, 'error');
        hideLoading();
    }
}

// ========== MANEJO DE CONEXIÓN ==========
function setupConnectionMonitor() {
    // Monitorear conexión a internet
    window.addEventListener('online', function() {
        console.log('🌐 Conexión restablecida');
        document.getElementById('connectionStatus').style.borderColor = 'var(--success)';
        document.getElementById('connectionStatus').querySelector('.status-dot').style.backgroundColor = 'var(--success)';
        showNotification('Conexión restablecida', 'success');
        
        // Reconectar listeners
        setTimeout(() => {
            if (localStorage.getItem('admin_logged_in') === 'true') {
                setupRealTimeListeners();
            }
        }, 2000);
    });
    
    window.addEventListener('offline', function() {
        console.log('⚠️ Sin conexión a internet');
        document.getElementById('connectionStatus').style.borderColor = 'var(--error)';
        document.getElementById('connectionStatus').querySelector('.status-dot').style.backgroundColor = 'var(--error)';
        showNotification('Sin conexión a internet', 'error');
    });
}

// ========== MONITOREO DE SESIÓN ==========
function setupSessionMonitoring() {
    console.log('🔐 Configurando monitoreo de sesión...');
    
    // Verificar si el usuario sigue autenticado cada 5 minutos
    setInterval(async () => {
        try {
            const isLoggedIn = localStorage.getItem('admin_logged_in') === 'true';
            
            if (!isLoggedIn) {
                console.log('⚠️ Sesión expirada (no hay token en localStorage)');
                return;
            }
            
            // Verificar con Firebase Auth
            if (auth.currentUser) {
                // Actualizar token si es necesario
                await auth.currentUser.getIdToken(true);
                console.log('🔄 Token de sesión actualizado');
            } else {
                console.log('⚠️ Usuario no autenticado en Firebase');
                // Intentar reconectar
                await checkAuth();
            }
        } catch (error) {
            console.error('Error en monitoreo de sesión:', error);
        }
    }, 5 * 60 * 1000); // Cada 5 minutos
    
    // Escuchar cambios de autenticación
    auth.onAuthStateChanged((user) => {
        if (user) {
            console.log('✅ Usuario autenticado:', user.email);
            // Mantener localStorage actualizado
            localStorage.setItem('admin_logged_in', 'true');
            localStorage.setItem('admin_email', user.email);
        } else {
            console.log('❌ Usuario no autenticado');
            
            // Si estamos en el panel admin, verificar si debemos cerrar sesión
            if (document.querySelector('.container').style.display !== 'none') {
                const isHardcodedAdmin = localStorage.getItem('admin_uid') === 'hardcoded_admin';
                
                if (!isHardcodedAdmin) {
                    console.log('Cerrando sesión por falta de autenticación...');
                    setTimeout(() => logout(), 5000);
                }
            }
        }
    });
    
    console.log('✅ Monitoreo de sesión configurado');
}

// ========== CONFIGURACIÓN DE AUTENTICACIÓN ==========
const ADMIN_CREDENTIALS = {
    email: "alexis@asstudio.com",  // Cambia esto
    password: "admin123"           // Cambia esto
};

// ========== VERIFICACIÓN DE AUTENTICACIÓN SIMPLIFICADA ==========
async function checkAuth() {
    // Verificar localStorage primero
    const isLoggedIn = localStorage.getItem('admin_logged_in') === 'true';
    const savedEmail = localStorage.getItem('admin_email');
    
    if (isLoggedIn && savedEmail) {
        console.log('Usuario ya logueado:', savedEmail);
        
        // Ocultar modal de login
        document.getElementById('loginModal').style.display = 'none';
        
        // Mostrar contenido del admin
        document.querySelector('.container').style.display = 'block';
        
        // Actualizar UI
        document.querySelector('.admin-user').innerHTML = `
            <i class="fas fa-user-shield"></i> ${savedEmail}
        `;
        
        // Cargar datos
        await loadInitialData();
        return true;
    } else {
        // Mostrar modal de login
        console.log('No hay usuario logueado, mostrando login');
        document.getElementById('loginModal').style.display = 'flex';
        document.querySelector('.container').style.display = 'none';
        return false;
    }
}

// ========== LOGIN SIMPLIFICADO ==========
async function login() {
    try {
        console.log('Iniciando login...');
        
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        
        if (!email || !password) {
            showNotification('Ingresa email y contraseña', 'error');
            return;
        }
        
        showLoading();
        
        // Intentar autenticar con Firebase Auth
        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            console.log('Login Firebase exitoso:', userCredential.user.email);
            
            // Guardar en localStorage
            localStorage.setItem('admin_logged_in', 'true');
            localStorage.setItem('admin_email', userCredential.user.email);
            localStorage.setItem('admin_uid', userCredential.user.uid);
            
            document.getElementById('loginModal').style.display = 'none';
            document.querySelector('.container').style.display = 'block';
            
            document.querySelector('.admin-user').innerHTML = `
                <i class="fas fa-user-shield"></i> ${userCredential.user.email}
            `;
            
            await loadInitialData();
            showNotification('Acceso concedido', 'success');
            
        } catch (authError) {
            console.error('Error Firebase Auth:', authError);
            
            // Si falla Firebase Auth, usar credenciales hardcodeadas
            const hardcodedEmail = "alexis@asstudio.com";
            const hardcodedPassword = "admin123";
            
            if (email === hardcodedEmail && password === hardcodedPassword) {
                console.log('Login exitoso con credenciales hardcodeadas');
                
                localStorage.setItem('admin_logged_in', 'true');
                localStorage.setItem('admin_email', email);
                localStorage.setItem('admin_uid', 'hardcoded_admin');
                
                document.getElementById('loginModal').style.display = 'none';
                document.querySelector('.container').style.display = 'block';
                
                document.querySelector('.admin-user').innerHTML = `
                    <i class="fas fa-user-shield"></i> ${email}
                `;
                
                await loadInitialData();
                showNotification('Acceso concedido', 'success');
            } else {
                showNotification('Credenciales incorrectas', 'error');
            }
        }
        
        hideLoading();
        
    } catch (error) {
        console.error('Error en login:', error);
        showNotification('Error: ' + error.message, 'error');
        hideLoading();
    }
}

// ========== LOGOUT ==========
async function logout() {
    try {
        // Limpiar localStorage
        localStorage.removeItem('admin_logged_in');
        localStorage.removeItem('admin_email');
        
        // Intentar cerrar sesión de Firebase si está autenticado
        if (auth.currentUser) {
            await auth.signOut();
        }
        
        showNotification('Sesión cerrada', 'info');
        
        // Mostrar modal de login nuevamente
        document.getElementById('loginModal').style.display = 'flex';
        document.querySelector('.container').style.display = 'none';
        
    } catch (error) {
        console.error('Error al cerrar sesión:', error);
        showNotification('Error al cerrar sesión', 'error');
    }
}

// Función para probar autenticación manualmente
async function testAuth() {
    console.log('=== TEST DE AUTENTICACIÓN ===');
    console.log('1. Firebase app:', firebase.apps.length > 0 ? 'Inicializada' : 'No inicializada');
    console.log('2. Auth disponible:', auth ? 'Sí' : 'No');
    console.log('3. Usuario actual:', auth?.currentUser?.email || 'No autenticado');
    
    try {
        // Intentar crear un usuario de prueba
        console.log('4. Creando usuario de prueba...');
        const testEmail = 'test' + Date.now() + '@test.com';
        const testPassword = 'test123';
        
        const userCredential = await auth.createUserWithEmailAndPassword(testEmail, testPassword);
        console.log('5. Usuario creado:', userCredential.user.email);
        
        // Cerrar sesión
        await auth.signOut();
        console.log('6. Sesión cerrada');
        
        // Intentar login con el usuario creado
        console.log('7. Intentando login...');
        const loginResult = await auth.signInWithEmailAndPassword(testEmail, testPassword);
        console.log('8. Login exitoso:', loginResult.user.email);
        
        return true;
    } catch (error) {
        console.error('9. Error en test:', error.code, error.message);
        return false;
    }
}

// ========== CARGA INICIAL MODIFICADA ==========
document.addEventListener('DOMContentLoaded', async function () {
    console.log('Panel de administración cargado');
    
    // 1. Inicializar Firebase
    const firebaseInitialized = initializeFirebase();
    
    if (!firebaseInitialized) {
        showNotification('Error al inicializar la base de datos', 'error');
        return;
    }
    
    // 2. Configurar fechas
    const hoy = new Date();
    const hoyFormatted = formatDate(hoy);
    
    const fechaHorarios = document.getElementById('fechaHorarios');
    const filtroFecha = document.getElementById('filtroFecha');
    
    if (fechaHorarios) fechaHorarios.value = hoyFormatted;
    if (filtroFecha) filtroFecha.value = hoyFormatted;
    
    // Configurar fecha de ofertas
    const manana = new Date();
    manana.setDate(manana.getDate() + 1);
    
    const fechaInicioOferta = document.getElementById('fechaInicioOferta');
    const fechaFinOferta = document.getElementById('fechaFinOferta');
    
    if (fechaInicioOferta) fechaInicioOferta.value = hoyFormatted;
    if (fechaFinOferta) fechaFinOferta.value = formatDate(manana);
    
    // Configurar mes actual en métricas
    const mesActual = hoy.getMonth() + 1;
    const filtroMesMetricas = document.getElementById('filtroMesMetricas');
    const filtroAnioMetricas = document.getElementById('filtroAnioMetricas');
    
    if (filtroMesMetricas) filtroMesMetricas.value = mesActual;
    if (filtroAnioMetricas) filtroAnioMetricas.value = hoy.getFullYear();
    
    // 3. Configurar listeners
    setupNavigation();
    setupEventListeners();
    
    // 4. Inicializar funciones de ofertas
    calcularDescuento();
    actualizarTextoDuracion();
    
    // 5. Verificar autenticación
    await checkAuth();
});

// Úsala así en tus funciones:
async function loadServicios() {
    try {
        // Verificar que db esté inicializado
        if (!db) {
            console.error('Firebase no está inicializado en loadServicios');
            showNotification('Base de datos no disponible', 'error');
            return;
        }

        showLoading();
        
        const result = await safeFirebaseQuery(
            () => db.collection('servicios').orderBy('nombre').get(),
            'Error al cargar servicios'
        );
        
        if (result) {
            serviciosData = result.docs.map(doc => ({ 
                id: doc.id, 
                ...doc.data() 
            }));
            renderServicios();
        }
        
        hideLoading();
    } catch (error) {
        console.error('Error en loadServicios:', error);
        hideLoading();
    }
}

// ========== FUNCIONES AUXILIARES ==========

function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function parseDateInput(dateString) {
    if (!dateString) return new Date();
    return new Date(dateString + 'T12:00:00');
}

function getEstadoTexto(estado) {
    const estados = {
        'pendiente': 'Pendiente',
        'confirmado': 'Confirmado',
        'asistio': 'Asistió',
        'no_asistio': 'No Asistió',
        'cancelado': 'Cancelado'
    };
    return estados[estado] || estado;
}

function generarHorariosCompletos(inicio, fin) {
    const horarios = [];
    let [horaInicio, minutoInicio] = inicio.split(':').map(Number);
    let [horaFin, minutoFin] = fin.split(':').map(Number);
    
    // Si la hora de inicio tiene minutos, redondear a la hora siguiente
    if (minutoInicio > 0) {
        horaInicio += 1;
        minutoInicio = 0;
    }
    
    // Si la hora de fin tiene minutos, usar esa hora completa
    if (minutoFin > 0) {
        // Ya incluimos esa hora
    }
    
    let horaActual = horaInicio;
    
    while (horaActual <= horaFin) {
        // Solo horas completas (sin minutos)
        const horaStr = horaActual.toString().padStart(2, '0');
        horarios.push(`${horaStr}:00`);
        
        horaActual += 1;
    }
    
    return horarios;
}

function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    if (!notification) return;

    notification.textContent = message;
    notification.className = `notification ${type}`;
    notification.style.display = 'block';

    setTimeout(() => {
        notification.style.display = 'none';
    }, 5000);
}

function showLoading() {
    const loading = document.getElementById('loadingOverlay');
    if (loading) loading.classList.add('active');
}

function hideLoading() {
    setTimeout(() => {
        const loading = document.getElementById('loadingOverlay');
        if (loading) loading.classList.remove('active');
    }, 500);
}

// ========== FUNCIONES GLOBALES ACCESIBLES ==========

const AdminApp = {
    cambiarMesAgenda: function(delta) {
        mesAgendaActual += delta;
        if (mesAgendaActual < 0) {
            mesAgendaActual = 11;
            anioAgendaActual--;
        } else if (mesAgendaActual > 11) {
            mesAgendaActual = 0;
            anioAgendaActual++;
        }
        generarCalendarioAgenda();
        document.getElementById('cardConfigDia').style.display = 'none';
    },
    
    agregarDescanso: function(hora = '12:00') {
        const container = document.getElementById('descansosContainer');
        if (!container) return;
        const div = document.createElement('div');
        div.className = 'descanso-item';
        div.innerHTML = `
            <input type="time" class="form-control" value="${hora}" style="flex: 1;">
            <button class="btn-eliminar-descanso" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        container.appendChild(div);
    },
    
    
resetConfigDia: async function() {
    if (!fechaSeleccionadaAgenda) return;
    
    if (confirm('¿Estás seguro de restablecer la configuración de este día?')) {
        try {
            showLoading();
            
            await db.collection('horarios_agenda')
                .doc(fechaSeleccionadaAgenda)
                .delete();

            delete horariosAgenda[fechaSeleccionadaAgenda];
            
            document.getElementById('horaInicio').value = '09:00';
            document.getElementById('horaFin').value = '19:00';
            const descansosContainer = document.getElementById('descansosContainer');
            if (descansosContainer) {
                descansosContainer.innerHTML = '';
                AdminApp.agregarDescanso('12:00');
            }
            
            generarCalendarioAgenda();
            
            showNotification('Configuración restablecida', 'info');
            hideLoading();

        } catch (error) {
            console.error('Error al restablecer configuración:', error);
            showNotification('Error al restablecer la configuración', 'error');
            hideLoading();
        }
    }
}
}

// ========== FUNCIONES PRINCIPALES ==========

// Cargar servicios
async function loadServicios() {
    try {
        showLoading();
        const querySnapshot = await db.collection('servicios')
            .orderBy('nombre')
            .get();
        
        serviciosData = querySnapshot.docs.map(doc => ({ 
            id: doc.id, 
            ...doc.data() 
        }));
        
        renderServicios();
        hideLoading();
    } catch (error) {
        console.error('Error al cargar servicios:', error);
        showNotification('Error al cargar los servicios', 'error');
        hideLoading();
    }
}

function renderServicios() {
    const container = document.getElementById('listaServicios');
    if (!container) return;
    
    if (serviciosData.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 30px; color: #aaa;">
                <i class="fas fa-cut fa-3x" style="margin-bottom: 15px;"></i>
                <p>No hay servicios configurados</p>
                <button class="btn-accion btn-confirmar" onclick="crearServicioEjemplo()" style="margin-top: 15px;">
                    <i class="fas fa-plus"></i> Crear Servicio de Ejemplo
                </button>
            </div>
        `;
        return;
    }

    container.innerHTML = '';
    serviciosData.forEach(servicio => {
        const item = document.createElement('div');
        item.style = 'display: flex; justify-content: space-between; align-items: center; padding: 15px; background-color: var(--dark); border-radius: var(--border-radius); margin-bottom: 10px; border-left: 4px solid var(--primary);';
        item.innerHTML = `
            <div style="flex: 1;">
                <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary);">
                    ${servicio.nombre}
                </div>
                <div style="color: #aaa; font-size: 0.9rem; margin-bottom: 5px;">
                    ${servicio.descripcion || 'Sin descripción'}
                </div>
                <div style="font-weight: bold; color: var(--light);">
                    $${servicio.precio.toLocaleString('es-AR')}
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn-accion btn-confirmar" onclick="editarServicio('${servicio.id}')" style="padding: 8px 15px;">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button class="btn-accion btn-cancelar" onclick="eliminarServicioConfirm('${servicio.id}')" style="padding: 8px 15px;">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </div>
        `;
        container.appendChild(item);
    });
}

// Función para confirmar eliminación
function eliminarServicioConfirm(id) {
    if (confirm('¿Estás seguro de eliminar este servicio?\nEsta acción no se puede deshacer.')) {
        eliminarServicio(id);
    }
}

// Función para crear servicio de ejemplo
async function crearServicioEjemplo() {
    try {
        showLoading();
        
        const servicioEjemplo = {
            nombre: "Corte de Cabello",
            descripcion: "Corte tradicional con tijera y máquina",
            precio: 2500,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('servicios').add(servicioEjemplo);
        
        showNotification('Servicio de ejemplo creado', 'success');
        await loadServicios();
        hideLoading();
        
    } catch (error) {
        console.error('Error al crear servicio:', error);
        showNotification('Error al crear servicio: ' + error.message, 'error');
        hideLoading();
    }
}

// Guardar servicio
async function saveServicio() {
    try {
        // 🔒 Prevenir múltiples ejecuciones
        if (this.isSaving) {
            showNotification('Ya se está guardando un servicio', 'warning');
            return;
        }
        this.isSaving = true;
        
        showLoading();
        
        const id = document.getElementById('servicioId').value;
        const nombre = document.getElementById('servicioNombre').value;
        const descripcion = document.getElementById('servicioDescripcion').value;
        const precio = parseFloat(document.getElementById('servicioPrecio').value);
        
        if (!nombre || !precio || isNaN(precio)) {
            showNotification('Nombre y precio son requeridos', 'error');
            this.isSaving = false;
            hideLoading();
            return;
        }
        
        // 🔍 Verificar duplicados (solo para nuevos servicios)
        if (!id) {
            const serviciosSnapshot = await db.collection('servicios')
                .where('nombre', '==', nombre)
                .limit(1)
                .get();
            
            if (!serviciosSnapshot.empty) {
                if (!confirm('Ya existe un servicio con este nombre. ¿Deseas editarlo en lugar de crear uno nuevo?')) {
                    this.isSaving = false;
                    hideLoading();
                    return;
                }
            }
        }
        
        const servicioData = {
            nombre,
            descripcion,
            precio,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // ✅ Usar transacción para prevenir duplicados
        if (id) {
            await db.collection('servicios').doc(id).update(servicioData);
        } else {
            await db.collection('servicios').add(servicioData);
        }
        
        showNotification('Servicio guardado correctamente', 'success');
        await loadServicios();
        resetServicioForm();
        
    } catch (error) {
        console.error('Error al guardar servicio:', error);
        showNotification('Error: ' + error.message, 'error');
    } finally {
        hideLoading();
        this.isSaving = false;
    }
}

async function editarServicio(id) {
    try {
        showLoading();
        const doc = await db.collection('servicios').doc(id).get();
        
        if (doc.exists) {
            const data = { id: doc.id, ...doc.data() };
            document.getElementById('servicioId').value = data.id;
            document.getElementById('servicioNombre').value = data.nombre;
            document.getElementById('servicioDescripcion').value = data.descripcion || '';
            document.getElementById('servicioPrecio').value = data.precio;

            document.getElementById('formTitle').textContent = 'Editar Servicio';
            document.getElementById('submitText').textContent = 'Actualizar Servicio';
        }
        hideLoading();
    } catch (error) {
        console.error('Error al cargar servicio:', error);
        showNotification('Error al cargar el servicio', 'error');
        hideLoading();
    }
}

function resetServicioForm() {
    const form = document.getElementById('servicioForm');
    if (form) form.reset();
    document.getElementById('servicioId').value = '';
    document.getElementById('formTitle').textContent = 'Agregar Nuevo Servicio';
    document.getElementById('submitText').textContent = 'Guardar Servicio';
}

// ========== FUNCIONES AGENDA ==========
async function cargarConfiguracionAgenda() {
    try {
        const querySnapshot = await db.collection('horarios_agenda').get();
        
        horariosAgenda = {};
        querySnapshot.docs.forEach(doc => {
            const data = { id: doc.id, ...doc.data() };
            horariosAgenda[data.fecha] = data;
        });

        console.log('Configuración de agenda cargada:', Object.keys(horariosAgenda).length, 'días');
        generarCalendarioAgenda();
        
    } catch (error) {
        console.error('Error al cargar configuración de agenda:', error);
        showNotification('Error al cargar configuración de agenda: ' + error.message, 'error');
    }
}

function generarCalendarioAgenda() {
    const calendarDiv = document.querySelector('.agenda-calendar');
    if (!calendarDiv) {
        console.error('❌ No se encontró .agenda-calendar');
        return;
    }

    const fechaActual = new Date();
    fechaActual.setHours(0, 0, 0, 0);
    
    const primerDia = new Date(anioAgendaActual, mesAgendaActual, 1);
    const ultimoDia = new Date(anioAgendaActual, mesAgendaActual + 1, 0);
    
    // Actualizar título del mes
    const mesTitulo = document.getElementById('mesActualAgenda');
    if (mesTitulo) {
        mesTitulo.textContent = 
            `${primerDia.toLocaleDateString('es-ES', { month: 'long' })} ${anioAgendaActual}`.toUpperCase();
    }

    let html = '';
    
    // Días de la semana
    const dayNames = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
    for (let i = 0; i < 7; i++) {
        html += `<div class="calendar-day-name">${dayNames[i]}</div>`;
    }

    const primerDiaSemana = primerDia.getDay();
    const hoyFormatted = formatDate(fechaActual);
    
    // Días vacíos al inicio
    for (let i = 0; i < primerDiaSemana; i++) {
        html += '<div class="calendar-day disabled"></div>';
    }

    // Días del mes
    for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
        const fechaStr = `${anioAgendaActual}-${String(mesAgendaActual + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
const fechaObj = new Date(anioAgendaActual, mesAgendaActual, dia);
        const esHoy = fechaStr === hoyFormatted;
        
        // Fechas pasadas (excepto hoy)
const esPasado = fechaObj < fechaActual && !esHoy;

        const config = horariosAgenda[fechaStr];
        const clases = [];
        
        if (esHoy) clases.push('today');
        if (config) {
            clases.push(config.activo ? 'active' : 'inactive');
        }
        if (esPasado) clases.push('disabled-pasado');
        
        const horasTexto = config && config.activo ? 
            `${config.hora_inicio || '09:00'} - ${config.hora_fin || '19:00'}` : 
            'No config';
        
        const onClick = esPasado ? '' : `AdminApp.configurarDiaAgenda('${fechaStr}', true)`;
        
        html += `
            <div class="calendar-day ${clases.join(' ')}" 
                 onclick="${onClick}"
                 data-fecha="${fechaStr}"
                 data-dia="${dia}">
                <div class="day-number">${dia}</div>
                <div class="day-status">${config ? (config.activo ? 'Activo' : 'Inactivo') : 'Sin config'}</div>
                <div class="day-hours">${horasTexto}</div>
            </div>
        `;
    }

    calendarDiv.innerHTML = html;
    console.log('✅ Calendario generado con', ultimoDia.getDate(), 'días');
    
    // Auto-seleccionar hoy si estamos en el mes actual
    const hoyObj = new Date();
    if (hoyObj.getMonth() === mesAgendaActual && hoyObj.getFullYear() === anioAgendaActual) {
        console.log('📅 Auto-seleccionando hoy:', hoyFormatted);
        
        // Dar tiempo para que se renderice el DOM
        setTimeout(() => {
            AdminApp.configurarDiaAgenda(hoyFormatted, true);
        }, 300);
    }
}

async function cargarConfiguracionDia(fecha) {
    try {
        const config = horariosAgenda[fecha];
        
        if (config) {
            document.querySelector('input[name="estadoDia"][value="activo"]').checked = config.activo;
            document.querySelector('input[name="estadoDia"][value="inactivo"]').checked = !config.activo;
            
            document.getElementById('horaInicio').value = config.hora_inicio || '09:00';
            document.getElementById('horaFin').value = config.hora_fin || '19:00';
            
            const descansosContainer = document.getElementById('descansosContainer');
            descansosContainer.innerHTML = '';
            
            if (config.descansos && config.descansos.length > 0) {
                config.descansos.forEach(descanso => {
                    AdminApp.agregarDescanso(descanso);
                });
            } else {
                AdminApp.agregarDescanso('12:00');
            }
        } else {
            document.querySelector('input[name="estadoDia"][value="activo"]').checked = true;
            document.getElementById('horaInicio').value = '09:00';
            document.getElementById('horaFin').value = '19:00';
            
            const descansosContainer = document.getElementById('descansosContainer');
            descansosContainer.innerHTML = '';
            AdminApp.agregarDescanso('12:00');
        }
        
        document.getElementById('configHorariosContenedor').style.display = 
            document.querySelector('input[name="estadoDia"][value="activo"]').checked ? 'block' : 'none';
    } catch (error) {
        console.error('Error al cargar configuración del día:', error);
    }
}

async function notificarActualizacionAgenda(fecha = null, tipoCambio = 'configuracion_dia') {
    try {
        console.log('📢 Notificando actualización de agenda...', { fecha, tipoCambio });
        
        const datosNotificacion = {
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            tipo: tipoCambio,
            fecha_afectada: fecha || fechaSeleccionadaAgenda,
            administrador: 'Alexis',
            version: Date.now()
        };
        
        // 1. Guardar registro en configuracion
        await db.collection('configuracion').doc('ultima_actualizacion_agenda').set(datosNotificacion);
        
        // 2. Crear un log de cambios
        await db.collection('logs_agenda').add({
            ...datosNotificacion,
            accion: 'configuracion_actualizada',
            usuario: 'admin'
        });
        
        // 3. Marcar para sincronización en usuarios
        const marcadorSincronizacion = {
            necesita_sincronizacion: true,
            ultima_actualizacion: firebase.firestore.FieldValue.serverTimestamp(),
            cambios_pendientes: [fecha || fechaSeleccionadaAgenda]
        };
        
        await db.collection('sincronizacion').doc('agenda').set(marcadorSincronizacion);
        
        console.log('✅ Notificación de agenda completada');
        return true;
        
    } catch (error) {
        console.error('❌ Error al notificar actualización:', error);
        // No propagar el error para no interrumpir el flujo principal
        return false;
    }
}

// En admin.html, agregar esta función
async function forzarRecargaUsuarios() {
    try {
        showLoading();
        
        // Crear un marcador de sincronización
        await db.collection('configuracion').doc('ultima_sincronizacion').set({
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            mensaje: 'Actualización de agenda',
            version: Date.now()
        });
        
        showNotification('Notificación enviada a usuarios. La próxima vez que carguen la página verán los cambios.', 'success');
        
    } catch (error) {
        console.error('Error al forzar recarga:', error);
        showNotification('Error: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

async function aplicarConfiguracionRepetida(configData, tipo) {
    const fechaBase = new Date(configData.fecha + 'T12:00:00');
    
    try {
        if (tipo === 'semanal') {
            const fechaActual = new Date(fechaBase);
            const mesActual = fechaBase.getMonth();
            
            while (fechaActual.getMonth() === mesActual) {
                const fechaStr = formatDate(fechaActual);
                if (fechaStr !== configData.fecha) {
                    const configSemanal = { 
                        ...configData, 
                        fecha: fechaStr,
                        duracion_cita: configData.duracion_cita || 60
                    };
                    
                    // Guardar en AMBAS colecciones
                    await db.collection('horarios_agenda').doc(fechaStr).set(configSemanal);
                    await db.collection('calendario_usuario').doc(fechaStr).set(configSemanal);
                    
                    horariosAgenda[fechaStr] = configSemanal;
                }
                fechaActual.setDate(fechaActual.getDate() + 7);
            }
        } else if (tipo === 'resto-mes') {
            const primerDia = new Date(fechaBase.getFullYear(), fechaBase.getMonth(), 1);
            const ultimoDia = new Date(fechaBase.getFullYear(), fechaBase.getMonth() + 1, 0);
            
            let fechaActual = new Date(fechaBase);
            fechaActual.setDate(fechaActual.getDate() + 1);
            
            while (fechaActual <= ultimoDia) {
                const fechaStr = formatDate(fechaActual);
                const configRestoMes = { 
                    ...configData, 
                    fecha: fechaStr,
                    duracion_cita: configData.duracion_cita || 60
                };
                
                // Guardar en AMBAS colecciones
                await db.collection('horarios_agenda').doc(fechaStr).set(configRestoMes);
                await db.collection('calendario_usuario').doc(fechaStr).set(configRestoMes);
                
                horariosAgenda[fechaStr] = configRestoMes;
                
                fechaActual.setDate(fechaActual.getDate() + 1);
            }
        }
        
        showNotification('Configuración aplicada a múltiples días y sincronizada', 'success');
    } catch (error) {
        console.error('Error al aplicar configuración repetida:', error);
        throw error;
    }
}

// ========== FUNCIONES TURNOS ==========

async function loadTurnos() {
    try {
        showLoading();
        
        const fechaFiltro = document.getElementById('filtroFecha').value;
        const estadoFiltro = document.getElementById('filtroEstado').value;
        
        let query = db.collection('turnos');
        
        if (fechaFiltro) {
            query = query.where('fecha', '==', fechaFiltro);
        }
        
        if (estadoFiltro !== 'todos') {
            query = query.where('estado', '==', estadoFiltro);
        }
        
        const querySnapshot = await query
            .orderBy('fecha', 'asc')
            .orderBy('hora', 'asc')
            .get();
        
        let data = querySnapshot.docs.map(doc => ({ 
            id: doc.id, 
            ...doc.data() 
        }));
        
        turnosData = data;
        renderTurnos();
        hideLoading();
    } catch (error) {
        console.error('Error al cargar turnos:', error);
        showNotification('Error al cargar los turnos', 'error');
        hideLoading();
    }
}

// Función para sincronizar manualmente toda la agenda
async function sincronizarAgendaCompleta() {
    if (!confirm('¿Sincronizar TODA la agenda con los usuarios?\nEsto copiará toda la configuración a calendario_usuario.')) {
        return;
    }
    
    try {
        showLoading();
        
        // Obtener toda la configuración de horarios_agenda
        const agendaSnapshot = await db.collection('horarios_agenda').get();
        
        let sincronizados = 0;
        let errores = 0;
        
        for (const doc of agendaSnapshot.docs) {
            try {
                const config = doc.data();
                const fecha = config.fecha || doc.id;
                
                // Preparar datos para calendario_usuario
                const configUsuario = {
                    ...config,
                    fecha: fecha,
                    tipo: 'configuracion_agenda',
                    sincronizado_en: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Guardar en calendario_usuario
                await db.collection('calendario_usuario').doc(fecha).set(configUsuario);
                sincronizados++;
                
            } catch (error) {
                console.error(`Error sincronizando ${doc.id}:`, error);
                errores++;
            }
        }
        
        showNotification(`Agenda sincronizada: ${sincronizados} días actualizados${errores > 0 ? `, ${errores} errores` : ''}`, 'success');
        
    } catch (error) {
        console.error('Error al sincronizar agenda:', error);
        showNotification('Error al sincronizar: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

function renderTurnos() {
    const container = document.getElementById('turnosGrid');
    const contador = document.getElementById('contadorTurnos');
    const sinTurnos = document.getElementById('sinTurnos');
    
    if (!container) return;
    
    if (turnosData.length === 0) {
        container.innerHTML = '';
        if (contador) contador.textContent = 'Mostrando 0 turnos';
        if (sinTurnos) sinTurnos.style.display = 'block';
        return;
    }
    
    if (sinTurnos) sinTurnos.style.display = 'none';
    if (contador) contador.textContent = `Mostrando ${turnosData.length} turno(s)`;
    
    let html = '';
    
    turnosData.forEach(turno => {
        const estadoClase = `estado-${turno.estado}`;
        const estadoTexto = getEstadoTexto(turno.estado);
        
        const esHoy = turno.fecha === formatDate(new Date());
        const horaClass = esHoy ? 'turno-hora hoy' : 'turno-hora';
        
        html += `
            <div class="turno-card" onclick="mostrarDetallesTurno('${turno.id}')">
                <div class="turno-header">
                    <div class="${horaClass}">${turno.hora}</div>
                    <div class="turno-estado ${estadoClase}">${estadoTexto}</div>
                </div>
                <div class="turno-cliente">${turno.nombre}</div>
                <div class="turno-servicio">${turno.servicio}</div>
                <div class="turno-precio">$${turno.precio}</div>
                <div class="turno-whatsapp">
                    <i class="fab fa-whatsapp"></i> ${turno.telefono || 'Sin teléfono'}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Reemplazar la función cargarGridHorarios con esta versión actualizada
async function cargarGridHorarios() {
    try {
        const fechaInput = document.getElementById('fechaHorarios');
        if (!fechaInput) return;
        
        const fechaSeleccionada = fechaInput.value || formatDate(new Date());
        const fechaObj = parseDateInput(fechaSeleccionada);
        
        // Actualizar texto de la fecha
        const fechaTexto = fechaObj.toLocaleDateString('es-ES', { 
            weekday: 'long', 
            day: 'numeric', 
            month: 'long',
            year: 'numeric'
        }).toUpperCase();
        
        document.getElementById('fechaHorariosTexto').textContent = fechaTexto;
        
        // Mostrar información del día
        const infoFecha = document.getElementById('infoFecha');
        const infoHorarios = document.getElementById('infoHorarios');
        const infoDiaDiv = document.getElementById('infoDiaSeleccionado');
        
        if (infoFecha) infoFecha.textContent = fechaTexto;
        
        const configDia = horariosAgenda[fechaSeleccionada];
        
        if (!configDia || !configDia.activo) {
            if (infoHorarios) infoHorarios.textContent = 'Día no laborable o sin configuración';
            if (infoDiaDiv) infoDiaDiv.style.display = 'block';
            
            document.getElementById('gridHorarios').innerHTML = `
                <div style="text-align: center; padding: 30px; color: #aaa; grid-column: 1 / -1;">
                    <i class="fas fa-calendar-times fa-3x" style="margin-bottom: 15px;"></i>
                    <p>Día no laborable o sin configuración</p>
                    <button class="btn-accion btn-confirmar" onclick="document.querySelector('.nav-btn[data-section=\"agenda\"]').click()" style="margin-top: 15px;">
                        <i class="fas fa-calendar-alt"></i> Configurar en Agenda
                    </button>
                </div>
            `;
            return;
        }
        
        // Mostrar información del horario del día
        if (infoHorarios) {
            infoHorarios.textContent = `Horario: ${configDia.hora_inicio || '09:00'} - ${configDia.hora_fin || '19:00'}${configDia.descansos?.length > 0 ? ` | Descansos: ${configDia.descansos.join(', ')}` : ''}`;
        }
        if (infoDiaDiv) infoDiaDiv.style.display = 'block';
        
        const horaInicio = configDia.hora_inicio || '09:00';
        const horaFin = configDia.hora_fin || '19:00';
        const descansos = configDia.descansos || [];
        
        const horariosDisponibles = generarHorariosCompletos(horaInicio, horaFin);
        
        // Cargar turnos del día
        const querySnapshot = await db.collection('turnos')
            .where('fecha', '==', fechaSeleccionada)
            .get();
        
        const turnosDelDia = querySnapshot.docs.map(doc => ({ 
            id: doc.id, 
            ...doc.data() 
        }));
        
        const turnosFiltrados = turnosDelDia.filter(turno => 
            turno.estado === 'pendiente' || turno.estado === 'confirmado' || turno.estado === 'asistio'
        );
        
        const turnosPorHora = {};
        turnosFiltrados.forEach(turno => {
            turnosPorHora[turno.hora] = turno;
        });
        
        // Verificar si es hoy para determinar horas pasadas
        const hoy = formatDate(new Date());
        const esHoy = fechaSeleccionada === hoy;
        const ahora = new Date();
        const horaActual = ahora.getHours().toString().padStart(2, '0') + ':' + ahora.getMinutes().toString().padStart(2, '0');
        
        let html = '';
        
        if (horariosDisponibles.length === 0) {
            html = `<div style="text-align: center; padding: 30px; color: #aaa; grid-column: 1 / -1;">
                <i class="fas fa-clock fa-3x" style="margin-bottom: 15px;"></i>
                <p>No hay horarios disponibles para este día</p>
            </div>`;
        } else {
            horariosDisponibles.forEach(hora => {
                const turno = turnosPorHora[hora];
                const esDescanso = descansos.includes(hora);
                
                // Determinar si es hora pasada (solo si es hoy)
                const esPasado = esHoy && hora < horaActual;
                
                if (esDescanso) {
                    html += `
                        <div class="celda-horario descanso ${esPasado ? 'pasado' : ''}">
                            <div class="hora-texto">${hora}</div>
                            <div class="estado-texto" style="background-color: var(--info); color: white;">DESCANSO</div>
                        </div>
                    `;
                } else if (turno) {
                    // Obtener el primer nombre del cliente (sin apellido)
                    let nombreCliente = turno.nombre || '';
                    // Tomar solo la primera palabra (primer nombre)
                    const primerNombre = nombreCliente.split(' ')[0];
                    
                    const estadoColor = turno.estado === 'confirmado' ? 'var(--success)' : 
                                     turno.estado === 'asistio' ? '#4caf50' : 'var(--warning)';
                    const estadoTexto = turno.estado === 'confirmado' ? 'OCUPADO' : 
                                      turno.estado === 'asistio' ? 'ASISTIÓ' : 'PENDIENTE';
                    
                    // Para horas pasadas con reserva, mantener funcionalidad
                    if (esPasado) {
                        html += `
                            <div class="celda-horario ocupado pasado" onclick="mostrarDetallesTurnoModal('${turno.id}')">
                                <div class="hora-texto">${hora}</div>
                                <div class="estado-texto" style="background-color: ${estadoColor}; color: white;">
                                    ${estadoTexto}
                                </div>
                                <div style="font-size: 0.7rem; color: #ccc; margin-top: 5px;">
                                    ${primerNombre}
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="celda-horario ocupado" onclick="mostrarDetallesTurnoModal('${turno.id}')">
                                <div class="hora-texto">${hora}</div>
                                <div class="estado-texto" style="background-color: ${estadoColor}; color: white;">
                                    ${estadoTexto}
                                </div>
                            </div>
                        `;
                    }
                } else {
                    // Para horas disponibles pasadas, hacer transparentes
                    if (esPasado) {
                        html += `
                            <div class="celda-horario disponible pasado">
                                <div class="hora-texto">${hora}</div>
                                <div class="estado-texto" style="background-color: #666; color: #ccc;">PASADO</div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="celda-horario disponible">
                                <div class="hora-texto">${hora}</div>
                                <div class="estado-texto" style="background-color: #9e9e9e; color: white;">DISPONIBLE</div>
                            </div>
                        `;
                    }
                }
            });
        }
        
        document.getElementById('gridHorarios').innerHTML = html;
    } catch (error) {
        console.error('Error al cargar grid de horarios:', error);
        showNotification('Error al cargar horarios', 'error');
    }
}

async function mostrarDetallesTurno(turnoId) {
    try {
        const doc = await db.collection('turnos').doc(turnoId).get();
        const turno = doc.exists ? { id: doc.id, ...doc.data() } : null;

        if (!turno) return;

        const modal = document.getElementById('modalDetalleTurno');
        const overlay = document.getElementById('overlayDetalle');
        const detallesDiv = document.getElementById('detallesTurnoModal');
        const accionesDiv = document.getElementById('accionesTurnoModal');

        if (!modal || !detallesDiv || !accionesDiv) return;

        const estadoTexto = getEstadoTexto(turno.estado);
        const estadoClase = `estado-${turno.estado}`;
        const fechaObj = parseDateInput(turno.fecha);
        const fechaFormateada = fechaObj.toLocaleDateString('es-ES', { 
            weekday: 'long', 
            day: 'numeric', 
            month: 'long' 
        });

        // FORMATO DEL TELÉFONO PARA WHATSAPP
        let telefonoWhatsapp = '';
        if (turno.telefono) {
            // Limpiar el número (quitar espacios, guiones, etc.)
            const telefonoLimpio = turno.telefono.replace(/\D/g, '');
            // Si no tiene código de país, agregar +54 (Argentina)
            if (!telefonoLimpio.startsWith('+') && !telefonoLimpio.startsWith('54')) {
                telefonoWhatsapp = `+54${telefonoLimpio}`;
            } else if (telefonoLimpio.startsWith('54') && !telefonoLimpio.startsWith('+')) {
                telefonoWhatsapp = `+${telefonoLimpio}`;
            } else {
                telefonoWhatsapp = telefonoLimpio;
            }
        }

        // GENERAR CONTADOR DE FIDELIDAD
        const contadorFidelidadHTML = await generarContadorFidelidad(turno);

        detallesDiv.innerHTML = `
            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary);">
                        ${turno.nombre}
                    </div>
                    <div class="turno-estado ${estadoClase}" style="font-size: 0.8rem;">
                        ${estadoTexto}
                    </div>
                </div>
                <div style="color: #aaa; font-size: 0.9rem; margin-bottom: 5px;">
                    <i class="fas fa-calendar-alt"></i> ${fechaFormateada}
                </div>
                <div style="color: #aaa; font-size: 0.9rem; margin-bottom: 5px;">
                    <i class="fas fa-clock"></i> ${turno.hora}
                </div>
                <div style="color: var(--light); font-weight: bold; margin-bottom: 5px;">
                    <i class="fas fa-cut"></i> ${turno.servicio}
                </div>
                <div style="color: var(--primary); font-size: 1.2rem; font-weight: bold; margin-bottom: 10px;">
                    $${turno.precio}
                </div>
<!-- BOTÓN DE SERVICIO ADICIONAL -->
            <button class="btn-servicio-adicional" onclick="mostrarServiciosAdicionales(${JSON.stringify(turno).replace(/"/g, '&quot;')})">
                <i class="fas fa-plus-circle"></i> Servicio Adicional
            </button>
            
            <!-- MOSTRAR SERVICIOS ADICIONALES APLICADOS -->
            ${turno.servicios_adicionales && turno.servicios_adicionales.length > 0 ? `
                <div style="margin-top: 15px; padding: 10px; background-color: rgba(33, 150, 243, 0.1); border-radius: var(--border-radius);">
                    <div style="font-weight: bold; color: #2196f3; margin-bottom: 8px;">
                        <i class="fas fa-plus-circle"></i> Servicios Adicionales:
                    </div>
                    ${turno.servicios_adicionales.map(servicio => `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem;">
                            <span>${servicio.nombre} x${servicio.cantidad}</span>
                            <span>$${servicio.subtotal}</span>
                        </div>
                    `).join('')}
                    <div style="display: flex; justify-content: space-between; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(33, 150, 243, 0.3); font-weight: bold;">
                        <span>TOTAL CON ADICIONALES:</span>
                        <span style="color: var(--primary);">$${turno.precio_total || turno.precio}</span>
                    </div>
                </div>
            ` : ''}

                ${turno.telefono ? `
                    <div style="color: #25D366; font-size: 0.9rem; margin-bottom: 10px; cursor: pointer;" 
                         onclick="abrirWhatsApp('${telefonoWhatsapp}')"
                         onmouseover="this.style.textDecoration='underline'" 
                         onmouseout="this.style.textDecoration='none'">
                        <i class="fab fa-whatsapp"></i> ${turno.telefono} 
                        <span style="font-size: 0.8rem; color: #aaa;">(Click para abrir WhatsApp)</span>
                    </div>
                ` : '<div style="color: #666; font-size: 0.9rem; margin-bottom: 10px;">Sin teléfono</div>'}
                
                <!-- SISTEMA DE FIDELIDAD - Aquí se inserta el contador -->
                ${contadorFidelidadHTML}
            </div>
        `;

        let accionesHTML = '';
        
        if (turno.estado === 'pendiente') {
            accionesHTML = `
                <button class="btn-accion btn-confirmar" onclick="AdminApp.cambiarEstadoTurno('${turno.id}', 'confirmado')">
                    <i class="fas fa-check-circle"></i> Confirmar
                </button>
                <button class="btn-accion btn-cancelar" onclick="AdminApp.cancelarTurno('${turno.id}')">
                    <i class="fas fa-times-circle"></i> Cancelar
                </button>
            `;
        } else if (turno.estado === 'confirmado') {
            accionesHTML = `
                <button class="btn-accion btn-asistio" onclick="AdminApp.cambiarEstadoTurno('${turno.id}', 'asistio')">
                    <i class="fas fa-user-check"></i> Marcar como Asistió
                </button>
                <button class="btn-accion btn-no-asistio" onclick="AdminApp.cambiarEstadoTurno('${turno.id}', 'no_asistio')">
                    <i class="fas fa-user-times"></i> No Asistió
                </button>
                <button class="btn-accion btn-cancelar" onclick="AdminApp.cancelarTurno('${turno.id}')">
                    <i class="fas fa-times-circle"></i> Cancelar
                </button>
            `;
        }

        accionesDiv.innerHTML = accionesHTML;

        modal.classList.add('active');
        overlay.classList.add('active');

    } catch (error) {
        console.error('Error al mostrar detalles del turno:', error);
        showNotification('Error al cargar detalles del turno', 'error');
    }
}

// Función para abrir WhatsApp
function abrirWhatsApp(telefono) {
    if (!telefono) return;
    
    // Crear mensaje predeterminado
    const mensaje = encodeURIComponent(`Hola! Te contacto desde A.S. Studio respecto a tu turno.`);
    const url = `https://wa.me/${telefono}?text=${mensaje}`;
    
    // Abrir en nueva pestaña
    window.open(url, '_blank');
}

function mostrarDetallesTurnoModal(turnoId) {
    mostrarDetallesTurno(turnoId);
}

// ========== ACTUALIZAR ESTADÍSTICAS RÁPIDAS ==========
function actualizarEstadisticasRapidas(turnos) {
    try {
        const hoy = formatDate(new Date());
        const mesActual = new Date().getMonth() + 1;
        const anioActual = new Date().getFullYear();
        
        // ¡¡IMPORTANTE!! Filtrar turnos de hoy (excluyendo cancelados y no asistió)
        const turnosHoy = turnos.filter(t => 
            t.fecha === hoy && 
            t.estado !== 'cancelado' && 
            t.estado !== 'no_asistio'
        );
        
        // Filtrar turnos del mes (asistidos)
        const turnosMes = turnos.filter(t => {
            if (t.estado !== 'asistio') return false;
            const fecha = parseDateInput(t.fecha);
            return fecha.getMonth() + 1 === mesActual && fecha.getFullYear() === anioActual;
        });
        
        // Calcular ingresos del mes
        const ingresosMes = turnosMes.reduce((sum, t) => sum + (t.precio || 0), 0);
        
        // Calcular clientes únicos del mes
        const clientesUnicos = new Set(turnosMes.map(t => t.nombre)).size;
        
        // Calcular clientes fieles (3+ visitas)
        const visitasPorCliente = {};
        turnosMes.forEach(t => {
            visitasPorCliente[t.nombre] = (visitasPorCliente[t.nombre] || 0) + 1;
        });
        const clientesFieles = Object.values(visitasPorCliente).filter(v => v >= 3).length;
        
        // Actualizar UI si los elementos existen
        const turnosHoyElement = document.getElementById('turnosHoy');
        const clientesMesElement = document.getElementById('clientesMes');
        const ingresosMesElement = document.getElementById('ingresosMes');
        const clientesFielesElement = document.getElementById('clientesFieles');

        if (turnosHoyElement) turnosHoyElement.textContent = turnosHoy.length;
        if (clientesMesElement) clientesMesElement.textContent = clientesUnicos;
        if (ingresosMesElement) ingresosMesElement.textContent = `$${ingresosMes.toLocaleString('es-AR')}`;
        if (clientesFielesElement) clientesFielesElement.textContent = clientesFieles;
        
    } catch (error) {
        console.error('Error al actualizar estadísticas:', error);
    }
}

// ========== FUNCIONES DASHBOARD ==========
async function updateDashboard() {
    try {
        const hoy = formatDate(new Date());
        const mesActual = new Date().getMonth() + 1;
        const anioActual = new Date().getFullYear();
        
        // Cargar turnos de hoy - FIREBASE
        const turnosHoySnapshot = await db.collection('turnos')
            .where('fecha', '==', hoy)
            .orderBy('hora', 'asc')
            .get();
        
        const turnosHoyData = turnosHoySnapshot.docs.map(doc => ({ 
            id: doc.id, 
            ...doc.data() 
        }));
        
        // FILTRAR: Excluir cancelados y no asistió
        const turnosHoyFiltrados = turnosHoyData.filter(turno => 
            turno.estado !== 'cancelado' && turno.estado !== 'no_asistio'
        );
        
        // Actualizar estadísticas - USAR LOS TURNOS FILTRADOS
        document.getElementById('turnosHoy').textContent = turnosHoyFiltrados.length;

        // Cargar todos los turnos del mes para estadísticas - FIREBASE
        const primerDiaMes = `${anioActual}-${String(mesActual).padStart(2, '0')}-01`;
        const ultimoDiaMes = `${anioActual}-${String(mesActual).padStart(2, '0')}-31`;
        
        const turnosMesSnapshot = await db.collection('turnos')
            .where('fecha', '>=', primerDiaMes)
            .where('fecha', '<=', ultimoDiaMes)
            .get();
        
        const turnosMesData = turnosMesSnapshot.docs.map(doc => ({ 
            id: doc.id, 
            ...doc.data() 
        }));
        
        const clientesUnicos = new Set();
        let ingresosMes = 0;
        let clientesFieles = 0;
        
        turnosMesData.forEach(turno => {
            clientesUnicos.add(turno.nombre);
            if (turno.estado === 'asistio') {
                ingresosMes += turno.precio || 0;
            }
            
        });
        
        document.getElementById('clientesMes').textContent = clientesUnicos.size;
        document.getElementById('ingresosMes').textContent = `$${ingresosMes.toLocaleString('es-AR')}`;
        document.getElementById('clientesFieles').textContent = clientesFieles;
        
        // Renderizar turnos próximos - Usar los turnos filtrados
        renderProximosTurnos(turnosHoyFiltrados);
        
        // Renderizar turnos por confirmar/asistencia
        renderTurnosParaAccion(turnosHoyFiltrados);
        
    } catch (error) {
        console.error('Error al actualizar dashboard:', error);
        showNotification('Error al cargar datos del dashboard', 'error');
    }
}

function renderProximosTurnos(turnos) {
    const container = document.getElementById('proximosTurnosGrid');
    if (!container) return;
    
    if (!turnos || turnos.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 30px; color: #aaa; grid-column: 1 / -1;">
                <i class="fas fa-calendar-check fa-3x" style="margin-bottom: 15px;"></i>
                <p>No hay turnos programados para hoy</p>
            </div>
        `;
        return;
    }
    
    // Obtener la hora actual
    const ahora = new Date();
    const horaActual = ahora.getHours().toString().padStart(2, '0') + ':' + ahora.getMinutes().toString().padStart(2, '0');
    
    // Separar turnos en futuros y pasados
    const turnosFuturos = [];
    const turnosPasados = [];
    
    turnos.forEach(turno => {
        // Comparar hora del turno con hora actual
        if (turno.hora > horaActual) {
            turnosFuturos.push(turno);
        } else {
            turnosPasados.push(turno);
        }
    });
    
    // Ordenar futuros por hora ascendente (más próximo primero)
    turnosFuturos.sort((a, b) => a.hora.localeCompare(b.hora));
    
    // Ordenar pasados por hora descendente (más reciente primero)
    turnosPasados.sort((a, b) => b.hora.localeCompare(a.hora));
    
    // Combinar: futuros primero, luego pasados
    const turnosOrdenados = [...turnosFuturos, ...turnosPasados];
    
    let html = '';
    
    turnosOrdenados.forEach(turno => {
        const estadoClase = `estado-${turno.estado}`;
        const estadoTexto = getEstadoTexto(turno.estado);
        
        // Determinar si es futuro o pasado
        const esFuturo = turno.hora > horaActual;
        const esPasado = !esFuturo;
        
        // Clase CSS diferente para turnos pasados
        const claseHora = esFuturo ? 'turno-hora hoy' : 'turno-hora pasado';
        const estiloHora = esFuturo ? 'background-color: var(--primary);' : 'background-color: #666;';
        const iconoTiempo = esFuturo ? 'fas fa-clock' : 'fas fa-history';
        const textoEstadoTiempo = esFuturo ? 'PRÓXIMO' : 'PASADO';
        const estiloCard = esFuturo ? '' : 'opacity: 0.7;';
        
        html += `
            <div class="turno-card" onclick="mostrarDetallesTurno('${turno.id}')" style="${estiloCard}">
                <div class="turno-header">
                    <div class="${claseHora}" style="${estiloHora}">
                        <i class="${iconoTiempo}"></i> ${turno.hora}
                        <div style="font-size: 0.7rem; margin-top: 2px; font-weight: normal;">${textoEstadoTiempo}</div>
                    </div>
                    <div class="turno-estado ${estadoClase}">${estadoTexto}</div>
                </div>
                <div class="turno-cliente">${turno.nombre}</div>
                <div class="turno-servicio">${turno.servicio}</div>
                <div class="turno-precio">$${turno.precio}</div>
                <div class="turno-whatsapp">
                    <i class="fab fa-whatsapp"></i> ${turno.telefono || 'Sin teléfono'}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function renderTurnosParaAccion(turnos) {
    const container = document.getElementById('turnosParaAccion');
    if (!container) return;
    
    const turnosParaAccion = turnos?.filter(turno => 
        turno.estado === 'pendiente' || turno.estado === 'confirmado'
    ) || [];
    
    if (turnosParaAccion.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 30px; color: #aaa;">
                <i class="fas fa-check-circle fa-3x" style="margin-bottom: 15px;"></i>
                <p>No hay turnos pendientes de confirmar hoy</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    
}

// ========== FUNCIONES OFERTAS ==========

function calcularDescuento() {
    const precioNormal = parseFloat(document.getElementById('precioNormal').value) || 0;
    const precioOferta = parseFloat(document.getElementById('precioOferta').value) || 0;
    
    if (precioNormal <= 0 || precioOferta <= 0) return;
    
    const ahorro = precioNormal - precioOferta;
    const porcentaje = ((ahorro / precioNormal) * 100).toFixed(0);
    
    document.getElementById('descuentoCalculado').textContent = 
        `Ahorro: $${ahorro.toLocaleString('es-AR')} (${porcentaje}%)`;
    
    ofertaConfig.precioNormal = precioNormal;
    ofertaConfig.precioOferta = precioOferta;
}

function actualizarTextoDuracion() {
    const horas = parseInt(document.getElementById('duracionHoras').value) || 24;
    let texto = '';
    
    if (horas < 24) {
        texto = `${horas} horas`;
    } else if (horas === 24) {
        texto = '1 día';
    } else if (horas < 168) {
        const dias = Math.floor(horas / 24);
        texto = `${dias} día${dias > 1 ? 's' : ''}`;
    } else {
        const semanas = Math.floor(horas / 168);
        texto = `${semanas} semana${semanas > 1 ? 's' : ''}`;
    }
    
    document.getElementById('textoDuracion').textContent = texto;
    ofertaConfig.duracionHoras = horas;
}

async function loadOfertas() {
    try {
        console.log('Cargando ofertas de Firebase...');
        
        const result = await safeFirebaseQuery(
            () => db.collection('ofertas')
                .orderBy('creado_en', 'desc')
                .get(),
            'Error al cargar ofertas'
        );
        
        if (result) {
            ofertasActivas = result.docs.map(doc => ({ 
                id: doc.id, 
                ...doc.data() 
            }));
            console.log('Ofertas cargadas:', ofertasActivas.length);
            renderOfertas();
        }
        
    } catch (error) {
        console.error('Error en loadOfertas:', error);
        showNotification('Error interno al cargar ofertas', 'error');
    }
}

function verificarOfertaVigente(oferta) {
    if (!oferta.activa) return false;
    
     
    const ahora = firebase.firestore.Timestamp.now();
    
    if (oferta.tipo_duracion === 'horas') {
        if (oferta.fin) {
            // Convertir a Timestamp si es necesario
            const fin = oferta.fin instanceof firebase.firestore.Timestamp 
                ? oferta.fin 
                : firebase.firestore.Timestamp.fromDate(new Date(oferta.fin));
            
            return ahora.seconds < fin.seconds;
        }
        
        // Si no hay fecha de fin, usar duración_horas
        if (oferta.duracion_horas) {
            const inicio = oferta.creado_en ? 
                (oferta.creado_en.toDate ? oferta.creado_en.toDate() : new Date(oferta.creado_en)) : 
                new Date();
            const fin = new Date(inicio.getTime() + (oferta.duracion_horas * 60 * 60 * 1000));
            return ahora < fin;
        }
    } else if (oferta.tipo_duracion === 'rango-fecha') {
        // Para ofertas por rango de fecha
        if (oferta.fecha_fin && oferta.hora_fin) {
            const fechaHoraFin = `${oferta.fecha_fin}T${oferta.hora_fin}`;
            const fin = new Date(fechaHoraFin);
            console.log('Fin de oferta por rango:', fin, 'Ahora:', ahora, 'Vigente:', ahora < fin);
            return ahora < fin;
        } else if (oferta.fin) {
            // Si ya está guardado como objeto Date
            const fin = oferta.fin.toDate ? oferta.fin.toDate() : new Date(oferta.fin);
            return ahora < fin;
        }
    }
    
    // Si no hay datos de fin, la oferta es indefinida
    console.log('No hay datos de fin, oferta indefinida');
    return true; // Asumir vigente si no hay fecha de fin
}

async function eliminarOferta(id) {
    if (confirm('¿Estás seguro de eliminar esta oferta?\nEsta acción no se puede deshacer.')) {
        try {
            showLoading();
            await db.collection('ofertas').doc(id).delete();
            showNotification('Oferta eliminada correctamente', 'success');
            await loadOfertas();
            hideLoading();
        } catch (error) {
            console.error('Error al eliminar oferta:', error);
            showNotification('Error al eliminar la oferta', 'error');
            hideLoading();
        }
    }
}

async function cambiarEstadoOferta(id, nuevoEstado) {
    try {
        showLoading();
        await db.collection('ofertas').doc(id).update({
            activa: nuevoEstado
        });
        showNotification(`Oferta ${nuevoEstado ? 'activada' : 'desactivada'} correctamente`, 'success');
        await loadOfertas();
        hideLoading();
    } catch (error) {
        console.error('Error al cambiar estado de oferta:', error);
        showNotification('Error al cambiar estado de la oferta', 'error');
        hideLoading();
    }
}

// Función para crear una oferta de ejemplo si la tabla está vacía
async function crearOfertaEjemplo() {
    try {
        showLoading();
        
        const ofertaEjemplo = {
            nombre: "Corte Promocional",
            descripcion: "¡Oferta especial! Corte de cabello con terminaciones",
            precio_normal: 2500,
            precio_oferta: 2000,
            activa: true,
            tipo_duracion: "horas",
            duracion_horas: 48
        };
        
         await db.collection('ofertas').add(ofertaEjemplo);

        if (error) {
            console.error('Error al crear oferta de ejemplo:', error);
            
            // Si hay error, puede que la tabla no exista
            showNotification('La tabla "ofertas" no existe. Crea la tabla en Supabase primero.', 'error');
            hideLoading();
            return;
        }
        
        showNotification('Oferta de ejemplo creada', 'success');
        await loadOfertas();
        hideLoading();
        
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error al crear oferta de ejemplo', 'error');
        hideLoading();
    }
}

async function activarOferta() {
    try {
        showLoading();
        
        const nombre = document.getElementById('ofertaNombre').value;
        const descripcion = document.getElementById('ofertaDescripcion').value;
        const precioNormal = parseFloat(document.getElementById('precioNormal').value);
        const precioOferta = parseFloat(document.getElementById('precioOferta').value);
        const estadoActiva = document.querySelector('input[name="estadoOferta"][value="activa"]').checked;
        const tipoDuracion = ofertaConfig.tipoDuracion;
        
        const ofertaData = {
            nombre,
            descripcion,
            precio_normal: precioNormal,
            precio_oferta: precioOferta,
            activa: estadoActiva,
            tipo_duracion: tipoDuracion,
            creado_en: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        const ahora = new Date();
        
        if (tipoDuracion === 'horas') {
            const horas = parseInt(document.getElementById('duracionHoras').value);
            const inicio = ahora;
            const fin = new Date(ahora.getTime() + (horas * 60 * 60 * 1000));
            
            // Guardar como Timestamp de Firestore
            ofertaData.inicio = firebase.firestore.Timestamp.fromDate(inicio);
            ofertaData.fin = firebase.firestore.Timestamp.fromDate(fin);
            ofertaData.duracion_horas = horas;
            
            console.log('Oferta por horas - Inicio:', inicio, 'Fin:', fin, 'Horas:', horas);
        } else {
            const fechaInicio = document.getElementById('fechaInicioOferta').value;
            const fechaFin = document.getElementById('fechaFinOferta').value;
            const horaInicio = document.getElementById('horaInicioOferta').value;
            const horaFin = document.getElementById('horaFinOferta').value;
            
            // Guardar como strings separados
            ofertaData.fecha_inicio = fechaInicio;
            ofertaData.fecha_fin = fechaFin;
            ofertaData.hora_inicio = horaInicio;
            ofertaData.hora_fin = horaFin;
            
            // También calcular y guardar como Timestamp para facilitar comparación
            if (fechaFin && horaFin) {
                const fin = new Date(`${fechaFin}T${horaFin}`);
                ofertaData.fin = firebase.firestore.Timestamp.fromDate(fin);
            }
            
            console.log('Oferta por rango - Fecha fin:', fechaFin, 'Hora fin:', horaFin);
        }
        
        console.log('Guardando oferta:', ofertaData);
        
        await db.collection('ofertas').add(ofertaData);
        
        showNotification('Oferta activada correctamente', 'success');
        await loadOfertas();
        hideLoading();
        
    } catch (error) {
        console.error('Error al activar oferta:', error);
        showNotification('Error al activar la oferta: ' + error.message, 'error');
        hideLoading();
    }
}

async function eliminarServicio (id) {
    if (!confirm('¿Estás seguro de eliminar este servicio?')) {
        return;
    }
    try {
        showLoading();
        
        await db.collection('servicios').doc(id).delete();

        showNotification('Servicio eliminado correctamente', 'success');
        await loadServicios();
        hideLoading();

    } catch (error) {
        console.error('Error al eliminar servicio:', error);
        showNotification('Error al eliminar el servicio', 'error');
        hideLoading();
    }
}

function renderOfertas() {
    const container = document.getElementById('listaOfertas');
    if (!container) return;
    
    if (ofertasActivas.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 30px; color: #aaa;">
                <i class="fas fa-tag fa-3x" style="margin-bottom: 15px;"></i>
                <p>No hay ofertas activas</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    ofertasActivas.forEach(oferta => {
        const fechaCreacion = oferta.creado_en ? 
            (oferta.creado_en.toDate ? oferta.creado_en.toDate() : new Date(oferta.creado_en)).toLocaleDateString('es-ES') : 
            'Sin fecha';
        
        const activaBadge = oferta.activa ? 
            '<span style="background-color: var(--success); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">ACTIVA</span>' :
            '<span style="background-color: var(--error); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">INACTIVA</span>';
        
        const ahorro = oferta.precio_normal - oferta.precio_oferta;
        const porcentaje = ((ahorro / oferta.precio_normal) * 100).toFixed(0);
        
        // 🔴 CORREGIDO: Usar la función corregida
        const esVigente = verificarOfertaVigente(oferta);
        
        const vigenteBadge = esVigente ? 
            '<span style="background-color: #4caf50; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; margin-left: 5px;">VIGENTE</span>' :
            '<span style="background-color: #ff9800; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; margin-left: 5px;">NO VIGENTE</span>';
        
        // Mostrar información de duración
        let infoDuracion = '';
        if (oferta.tipo_duracion === 'horas') {
            infoDuracion = `<div><i class="fas fa-clock"></i> ${oferta.duracion_horas || 24} horas</div>`;
        } else {
            infoDuracion = `
                <div><i class="fas fa-calendar-alt"></i> ${oferta.fecha_inicio || ''} a ${oferta.fecha_fin || ''}</div>
                <div><i class="fas fa-clock"></i> ${oferta.hora_inicio || ''} - ${oferta.hora_fin || ''}</div>
            `;
        }
        
        html += `
            <div style="background-color: var(--dark); padding: 20px; border-radius: var(--border-radius); margin-bottom: 15px; border-left: 4px solid ${esVigente ? 'var(--success)' : 'var(--error)'};">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                    <div style="font-weight: bold; color: var(--primary); font-size: 1.2rem;">${oferta.nombre}</div>
                    <div style="display: flex; gap: 5px;">
                        ${activaBadge}
                        ${vigenteBadge}
                    </div>
                </div>
                
                <div style="color: #aaa; font-size: 0.9rem; margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                    ${oferta.descripcion || 'Sin descripción'}
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <div style="text-decoration: line-through; color: #666; font-size: 0.9rem;">
                            Precio normal: $${oferta.precio_normal?.toLocaleString('es-AR') || '0'}
                        </div>
                        <div style="color: var(--primary); font-weight: bold; font-size: 1.3rem;">
                            $${oferta.precio_oferta?.toLocaleString('es-AR') || '0'}
                        </div>
                    </div>
                    <div style="background-color: rgba(76, 175, 80, 0.2); color: var(--success); padding: 8px 15px; border-radius: var(--border-radius); font-size: 1rem;">
                        Ahorro ${porcentaje}%
                    </div>
                </div>
                
                <!-- Información de duración CORREGIDA -->
                <div style="color: #888; font-size: 0.85rem; margin-bottom: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <i class="fas fa-calendar-alt"></i> 
                        ${fechaCreacion}
                    </div>
                    <div>
                        ${infoDuracion}
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn-accion btn-confirmar" onclick="editarOferta('${oferta.id}')" style="flex: 1; padding: 10px; font-size: 0.9rem;">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn-accion btn-cancelar" onclick="eliminarOferta('${oferta.id}')" style="flex: 1; padding: 10px; font-size: 0.9rem;">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

async function editarOferta(id) {
    try {
        showLoading();
        const doc = await db.collection('ofertas').doc(id).get();
        
        if (doc.exists) {
            const oferta = { id: doc.id, ...doc.data() };
            
            // Cargar datos en el formulario
            document.getElementById('ofertaNombre').value = oferta.nombre;
            document.getElementById('ofertaDescripcion').value = oferta.descripcion;
            document.getElementById('precioNormal').value = oferta.precio_normal;
            document.getElementById('precioOferta').value = oferta.precio_oferta;
            
            // Configurar tipo de duración
            if (oferta.tipo_duracion === 'horas') {
                document.querySelector('.opcion-duracion[data-tipo="horas"]').click();
                document.getElementById('duracionHoras').value = oferta.duracion_horas || 24;
            } else {
                document.querySelector('.opcion-duracion[data-tipo="rango-fecha"]').click();
                if (oferta.fecha_inicio) document.getElementById('fechaInicioOferta').value = oferta.fecha_inicio;
                if (oferta.fecha_fin) document.getElementById('fechaFinOferta').value = oferta.fecha_fin;
                if (oferta.hora_inicio) document.getElementById('horaInicioOferta').value = oferta.hora_inicio;
                if (oferta.hora_fin) document.getElementById('horaFinOferta').value = oferta.hora_fin;
            }
            
            // Configurar estado
            document.querySelector(`input[name="estadoOferta"][value="${oferta.activa ? 'activa' : 'inactiva'}"]`).checked = true;
            
            // Guardar ID para actualizar
            ofertaConfig.id = id;
            
            // Cambiar texto del botón
            document.getElementById('activarOferta').innerHTML = '<i class="fas fa-save"></i> Actualizar Oferta';
            
            showNotification('Oferta cargada para editar', 'info');
            
            // Desplazar a la sección de configuración
            document.getElementById('activarOferta').scrollIntoView({ behavior: 'smooth' });
        }
        
        hideLoading();
    } catch (error) {
        console.error('Error al cargar oferta:', error);
        showNotification('Error al cargar la oferta', 'error');
        hideLoading();
    }
}

function mostrarVistaPreviaOferta() {
    const nombre = document.getElementById('ofertaNombre').value;
    const descripcion = document.getElementById('ofertaDescripcion').value;
    const precioNormal = parseFloat(document.getElementById('precioNormal').value);
    const precioOferta = parseFloat(document.getElementById('precioOferta').value);
    
    const ahorro = precioNormal - precioOferta;
    const porcentaje = ((ahorro / precioNormal) * 100).toFixed(0);
    
    const html = `
        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, var(--dark), var(--darker)); border-radius: var(--border-radius); border: 2px solid var(--primary); max-width: 400px; margin: 0 auto;">
            <div style="background-color: var(--primary); color: var(--dark); padding: 10px; border-radius: var(--border-radius) var(--border-radius) 0 0; font-weight: bold; font-size: 1.2rem; margin: -20px -20px 20px -20px;">
                VISTA PREVIA
            </div>
            <h3 style="color: var(--primary); margin-bottom: 10px;">${nombre}</h3>
            <p style="color: #aaa; margin-bottom: 20px;">${descripcion}</p>
            <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px;">
                <div style="text-align: center;">
                    <div style="color: #666; font-size: 0.9rem;">Precio normal</div>
                    <div style="text-decoration: line-through; font-size: 1.2rem;">$${precioNormal.toLocaleString('es-AR')}</div>
                </div>
                <div style="font-size: 1.5rem; color: #aaa;">→</div>
                <div style="text-align: center;">
                    <div style="color: var(--success); font-size: 0.9rem; font-weight: bold;">PRECIO OFERTA</div>
                    <div style="font-size: 1.8rem; color: var(--primary); font-weight: bold;">$${precioOferta.toLocaleString('es-AR')}</div>
                </div>
            </div>
            <div style="background-color: rgba(76, 175, 80, 0.2); color: var(--success); padding: 10px; border-radius: var(--border-radius); font-weight: bold;">
                ¡AHORRÁ $${ahorro.toLocaleString('es-AR')} (${porcentaje}%)!
            </div>
        </div>
    `;
    
    alert(html.replace(/(<([^>]+)>)/gi, ""));
}

// ========== FUNCIONES MÉTRICAS ==========

async function loadMetricas() {
    try {
        showLoading();
        
        const mes = parseInt(document.getElementById('filtroMesMetricas').value);
        const anio = parseInt(document.getElementById('filtroAnioMetricas').value);
        const tipoComparacion = document.getElementById('filtroComparar').value;
        
        const primerDiaMes = `${anio}-${String(mes).padStart(2, '0')}-01`;
        const ultimoDiaMes = `${anio}-${String(mes).padStart(2, '0')}-31`;
        
        document.getElementById('mesMetricasTexto').textContent = 
            `${new Date(anio, mes-1, 1).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}`;
        
        // Cargar turnos del mes desde Firebase
        const turnosSnapshot = await db.collection('turnos')
            .where('fecha', '>=', primerDiaMes)
            .where('fecha', '<=', ultimoDiaMes)
            .get();
        
        const turnosMes = turnosSnapshot.docs.map(doc => ({ 
            id: doc.id, 
            ...doc.data() 
        }));
        
        const turnosAsistieron = turnosMes.filter(t => t.estado === 'asistio');
        const turnosCancelados = turnosMes.filter(t => t.estado === 'cancelado');
        
        const ingresosTotales = turnosAsistieron.reduce((sum, t) => sum + (t.precio || 0), 0);
        const clientesUnicos = new Set(turnosAsistieron.map(t => t.nombre)).size;
        const tasaAsistencia = turnosMes.length > 0 ? 
            Math.round((turnosAsistieron.length / turnosMes.length) * 100) : 0;
        const tasaCancelacion = turnosMes.length > 0 ? 
            Math.round((turnosCancelados.length / turnosMes.length) * 100) : 0;
        
        document.getElementById('tasaAsistencia').textContent = `${tasaAsistencia}%`;
        document.getElementById('tasaCancelacion').textContent = `${tasaCancelacion}%`;
        
        const resumenMetricas = document.getElementById('resumenMetricas');
        if (resumenMetricas) {
            resumenMetricas.innerHTML = `
                <div class="metrica-resumen">
                    <i class="fas fa-calendar-check fa-2x"></i>
                    <div class="metrica-valor">${turnosMes.length}</div>
                    <div class="stat-label">Total Turnos</div>
                    <div class="metrica-tendencia tendencia-neutral">Sin comparación</div>
                </div>
                <div class="metrica-resumen">
                    <i class="fas fa-money-bill-wave fa-2x"></i>
                    <div class="metrica-valor">$${ingresosTotales.toLocaleString('es-AR')}</div>
                    <div class="stat-label">Ingresos Totales</div>
                    <div class="metrica-tendencia tendencia-neutral">Sin comparación</div>
                </div>
                <div class="metrica-resumen">
                    <i class="fas fa-users fa-2x"></i>
                    <div class="metrica-valor">${clientesUnicos}</div>
                    <div class="stat-label">Clientes Únicos</div>
                    <div class="metrica-tendencia tendencia-neutral">Sin comparación</div>
                </div>
                <div class="metrica-resumen">
                    <i class="fas fa-percentage fa-2x"></i>
                    <div class="metrica-valor">${tasaAsistencia}%</div>
                    <div class="stat-label">Asistencia</div>
                    <div class="metrica-tendencia tendencia-neutral">Sin comparación</div>
                </div>
            `;
        }
        
        await renderTablaTurnosMes(turnosMes);
        await renderTopClientes(turnosAsistieron);
        await renderGraficosMetricas(turnosMes, turnosAsistieron);
        
        hideLoading();
    } catch (error) {
        console.error('Error al cargar métricas:', error);
        showNotification('Error al cargar las métricas', 'error');
        hideLoading();
    }
}

// Si necesitas configurar horarios bloqueados, crea una función:
async function configurarHorariosBloqueados() {
    const horariosBloqueados = {
        "2026-01-29": ["05:00", "17:00", "18:00", "19:00"],
        "2026-01-30": "all"
    };

    try {
        await db.collection('configuracion').doc('horariosBloqueados').set({
            horariosBloqueados: horariosBloqueados
        });
        showNotification('Horarios bloqueados configurados', 'success');
    } catch (error) {
        console.error('Error al configurar horarios bloqueados:', error);
        showNotification('Error al configurar horarios bloqueados', 'error');
    }
}

function validarHoraCompleta(hora) {
    if (!hora) return '00:00';
    
    // Si ya es hora completa (00 minutos), dejarla igual
    if (hora.endsWith(':00')) {
        return hora;
    }
    
    // Si tiene minutos, redondear a la hora siguiente
    const [h, m] = hora.split(':').map(Number);
    if (m > 0) {
        return `${(h + 1).toString().padStart(2, '0')}:00`;
    }
    
    return `${h.toString().padStart(2, '0')}:00`;
}

async function renderTablaTurnosMes(turnos) {
    const tbody = document.getElementById('tablaTurnosMesBody');
    if (!tbody) return;
    
    if (!turnos || turnos.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 30px; color: #aaa;">
                    <i class="fas fa-calendar-times fa-3x" style="margin-bottom: 15px;"></i>
                    <p>No hay turnos en este período</p>
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    
    turnos.sort((a, b) => new Date(b.fecha + 'T' + b.hora) - new Date(a.fecha + 'T' + a.hora))
          .slice(0, 50)
          .forEach(turno => {
        const fechaObj = parseDateInput(turno.fecha);
        const fechaFormateada = fechaObj.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
        
        const estadoClase = `estado-${turno.estado}`;
        const estadoTexto = getEstadoTexto(turno.estado);
        
        html += `
            <tr>
                <td>${fechaFormateada} ${turno.hora}</td>
                <td>${turno.nombre}</td>
                <td>${turno.servicio}</td>
                <td>$${turno.precio}</td>
                <td><span class="badge-estado ${estadoClase}">${estadoTexto}</span></td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// MODIFICAR la función de cambiar estado para aplicar sistema de fidelidad
AdminApp.cambiarEstadoTurno = async function(id, nuevoEstado) {
    try {
        showLoading();
        
        const turnoDoc = await db.collection('turnos').doc(id).get();
        const turno = { id: turnoDoc.id, ...turnoDoc.data() };
        
        // Verificar si es turno gratis antes de cambiar estado
        const fidelidadInfo = await verificarYActualizarFidelidad(id, turno.telefono);
        let precioFinal = turno.precio;
        
        if (nuevoEstado === 'asistio' && fidelidadInfo.esTurnoGratis && configFidelidad.activa) {
            // Si es turno gratis, cambiar precio a 0
            precioFinal = 0;
            
            // Agregar nota en el turno
            const notas = turno.notas || '';
            const nuevaNota = `[TURNO GRATIS - Programa de Fidelidad] ${turno.nombre} completó ${fidelidadInfo.totalAsistidos} turnos.`;
            
            await db.collection('turnos').doc(id).update({
                estado: nuevoEstado,
                precio: precioFinal,
                precio_original: turno.precio, // Guardar precio original
                notas: notas ? `${notas}\n${nuevaNota}` : nuevaNota,
                turno_gratis_fidelidad: true,
                actualizado_en: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showNotification(`¡TURNO GRATIS APLICADO! ${turno.nombre} ha completado ${fidelidadInfo.totalAsistidos} turnos`, 'success');
            
            // Lanzar confeti
            confetti({
                particleCount: 200,
                spread: 100,
                origin: { y: 0.6 },
                colors: ['#00ff00', '#4caf50', '#ffeb3b', '#d4af37']
            });
            
        } else {
            // Actualizar normal
            await db.collection('turnos').doc(id).update({
                estado: nuevoEstado,
                actualizado_en: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        // Verificar si ahora es próximo gratis
        if (nuevoEstado === 'asistio') {
            const nuevaFidelidad = await verificarYActualizarFidelidad(id, turno.telefono);
            
            if (nuevaFidelidad.esProximoGratis && configFidelidad.activa) {
                showNotification(`¡${turno.nombre} ahora tiene el próximo turno GRATIS!`, 'success');
            }
        }
        
        showNotification(`Turno actualizado a: ${getEstadoTexto(nuevoEstado)}${precioFinal === 0 ? ' (GRATIS)' : ''}`, 'success');
        
        // Actualizar vistas
        await updateDashboard();
        await loadTurnos();
        await cargarGridHorarios();
        
        // Cerrar modal si está abierto
        AdminApp.cerrarModalDetalle();
        
        hideLoading();
        
    } catch (error) {
        console.error('Error al cambiar estado:', error);
        showNotification('Error al actualizar el turno', 'error');
        hideLoading();
    }
};    

// Cargar servicios adicionales desde Firebase
async function cargarServiciosAdicionales() {
    try {
        console.log('Cargando servicios adicionales...');
        
        const result = await safeFirebaseQuery(
            () => db.collection('servicios_adicionales')
                .orderBy('nombre')
                .get(),
            'Error al cargar servicios adicionales'
        );
        
        if (result) {
            serviciosAdicionalesData = result.docs.map(doc => ({ 
                id: doc.id, 
                ...doc.data() 
            }));
            console.log('Servicios adicionales cargados:', serviciosAdicionalesData.length);
            
            // Actualizar lista en la sección de servicios
            renderServiciosAdicionalesAdmin();
        }
        
    } catch (error) {
        console.error('Error en cargarServiciosAdicionales:', error);
        // Si la colección no existe, crear un servicio de ejemplo
        if (error.code === 'not-found' || error.message.includes('not-found')) {
            console.log('Creando colección de servicios adicionales...');
            await crearServicioAdicionalEjemplo();
        }
    }
}

// Crear un servicio adicional de ejemplo
async function crearServicioAdicionalEjemplo() {
    try {
        showLoading();
        
        const servicioEjemplo = {
            nombre: "Gaseosa 500ml",
            precio: 800,
            activo: true,
            creado_en: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('servicios_adicionales').add(servicioEjemplo);
        
        showNotification('Servicio adicional de ejemplo creado', 'success');
        await cargarServiciosAdicionales();
        hideLoading();
        
    } catch (error) {
        console.error('Error al crear servicio de ejemplo:', error);
        showNotification('Error al crear servicio adicional', 'error');
        hideLoading();
    }
}

// Renderizar lista de servicios adicionales en la sección de servicios
function renderServiciosAdicionalesAdmin() {
    const container = document.getElementById('listaServiciosAdmin');
    if (!container) return;
    
    if (serviciosAdicionalesData.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #aaa; grid-column: 1 / -1;">
                <i class="fas fa-plus-circle fa-3x" style="margin-bottom: 15px;"></i>
                <p>No hay servicios adicionales configurados</p>
                <button class="btn-accion btn-confirmar" onclick="abrirModalNuevoServicio()" style="margin-top: 15px;">
                    <i class="fas fa-plus"></i> Agregar el primero
                </button>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    serviciosAdicionalesData.forEach(servicio => {
        html += `
            <div class="card-servicio-adicional">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: var(--light); margin-bottom: 5px;">
                            ${servicio.nombre}
                        </div>
                        <div style="color: var(--primary); font-weight: bold; font-size: 1.2rem;">
                            $${servicio.precio.toLocaleString('es-AR')}
                        </div>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <span style="background-color: ${servicio.activo ? 'var(--success)' : 'var(--error)'}; 
                               color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.7rem;">
                            ${servicio.activo ? 'ACTIVO' : 'INACTIVO'}
                        </span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn-accion btn-confirmar" onclick="editarServicioAdicional('${servicio.id}')" style="flex: 1; padding: 5px 10px; font-size: 0.8rem;">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn-eliminar-servicio" onclick="eliminarServicioAdicional('${servicio.id}')">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Abrir modal para nuevo servicio adicional
function abrirModalNuevoServicio() {
    const modal = document.getElementById('modalNuevoServicioAdicional');
    const overlay = document.getElementById('overlayServiciosAdicionales');
    
    if (modal && overlay) {
        // Resetear formulario
        const form = document.getElementById('formNuevoServicioAdicional');
        if (form) form.reset();
        
        // Mostrar modal
        modal.classList.add('active');
        overlay.classList.add('active');
    }
}

// Cerrar modal nuevo servicio
function cerrarModalNuevoServicio() {
    const modal = document.getElementById('modalNuevoServicioAdicional');
    const overlay = document.getElementById('overlayServiciosAdicionales');
    
    if (modal && overlay) {
        modal.classList.remove('active');
        overlay.classList.remove('active');
    }
}

// Guardar nuevo servicio adicional
async function guardarNuevoServicioAdicional(e) {
    e.preventDefault();
    
    try {
        showLoading();
        
        const nombre = document.getElementById('nombreServicioAdicional').value;
        const precio = parseFloat(document.getElementById('precioServicioAdicional').value);
        
        if (!nombre || !precio || isNaN(precio)) {
            showNotification('Nombre y precio son requeridos', 'error');
            hideLoading();
            return;
        }
        
        const servicioData = {
            nombre,
            precio,
            activo: true,
            creado_en: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('servicios_adicionales').add(servicioData);
        
        showNotification('Servicio adicional guardado correctamente', 'success');
        
        // Actualizar lista
        await cargarServiciosAdicionales();
        
        // Cerrar modal
        cerrarModalNuevoServicio();
        hideLoading();
        
    } catch (error) {
        console.error('Error al guardar servicio adicional:', error);
        showNotification('Error al guardar servicio: ' + error.message, 'error');
        hideLoading();
    }
}

// Eliminar servicio adicional
async function eliminarServicioAdicional(id) {
    if (!confirm('¿Estás seguro de eliminar este servicio adicional?\nEsta acción no se puede deshacer.')) {
        return;
    }
    
    try {
        showLoading();
        
        await db.collection('servicios_adicionales').doc(id).delete();
        
        showNotification('Servicio adicional eliminado', 'success');
        await cargarServiciosAdicionales();
        hideLoading();
        
    } catch (error) {
        console.error('Error al eliminar servicio adicional:', error);
        showNotification('Error al eliminar servicio', 'error');
        hideLoading();
    }
}

// Editar servicio adicional
async function editarServicioAdicional(id) {
    try {
        const doc = await db.collection('servicios_adicionales').doc(id).get();
        
        if (doc.exists) {
            const servicio = { id: doc.id, ...doc.data() };
            
            // Cargar en formulario
            document.getElementById('nombreServicioAdicional').value = servicio.nombre;
            document.getElementById('precioServicioAdicional').value = servicio.precio;
            
            // Abrir modal
            abrirModalNuevoServicio();
            
            // Cambiar texto del botón
            const form = document.getElementById('formNuevoServicioAdicional');
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Actualizar Servicio';
                submitBtn.setAttribute('data-edit-id', id);
                
                // Cambiar evento
                form.onsubmit = async function(e) {
                    e.preventDefault();
                    await actualizarServicioAdicional(id);
                };
            }
        }
        
    } catch (error) {
        console.error('Error al cargar servicio adicional:', error);
        showNotification('Error al cargar servicio', 'error');
    }
}

// Actualizar servicio adicional
async function actualizarServicioAdicional(id) {
    try {
        showLoading();
        
        const nombre = document.getElementById('nombreServicioAdicional').value;
        const precio = parseFloat(document.getElementById('precioServicioAdicional').value);
        
        if (!nombre || !precio || isNaN(precio)) {
            showNotification('Nombre y precio son requeridos', 'error');
            hideLoading();
            return;
        }
        
        await db.collection('servicios_adicionales').doc(id).update({
            nombre,
            precio,
            actualizado_en: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification('Servicio actualizado correctamente', 'success');
        
        // Actualizar lista
        await cargarServiciosAdicionales();
        
        // Cerrar modal y resetear formulario
        cerrarModalNuevoServicio();
        const form = document.getElementById('formNuevoServicioAdicional');
        if (form) {
            form.reset();
            form.onsubmit = guardarNuevoServicioAdicional;
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Guardar Servicio';
                submitBtn.removeAttribute('data-edit-id');
            }
        }
        
        hideLoading();
        
    } catch (error) {
        console.error('Error al actualizar servicio adicional:', error);
        showNotification('Error al actualizar servicio: ' + error.message, 'error');
        hideLoading();
    }
}

// ========== HERRAMIENTA SIMPLIFICADA DE NOTIFICACIONES ==========

// Variable global para almacenar turnos afectados
let turnosAfectadosCache = [];

// Función para agregar turno a la lista de afectados
async function agregarTurnoAfectado(turnoId, razon) {
    try {
        // Obtener datos del turno
        const turnoDoc = await db.collection('turnos').doc(turnoId).get();
        if (!turnoDoc.exists) return;
        
        const turno = { id: turnoDoc.id, ...turnoDoc.data() };
        
        // Verificar si ya está en la lista
        const existe = turnosAfectadosCache.find(t => t.id === turnoId);
        if (existe) return;
        
        // Agregar a la lista
        turnosAfectadosCache.push({
            ...turno,
            razon: razon,
            notificado: false,
            fecha_deteccion: new Date().toISOString()
        });
        
        // Actualizar la UI
        actualizarListaTurnosAfectados();
        
        // Mostrar notificación
        showNotification(`Turno de ${turno.nombre} agregado a la lista de notificación`, 'warning');
        
    } catch (error) {
        console.error('Error al agregar turno afectado:', error);
    }
}

// Función para actualizar la lista visual
function actualizarListaTurnosAfectados() {
    const container = document.getElementById('listaTurnosAfectados');
    if (!container) return;
    
    if (turnosAfectadosCache.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #aaa;">
                <i class="fas fa-bell-slash fa-2x" style="margin-bottom: 10px;"></i>
                <p>No hay turnos afectados por cambios recientes</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    turnosAfectadosCache.forEach((turno, index) => {
        const fechaObj = new Date(turno.fecha + 'T' + turno.hora);
        const fechaFormateada = fechaObj.toLocaleDateString('es-ES', {
            weekday: 'short',
            day: 'numeric',
            month: 'short'
        });
        
        html += `
            <div class="turno-afectado-item" onclick="mostrarOpcionesNotificacion('${turno.id}', ${index})">
                <div class="turno-afectado-info">
                    <div class="turno-afectado-fecha">${fechaFormateada} • ${turno.hora}</div>
                    <div class="turno-afectado-cliente">${turno.nombre}</div>
                    <div style="color: var(--warning); font-size: 0.8rem; margin-top: 3px;">
                        <i class="fas fa-exclamation-triangle"></i> ${turno.razon}
                    </div>
                </div>
                <div>
                    ${turno.notificado ? 
                        '<span style="color: var(--success); font-size: 0.8rem;"><i class="fas fa-check-circle"></i> Notificado</span>' : 
                        `<button class="btn-whatsapp-directo" onclick="notificarTurnoIndividual('${turno.id}', event)">
                            <i class="fab fa-whatsapp"></i> Notificar
                        </button>`
                    }
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Actualizar badge en el botón de agenda si existe
    const navBtnAgenda = document.querySelector('.nav-btn[data-section="agenda"]');
    if (navBtnAgenda) {
        let badge = navBtnAgenda.querySelector('.notificacion-badge');
        if (!badge) {
            badge = document.createElement('span');
            badge.className = 'notificacion-badge';
            navBtnAgenda.appendChild(badge);
        }
        badge.textContent = turnosAfectadosCache.length;
        badge.style.display = turnosAfectadosCache.length > 0 ? 'flex' : 'none';
    }
}

// MODIFICAR la función guardarConfiguracionDia para usar la nueva herramienta
async function guardarConfiguracionDia() {
    try {
        if (!fechaSeleccionadaAgenda) {
            showNotification('Selecciona un día primero', 'error');
            return;
        }
        
        showLoading();

        const estadoActivo = document.querySelector('input[name="estadoDia"][value="activo"]').checked;
        const horaInicio = document.getElementById('horaInicio').value;
        const horaFin = document.getElementById('horaFin').value;
        
        const descansos = [];
        document.querySelectorAll('#descansosContainer .descanso-item input').forEach(input => {
            if (input.value) descansos.push(input.value);
        });
        
        const opcionRepeticion = document.querySelector('.opcion-repeticion.active')?.dataset.repeticion || 'unico';
        
        // Obtener configuración anterior para comparar
        const configAnterior = horariosAgenda[fechaSeleccionadaAgenda] || {};
        
        // Nueva configuración
        const configData = {
            fecha: fechaSeleccionadaAgenda,
            activo: estadoActivo,
            hora_inicio: horaInicio,
            hora_fin: horaFin,
            descansos: descansos,
            tipo: 'configuracion_agenda',
            duracion_cita: 60,
            actualizado_en: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // 1. Guardar la configuración primero
        await db.collection('horarios_agenda').doc(fechaSeleccionadaAgenda).set(configData);
        
        // 2. Sincronizar con calendario de usuario
        await db.collection('calendario_usuario').doc(fechaSeleccionadaAgenda).set(configData);
        
        // 3. Actualizar cache local
        horariosAgenda[fechaSeleccionadaAgenda] = configData;
        
        // 4. Aplicar repetición si es necesario
        if (opcionRepeticion !== 'unico') {
            await aplicarConfiguracionRepetida(configData, opcionRepeticion);
        }
        
        // 5. Verificar turnos afectados
        const turnosAfectados = await verificarTurnosAfectados(fechaSeleccionadaAgenda, configAnterior, configData);
        
        if (turnosAfectados.length > 0) {
            // Agregar cada turno afectado a la lista
            turnosAfectados.forEach(turno => {
                agregarTurnoAfectado(turno.id, turno.razon);
            });
            
            showNotification(`Configuración guardada. ${turnosAfectados.length} turno(s) afectado(s) agregados a la lista de notificación.`, 'warning');
        } else {
            showNotification('Configuración guardada correctamente', 'success');
        }
        
        // 6. Actualizar calendario
        generarCalendarioAgenda();
        
        hideLoading();
        
    } catch (error) {
        console.error('Error al guardar configuración:', error);
        showNotification('Error al guardar: ' + error.message, 'error');
        hideLoading();
    }
}

// Función simplificada para verificar turnos afectados
async function verificarTurnosAfectados(fecha, configAnterior, configNueva) {
    try {
        const querySnapshot = await db.collection('turnos')
            .where('fecha', '==', fecha)
            .where('estado', 'in', ['pendiente', 'confirmado'])
            .get();
        
        const turnos = querySnapshot.docs.map(doc => ({ 
            id: doc.id, 
            ...doc.data() 
        }));
        
        const turnosAfectados = [];
        
        turnos.forEach(turno => {
            let afectado = false;
            let razon = '';
            
            // Si el día se inhabilitó
            if (configAnterior.activo && !configNueva.activo) {
                afectado = true;
                razon = 'Día inhabilitado';
            }
            // Si cambió el horario y el turno está fuera del nuevo horario
            else if (configNueva.activo) {
                const horaTurno = turno.hora;
                const nuevaInicio = configNueva.hora_inicio;
                const nuevaFin = configNueva.hora_fin;
                
                if (horaTurno < nuevaInicio || horaTurno > nuevaFin) {
                    afectado = true;
                    razon = `Fuera del nuevo horario (${nuevaInicio} - ${nuevaFin})`;
                }
                // Si el turno cae en un nuevo horario de descanso
                else if (configNueva.descansos && configNueva.descansos.includes(horaTurno)) {
                    afectado = true;
                    razon = 'Horario de descanso';
                }
            }
            
            if (afectado) {
                turnosAfectados.push({
                    ...turno,
                    razon: razon
                });
            }
        });
        
        return turnosAfectados;
        
    } catch (error) {
        console.error('Error al verificar turnos afectados:', error);
        return [];
    }
}

// Función para notificar un turno individual
async function notificarTurnoIndividual(turnoId, event) {
    if (event) event.stopPropagation();
    
    try {
        const turno = turnosAfectadosCache.find(t => t.id === turnoId);
        if (!turno) return;
        
        // Mensaje predeterminado
        const mensaje = `Hola ${turno.nombre.split(' ')[0]}, lamentamos informarte que tu turno del ${new Date(turno.fecha + 'T' + turno.hora).toLocaleDateString('es-ES', { 
            weekday: 'long', 
            day: 'numeric', 
            month: 'long' 
        })} a las ${turno.hora} necesita ser reagendado debido a un cambio en nuestros horarios. 

Por favor, selecciona un nuevo horario disponible en nuestro sitio web.

¡Disculpas por las molestias!`;
        
        // Preparar número de WhatsApp
        if (turno.telefono) {
            const telefonoLimpio = turno.telefono.replace(/\D/g, '');
            const telefonoWhatsapp = telefonoLimpio.startsWith('54') ? 
                `+${telefonoLimpio}` : `+54${telefonoLimpio}`;
            
            const urlWhatsApp = `https://wa.me/${telefonoWhatsapp}?text=${encodeURIComponent(mensaje)}`;
            
            // Abrir WhatsApp en nueva pestaña
            window.open(urlWhatsApp, '_blank');
            
            // Marcar como notificado
            turno.notificado = true;
            turno.fecha_notificacion = new Date().toISOString();
            
            // Actualizar lista
            actualizarListaTurnosAfectados();
            
            // Guardar en historial
            await guardarEnHistorialNotificaciones(turno, mensaje);
            
            showNotification(`WhatsApp abierto para ${turno.nombre}`, 'success');
        } else {
            showNotification(`${turno.nombre} no tiene teléfono registrado`, 'error');
        }
        
    } catch (error) {
        console.error('Error al notificar turno:', error);
        showNotification('Error al abrir WhatsApp', 'error');
    }
}

// Función para notificar todos los turnos
async function notificarTodosLosTurnos() {
    if (turnosAfectadosCache.length === 0) {
        showNotification('No hay turnos para notificar', 'info');
        return;
    }
    
    if (!confirm(`¿Notificar a ${turnosAfectadosCache.length} cliente(s)? Se abrirá WhatsApp para cada uno.`)) {
        return;
    }
    
    try {
        let notificados = 0;
        let errores = 0;
        
        for (const turno of turnosAfectadosCache.filter(t => !t.notificado)) {
            try {
                await notificarTurnoIndividual(turno.id);
                notificados++;
                
                // Pequeña pausa para no saturar
                await new Promise(resolve => setTimeout(resolve, 500));
                
            } catch (error) {
                errores++;
                console.error(`Error notificando a ${turno.nombre}:`, error);
            }
        }
        
        showNotification(`Notificaciones enviadas: ${notificados} exitosas, ${errores} errores`, 
                       notificados > 0 ? 'success' : 'error');
        
    } catch (error) {
        console.error('Error en notificarTodosLosTurnos:', error);
        showNotification('Error al notificar todos los turnos', 'error');
    }
}

// Función para mostrar opciones de notificación
function mostrarOpcionesNotificacion(turnoId, index) {
    const turno = turnosAfectadosCache[index];
    if (!turno) return;
    
    const opcionesHTML = `
        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                   background-color: var(--gray); padding: 20px; border-radius: var(--border-radius);
                   border: 2px solid var(--primary); z-index: 10001; max-width: 400px; width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: var(--primary);">
                    <i class="fab fa-whatsapp"></i> Notificar a ${turno.nombre}
                </h3>
                <button class="btn-eliminar-descanso" onclick="cerrarModalOpciones()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div style="margin-bottom: 15px;">
                <div style="color: var(--light); margin-bottom: 5px;">
                    <strong>Fecha:</strong> ${new Date(turno.fecha + 'T' + turno.hora).toLocaleDateString('es-ES', { 
                        weekday: 'long', 
                        day: 'numeric', 
                        month: 'long' 
                    })}
                </div>
                <div style="color: var(--light); margin-bottom: 5px;">
                    <strong>Hora:</strong> ${turno.hora}
                </div>
                <div style="color: var(--warning); margin-bottom: 15px;">
                    <strong>Razón:</strong> ${turno.razon}
                </div>
            </div>
            
            <div class="form-group">
                <label for="mensajePersonalizado">Mensaje personalizado:</label>
                <textarea id="mensajePersonalizado" class="form-control" rows="4">
Hola ${turno.nombre.split(' ')[0]}, lamentamos informarte que tu turno del ${new Date(turno.fecha + 'T' + turno.hora).toLocaleDateString('es-ES', { 
    weekday: 'long', 
    day: 'numeric', 
    month: 'long' 
})} a las ${turno.hora} necesita ser reagendado debido a un cambio en nuestros horarios. 

Por favor, selecciona un nuevo horario disponible en nuestro sitio web.

¡Disculpas por las molestias!
                </textarea>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-whatsapp-directo" onclick="enviarNotificacionPersonalizada('${turnoId}', ${index})" style="flex: 1; padding: 10px;">
                    <i class="fab fa-whatsapp"></i> Enviar WhatsApp
                </button>
                <button class="btn-accion btn-cancelar" onclick="marcarComoNotificado('${turnoId}', ${index})" style="flex: 1;">
                    <i class="fas fa-check"></i> Marcar como Notificado
                </button>
            </div>
        </div>
        <div class="overlay active" onclick="cerrarModalOpciones()"></div>
    `;
    
    // Agregar al DOM
    const div = document.createElement('div');
    div.innerHTML = opcionesHTML;
    div.id = 'modalOpcionesNotificacion';
    document.body.appendChild(div);
}

// Función para enviar notificación personalizada
async function enviarNotificacionPersonalizada(turnoId, index) {
    try {
        const mensaje = document.getElementById('mensajePersonalizado').value;
        const turno = turnosAfectadosCache[index];
        
        if (!turno.telefono) {
            showNotification(`${turno.nombre} no tiene teléfono registrado`, 'error');
            return;
        }
        
        const telefonoLimpio = turno.telefono.replace(/\D/g, '');
        const telefonoWhatsapp = telefonoLimpio.startsWith('54') ? 
            `+${telefonoLimpio}` : `+54${telefonoLimpio}`;
        
        const urlWhatsApp = `https://wa.me/${telefonoWhatsapp}?text=${encodeURIComponent(mensaje)}`;
        
        // Abrir WhatsApp
        window.open(urlWhatsApp, '_blank');
        
        // Marcar como notificado
        turno.notificado = true;
        turno.fecha_notificacion = new Date().toISOString();
        turno.mensaje_enviado = mensaje;
        
        // Actualizar lista
        actualizarListaTurnosAfectados();
        
        // Guardar en historial
        await guardarEnHistorialNotificaciones(turno, mensaje);
        
        // Cerrar modal
        cerrarModalOpciones();
        
        showNotification(`WhatsApp abierto para ${turno.nombre}`, 'success');
        
    } catch (error) {
        console.error('Error al enviar notificación personalizada:', error);
        showNotification('Error al abrir WhatsApp', 'error');
    }
}

// Función para marcar como notificado sin enviar WhatsApp
async function marcarComoNotificado(turnoId, index) {
    const turno = turnosAfectadosCache[index];
    turno.notificado = true;
    turno.fecha_notificacion = new Date().toISOString();
    turno.mensaje_enviado = 'Marcado manualmente sin notificar';
    
    // Actualizar lista
    actualizarListaTurnosAfectados();
    
    // Guardar en historial
    await guardarEnHistorialNotificaciones(turno, 'Marcado manualmente');
    
    // Cerrar modal
    cerrarModalOpciones();
    
    showNotification(`${turno.nombre} marcado como notificado`, 'info');
}

// Función para cerrar modal de opciones
function cerrarModalOpciones() {
    const modal = document.getElementById('modalOpcionesNotificacion');
    if (modal) modal.remove();
    
    const overlay = document.querySelector('.overlay.active');
    if (overlay) overlay.remove();
}

// Función para guardar en historial
async function guardarEnHistorialNotificaciones(turno, mensaje) {
    try {
        await db.collection('historial_notificaciones').add({
            turno_id: turno.id,
            cliente: turno.nombre,
            telefono: turno.telefono,
            fecha_turno: turno.fecha,
            hora_turno: turno.hora,
            razon: turno.razon,
            mensaje: mensaje,
            fecha_notificacion: new Date().toISOString(),
            estado: 'enviado',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (error) {
        console.error('Error al guardar en historial:', error);
    }
}

// Función para ver historial (simplificada)
async function verHistorialNotificaciones() {
    try {
        const querySnapshot = await db.collection('historial_notificaciones')
            .orderBy('timestamp', 'desc')
            .limit(20)
            .get();
        
        if (querySnapshot.empty) {
            showNotification('No hay historial de notificaciones', 'info');
            return;
        }
        
        let historialHTML = `
            <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                       background-color: var(--gray); padding: 20px; border-radius: var(--border-radius);
                       border: 2px solid var(--primary); z-index: 10001; max-width: 500px; width: 90%;
                       max-height: 70vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: var(--primary);">
                        <i class="fas fa-history"></i> Historial de Notificaciones
                    </h3>
                    <button class="btn-eliminar-descanso" onclick="cerrarModalHistorial()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
        `;
        
        querySnapshot.docs.forEach(doc => {
            const notif = doc.data();
            const fecha = notif.timestamp ? 
                (notif.timestamp.toDate ? notif.timestamp.toDate() : new Date(notif.timestamp)) : 
                new Date();
            
            historialHTML += `
                <div style="background-color: var(--dark); padding: 12px; border-radius: var(--border-radius); 
                           margin-bottom: 10px; border-left: 4px solid var(--success);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <div style="font-weight: bold; color: var(--light);">${notif.cliente}</div>
                        <div style="color: #aaa; font-size: 0.8rem;">
                            ${fecha.toLocaleDateString('es-ES', { 
                                day: 'numeric', 
                                month: 'short', 
                                hour: '2-digit',
                                minute: '2-digit'
                            })}
                        </div>
                    </div>
                    <div style="color: #aaa; font-size: 0.85rem; margin-bottom: 3px;">
                        ${notif.fecha_turno} • ${notif.hora_turno}
                    </div>
                    <div style="color: var(--warning); font-size: 0.8rem; margin-bottom: 5px;">
                        <i class="fas fa-exclamation-triangle"></i> ${notif.razon}
                    </div>
                    <div style="color: #888; font-size: 0.8rem; margin-top: 8px; padding-top: 8px; 
                               border-top: 1px solid var(--gray-light);">
                        ${notif.mensaje.substring(0, 100)}...
                    </div>
                </div>
            `;
        });
        
        historialHTML += `</div><div class="overlay active" onclick="cerrarModalHistorial()"></div>`;
        
        // Agregar al DOM
        const div = document.createElement('div');
        div.innerHTML = historialHTML;
        div.id = 'modalHistorialNotificaciones';
        document.body.appendChild(div);
        
    } catch (error) {
        console.error('Error al cargar historial:', error);
        showNotification('Error al cargar historial', 'error');
    }
}

// Función para cerrar modal de historial
function cerrarModalHistorial() {
    const modal = document.getElementById('modalHistorialNotificaciones');
    if (modal) modal.remove();
    
    const overlay = document.querySelector('.overlay.active');
    if (overlay) overlay.remove();
}

// Limpiar lista de turnos afectados
function limpiarListaTurnosAfectados() {
    if (turnosAfectadosCache.length === 0) return;
    
    if (confirm(`¿Limpiar la lista de ${turnosAfectadosCache.length} turno(s) afectado(s)?`)) {
        turnosAfectadosCache = [];
        actualizarListaTurnosAfectados();
        showNotification('Lista de turnos afectados limpiada', 'info');
    }
}

// AGREGAR botón para limpiar lista (opcional)
function agregarBotonLimpiar() {
    const container = document.getElementById('listaTurnosAfectados');
    if (!container) return;
    
    const limpiarBtn = document.createElement('button');
    limpiarBtn.className = 'btn-accion btn-cancelar';
    limpiarBtn.style.marginTop = '10px';
    limpiarBtn.style.width = '100%';
    limpiarBtn.innerHTML = '<i class="fas fa-trash"></i> Limpiar Lista';
    limpiarBtn.onclick = limpiarListaTurnosAfectados;
    
    container.parentNode.insertBefore(limpiarBtn, container.nextSibling);
}

// Inicializar al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    // Agregar botón de limpiar después de cargar
    setTimeout(agregarBotonLimpiar, 1000);
});

// Funciones auxiliares para horarios semanales
function toggleConfigDia(diaKey) {
    const container = document.getElementById(`config_${diaKey}`);
    if (container) {
        container.style.display = container.style.display === 'none' ? 'block' : 'none';
    }
}

function actualizarEstadoDia(diaKey) {
    const checkbox = document.getElementById(`activo_${diaKey}`);
    if (!horariosSemanales[diaKey]) {
        horariosSemanales[diaKey] = {};
    }
    horariosSemanales[diaKey].activo = checkbox.checked;
    
    // Mostrar/ocultar configuración
    const container = document.getElementById(`config_${diaKey}`);
    if (container) {
        container.style.display = checkbox.checked ? 'block' : 'none';
    }
}

function actualizarHoraDia(diaKey) {
    const horaInicio = document.getElementById(`hora_inicio_${diaKey}`).value;
    const horaFin = document.getElementById(`hora_fin_${diaKey}`).value;
    
    if (!horariosSemanales[diaKey]) {
        horariosSemanales[diaKey] = {};
    }
    
    horariosSemanales[diaKey].hora_inicio = horaInicio;
    horariosSemanales[diaKey].hora_fin = horaFin;
}

function agregarDescansoDia(diaKey) {
    const container = document.getElementById(`descansos_${diaKey}`);
    
    if (!horariosSemanales[diaKey]) {
        horariosSemanales[diaKey] = { descansos: [] };
    }
    if (!horariosSemanales[diaKey].descansos) {
        horariosSemanales[diaKey].descansos = [];
    }
    
    const descansoItem = document.createElement('div');
    descansoItem.className = 'descanso-item';
    descansoItem.innerHTML = `
        <input type="time" class="form-control" value="12:00" onchange="actualizarDescansoDia('${diaKey}')">
        <button class="btn-eliminar-descanso" onclick="eliminarDescansoDia('${diaKey}', this)">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    container.appendChild(descansoItem);
}

function actualizarDescansoDia(diaKey) {
    const container = document.getElementById(`descansos_${diaKey}`);
    const inputs = container.querySelectorAll('input');
    
    if (!horariosSemanales[diaKey]) {
        horariosSemanales[diaKey] = {};
    }
    
    horariosSemanales[diaKey].descansos = Array.from(inputs)
        .map(input => input.value)
        .filter(value => value);
}

function eliminarDescansoDia(diaKey, button) {
    const item = button.parentElement;
    item.remove();
    actualizarDescansoDia(diaKey);
}

// Cerrar modales
function cerrarModalHorariosSemanales() {
    const modal = document.getElementById('modalHorariosSemanales');
    const overlay = document.getElementById('overlayHorariosSemanales');
    
    if (modal && overlay) {
        modal.classList.remove('active');
        overlay.classList.remove('active');
    }
}

function cerrarModalNotificarCambios() {
    const modal = document.getElementById('modalNotificarCambios');
    const overlay = document.getElementById('overlayHorariosSemanales');
    
    if (modal && overlay) {
        modal.classList.remove('active');
        overlay.classList.remove('active');
    }
    
    cambiosPendientes = null;
}

function cerrarModalHistorial() {
    const modal = document.getElementById('modalHistorialNotificaciones');
    const overlay = document.getElementById('overlayHorariosSemanales');
    
    if (modal && overlay) {
        modal.classList.remove('active');
        overlay.classList.remove('active');
    }
}

// Actualizar resumen de horarios semanales
function actualizarResumenHorariosSemanales() {
    const container = document.getElementById('resumenHorariosSemanales');
    if (!container) return;
    
    const dias = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
    const nombresDias = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
    
    let html = `
        <div style="color: var(--primary); font-weight: bold; margin-bottom: 10px;">
            <i class="fas fa-calendar-week"></i> Configuración Actual
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
    `;
    
    dias.forEach((diaKey, index) => {
        const config = horariosSemanales[diaKey];
        
        if (config) {
            html += `
                <div style="background-color: ${config.activo ? 'rgba(76, 175, 80, 0.1)' : 'rgba(244, 67, 54, 0.1)'}; 
                            padding: 10px; border-radius: 5px; border: 1px solid ${config.activo ? 'var(--success)' : 'var(--error)'};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <div style="font-weight: bold; color: ${config.activo ? 'var(--success)' : 'var(--error)'};">
                            ${nombresDias[index]}
                        </div>
                        <div style="font-size: 0.8rem; color: #aaa;">
                            ${config.activo ? '✓ Activo' : '✗ Inactivo'}
                        </div>
                    </div>
                    ${config.activo ? `
                        <div style="color: #aaa; font-size: 0.85rem;">
                            ${config.hora_inicio} - ${config.hora_fin}
                            ${config.descansos && config.descansos.length > 0 ? 
                                `<br><span style="color: #888; font-size: 0.8rem;">Descansos: ${config.descansos.join(', ')}</span>` : 
                                ''
                            }
                        </div>
                    ` : ''}
                </div>
            `;
        }
    });
    
    html += `</div>`;
    container.innerHTML = html;
}

// Probar notificación de WhatsApp
async function probarNotificacionWhatsApp() {
    try {
        // Crear un mensaje de prueba
        const mensajePrueba = `🔔 *PRUEBA DE NOTIFICACIÓN - A.S. Studio*

Hola Alexis, este es un mensaje de prueba del sistema de notificaciones automáticas.

✅ El sistema está funcionando correctamente.
✅ Se enviarán notificaciones automáticas cuando modifiques horarios.
✅ Los clientes recibirán enlaces para reagendar.

*Características:*
• Detección automática de cambios
• Mensajes personalizados
• Historial de notificaciones
• Enlaces directos a WhatsApp

*Próximos pasos:*
1. Configura los horarios semanales
2. Modifica algún día existente
3. El sistema detectará los turnos afectados
4. Se enviarán notificaciones automáticas

¡Sistema listo para usar! 🚀

*Fecha:* ${new Date().toLocaleDateString('es-ES')}
*Hora:* ${new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}`;

        // Abrir WhatsApp con el mensaje de prueba
        const urlWhatsApp = `https://wa.me/?text=${encodeURIComponent(mensajePrueba)}`;
        window.open(urlWhatsApp, '_blank');
        
        showNotification('Mensaje de prueba listo para enviar', 'success');
        
    } catch (error) {
        console.error('Error en prueba de WhatsApp:', error);
        showNotification('Error al preparar prueba', 'error');
    }
}

// Inicializar sistema de notificaciones
async function inicializarSistemaNotificaciones() {
    
    console.log('✅ Sistema de notificaciones inicializado');
}

// Agregar al loadInitialData
async function loadInitialData() {
    try {
        console.log('Cargando datos iniciales...');
        
        if (isLoadingData) {
            console.log('Ya se está cargando datos...');
            return;
        }
        
        isLoadingData = true;
        showLoading();

        window.isInitialLoad = true;
        
        // 1. Cargar datos iniciales
        await cargarConfiguracionAgenda();
        await cargarConfigFidelidad();

        await updateDashboard();
        await loadServicios();
        await loadOfertas();
        await cargarServiciosAdicionales();
        
        // 2. Configurar escuchadores en tiempo real
        setupRealTimeListeners();
        
        // 3. Configurar verificación de sesión
        setupSessionMonitoring();
        
        // 4. Inicializar sistema de notificaciones
        await inicializarSistemaNotificaciones(); // ← NUEVA LÍNEA
        
        isLoadingData = false;
        
        setTimeout(() => {
            hideLoading();
            showNotification('Sistema conectado en tiempo real ✅', 'success');
        }, 1000);

    } catch (error) {
        console.error('Error al cargar datos iniciales:', error);
        showNotification('Error al cargar datos iniciales: ' + error.message, 'error');
        isLoadingData = false;
        hideLoading();
    }
}

// Mostrar modal de servicios adicionales para un turno
async function mostrarServiciosAdicionales(turno) {
    try {
        // Guardar referencia al turno
        turnoParaServiciosAdicionales = turno;
        
        // Resetear selección
        serviciosSeleccionados = {};
        
        // Cargar servicios adicionales si no están cargados
        if (serviciosAdicionalesData.length === 0) {
            await cargarServiciosAdicionales();
        }
        
        // Mostrar precio del servicio principal
        document.getElementById('precioServicioPrincipal').textContent = 
            `$${turno.precio.toLocaleString('es-AR')}`;
        
        // Renderizar lista de servicios
        const container = document.getElementById('listaServiciosAdicionales');
        container.innerHTML = '';
        
        serviciosAdicionalesData.forEach(servicio => {
            if (!servicio.activo) return;
            
            const cantidad = serviciosSeleccionados[servicio.id] || 0;
            const subtotal = cantidad * servicio.precio;
            
            const item = document.createElement('div');
            item.className = `servicio-adicional-item ${cantidad > 0 ? 'seleccionado' : ''}`;
            item.innerHTML = `
                <div class="servicio-adicional-info">
                    <div class="servicio-adicional-nombre">${servicio.nombre}</div>
                    <div class="servicio-adicional-precio">$${servicio.precio.toLocaleString('es-AR')}</div>
                </div>
                <div class="contador-servicio">
                    <button class="btn-contador" onclick="disminuirServicio('${servicio.id}')">-</button>
                    <span class="contador-valor">${cantidad}</span>
                    <button class="btn-contador" onclick="aumentarServicio('${servicio.id}')">+</button>
                </div>
                ${cantidad > 0 ? `<div style="margin-left: 10px; color: var(--primary); font-weight: bold;">$${subtotal.toLocaleString('es-AR')}</div>` : ''}
            `;
            
            container.appendChild(item);
        });
        
        // Actualizar totales
        actualizarTotalesServicios();
        
        // Mostrar modal
        const modal = document.getElementById('modalServiciosAdicionales');
        const overlay = document.getElementById('overlayServiciosAdicionales');
        
        if (modal && overlay) {
            modal.classList.add('active');
            overlay.classList.add('active');
        }
        
    } catch (error) {
        console.error('Error al mostrar servicios adicionales:', error);
        showNotification('Error al cargar servicios adicionales', 'error');
    }
}

// Cerrar modal de servicios adicionales
function cerrarModalServiciosAdicionales() {
    const modal = document.getElementById('modalServiciosAdicionales');
    const overlay = document.getElementById('overlayServiciosAdicionales');
    
    if (modal && overlay) {
        modal.classList.remove('active');
        overlay.classList.remove('active');
        
        // Limpiar datos
        turnoParaServiciosAdicionales = null;
        serviciosSeleccionados = {};
    }
}

// Aumentar cantidad de un servicio
function aumentarServicio(servicioId) {
    if (!serviciosSeleccionados[servicioId]) {
        serviciosSeleccionados[servicioId] = 1;
    } else {
        serviciosSeleccionados[servicioId]++;
    }
    
    // Actualizar UI
    actualizarItemServicio(servicioId);
    actualizarTotalesServicios();
}

// Disminuir cantidad de un servicio
function disminuirServicio(servicioId) {
    if (serviciosSeleccionados[servicioId] && serviciosSeleccionados[servicioId] > 0) {
        serviciosSeleccionados[servicioId]--;
        
        if (serviciosSeleccionados[servicioId] === 0) {
            delete serviciosSeleccionados[servicioId];
        }
        
        // Actualizar UI
        actualizarItemServicio(servicioId);
        actualizarTotalesServicios();
    }
}

// Actualizar item individual del servicio
function actualizarItemServicio(servicioId) {
    const servicio = serviciosAdicionalesData.find(s => s.id === servicioId);
    if (!servicio) return;
    
    const cantidad = serviciosSeleccionados[servicioId] || 0;
    const subtotal = cantidad * servicio.precio;
    
    // Buscar el elemento en la lista
    const items = document.querySelectorAll('.servicio-adicional-item');
    items.forEach(item => {
        const nombreElement = item.querySelector('.servicio-adicional-nombre');
        if (nombreElement && nombreElement.textContent === servicio.nombre) {
            const contadorValor = item.querySelector('.contador-valor');
            const precioSubtotal = item.querySelector('.servicio-adicional-precio + div') || 
                                  item.querySelector('.contador-servicio + div');
            
            // Actualizar cantidad
            if (contadorValor) {
                contadorValor.textContent = cantidad;
            }
            
            // Actualizar subtotal o removerlo
            if (precioSubtotal) {
                if (cantidad > 0) {
                    precioSubtotal.textContent = `$${subtotal.toLocaleString('es-AR')}`;
                    precioSubtotal.style.display = 'block';
                } else {
                    precioSubtotal.style.display = 'none';
                }
            } else if (cantidad > 0) {
                // Crear elemento de subtotal si no existe
                const subtotalElement = document.createElement('div');
                subtotalElement.style.marginLeft = '10px';
                subtotalElement.style.color = 'var(--primary)';
                subtotalElement.style.fontWeight = 'bold';
                subtotalElement.textContent = `$${subtotal.toLocaleString('es-AR')}`;
                
                const contadorDiv = item.querySelector('.contador-servicio');
                if (contadorDiv) {
                    contadorDiv.after(subtotalElement);
                }
            }
            
            // Actualizar clase de selección
            if (cantidad > 0) {
                item.classList.add('seleccionado');
            } else {
                item.classList.remove('seleccionado');
            }
        }
    });
}

// Actualizar totales
function actualizarTotalesServicios() {
    let totalAdicionales = 0;
    const serviciosDetalles = [];
    
    Object.keys(serviciosSeleccionados).forEach(servicioId => {
        const servicio = serviciosAdicionalesData.find(s => s.id === servicioId);
        if (servicio && serviciosSeleccionados[servicioId] > 0) {
            const subtotal = serviciosSeleccionados[servicioId] * servicio.precio;
            totalAdicionales += subtotal;
            
            serviciosDetalles.push({
                id: servicioId,
                nombre: servicio.nombre,
                precio_unitario: servicio.precio,
                cantidad: serviciosSeleccionados[servicioId],
                subtotal: subtotal
            });
        }
    });
    
    const precioPrincipal = turnoParaServiciosAdicionales ? turnoParaServiciosAdicionales.precio : 0;
    const totalPagar = precioPrincipal + totalAdicionales;
    
    // Actualizar UI
    document.getElementById('totalServiciosAdicionales').textContent = 
        `$${totalAdicionales.toLocaleString('es-AR')}`;
    document.getElementById('totalPagar').textContent = 
        `$${totalPagar.toLocaleString('es-AR')}`;
    
    return { totalAdicionales, serviciosDetalles, totalPagar };
}

// Aplicar servicios adicionales al turno
async function aplicarServiciosAdicionales() {
    try {
        if (!turnoParaServiciosAdicionales) {
            showNotification('No hay turno seleccionado', 'error');
            return;
        }
        
        showLoading();
        
        const { totalAdicionales, serviciosDetalles, totalPagar } = actualizarTotalesServicios();
        
        if (serviciosDetalles.length === 0) {
            showNotification('No has seleccionado ningún servicio adicional', 'warning');
            hideLoading();
            return;
        }
        
        // Preparar datos para actualizar el turno
        const serviciosAdicionalesArray = serviciosDetalles.map(servicio => ({
            servicio_id: servicio.id,
            nombre: servicio.nombre,
            precio_unitario: servicio.precio_unitario,
            cantidad: servicio.cantidad,
            subtotal: servicio.subtotal
        }));
        
        // Actualizar el turno en Firebase
        await db.collection('turnos').doc(turnoParaServiciosAdicionales.id).update({
            servicios_adicionales: serviciosAdicionalesArray,
            precio_servicios_adicionales: totalAdicionales,
            precio_total: totalPagar,
            actualizado_en: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification('Servicios adicionales aplicados correctamente', 'success');
        
        // Actualizar vista del turno
        await mostrarDetallesTurno(turnoParaServiciosAdicionales.id);
        
        // Cerrar modal
        cerrarModalServiciosAdicionales();
        
        // Actualizar dashboard si está visible
        if (document.getElementById('dashboard').classList.contains('active')) {
            await updateDashboard();
        }
        
        // Actualizar turnos si está visible
        if (document.getElementById('turnos').classList.contains('active')) {
            await loadTurnos();
            await cargarGridHorarios();
        }
        
        hideLoading();
        
    } catch (error) {
        console.error('Error al aplicar servicios adicionales:', error);
        showNotification('Error al aplicar servicios: ' + error.message, 'error');
        hideLoading();
    }
}

// Función para reiniciar contador cuando se complete el ciclo
async function reiniciarContadorFidelidad(telefonoCliente) {
    try {
        console.log('Reiniciando contador para:', telefonoCliente);
        
        // Limpiar teléfono para búsqueda
        const telefonoLimpio = telefonoCliente.replace(/\D/g, '');
        
        // Buscar todos los turnos del cliente
        const querySnapshot = await db.collection('turnos')
            .where('telefono', '>=', telefonoLimpio)
            .where('telefono', '<=', telefonoLimpio + '\uf8ff')
            .get();
        
        // Crear un batch para actualizar todos los turnos
        const batch = db.batch();
        let actualizados = 0;
        
        querySnapshot.docs.forEach(doc => {
            // Marcar que ya se reinició el contador para este ciclo
            batch.update(doc.ref, {
                ciclo_fidelidad_completado: true,
                ultima_actualizacion_fidelidad: firebase.firestore.FieldValue.serverTimestamp()
            });
            actualizados++;
        });
        
        await batch.commit();
        console.log(`Contador reiniciado para ${actualizados} turnos`);
        
    } catch (error) {
        console.error('Error al reiniciar contador:', error);
    }
}

// Función para verificar si se debe reiniciar el contador
async function verificarReinicioFidelidad(telefonoCliente, totalAsistidos) {
    try {
        // Si es múltiplo exacto de 4 (0, 4, 8, 12...)
        if (totalAsistidos > 0 && totalAsistidos % 4 === 0) {
            // Verificar si ya se reinició para este ciclo
            const telefonoLimpio = telefonoCliente.replace(/\D/g, '');
            
            const turnoRef = await db.collection('turnos')
                .where('telefono', '>=', telefonoLimpio)
                .where('telefono', '<=', telefonoLimpio + '\uf8ff')
                .limit(1)
                .get();
            
            if (!turnoRef.empty) {
                const turno = turnoRef.docs[0].data();
                
                // Si no se ha marcado como ciclo completado, reiniciar
                if (!turno.ciclo_fidelidad_completado) {
                    await reiniciarContadorFidelidad(telefonoCliente);
                    return true;
                }
            }
        }
        return false;
    } catch (error) {
        console.error('Error al verificar reinicio:', error);
        return false;
    }
}

async function renderTopClientes(turnos) {
    const container = document.getElementById('topClientes');
    if (!container) return;
    
    const visitasPorCliente = {};
    
    turnos?.forEach(turno => {
        if (!visitasPorCliente[turno.nombre]) {
            visitasPorCliente[turno.nombre] = {
                nombre: turno.nombre,
                visitas: 0,
                totalGastado: 0
            };
        }
        visitasPorCliente[turno.nombre].visitas++;
        visitasPorCliente[turno.nombre].totalGastado += turno.precio || 0;
    });
    
    const topClientes = Object.values(visitasPorCliente)
        .sort((a, b) => b.visitas - a.visitas)
        .slice(0, 5);
    
    if (topClientes.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #aaa;">
                <i class="fas fa-users fa-3x" style="margin-bottom: 15px;"></i>
                <p>No hay datos de clientes</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    topClientes.forEach((cliente, index) => {
        const esOro = index === 0;
        const esPlata = index === 1;
        const esBronce = index === 2;
        
        const colorMedalla = esOro ? '#FFD700' : esPlata ? '#C0C0C0' : esBronce ? '#CD7F32' : 'var(--primary)';
        const iconoMedalla = esOro ? 'fa-crown' : esPlata ? 'fa-medal' : esBronce ? 'fa-medal' : 'fa-user';
        
        html += `
            <div class="cliente-item" style="border-left-color: ${colorMedalla};">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas ${iconoMedalla}" style="color: ${colorMedalla};"></i>
                    <div>
                        <div style="font-weight: bold;">${cliente.nombre}</div>
                        <div style="color: #aaa; font-size: 0.8rem;">$${cliente.totalGastado.toLocaleString('es-AR')} total</div>
                    </div>
                </div>
                <div class="cliente-visitas" style="background-color: ${colorMedalla};">
                    ${cliente.visitas} visita${cliente.visitas !== 1 ? 's' : ''}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

async function renderGraficosMetricas(turnos, turnosAsistieron) {
    try {
        if (graficoIngresos) graficoIngresos.destroy();
        if (graficoServicios) graficoServicios.destroy();
        if (graficoAsistencia) graficoAsistencia.destroy();
        
        const ingresosPorDia = {};
        const serviciosCount = {};
        const estadosCount = {
            asistio: 0,
            no_asistio: 0,
            cancelado: 0,
            pendiente: 0,
            confirmado: 0
        };
        
        turnos?.forEach(turno => {
            const fecha = turno.fecha;
            if (!ingresosPorDia[fecha]) ingresosPorDia[fecha] = 0;
            if (turno.estado === 'asistio') {
                ingresosPorDia[fecha] += turno.precio || 0;
            }
            
            if (!serviciosCount[turno.servicio]) serviciosCount[turno.servicio] = 0;
            serviciosCount[turno.servicio]++;
            
            if (estadosCount[turno.estado] !== undefined) {
                estadosCount[turno.estado]++;
            }
        });
        
        const diasOrdenados = Object.keys(ingresosPorDia).sort();
        
        const ctxIngresos = document.getElementById('graficoIngresos');
        if (ctxIngresos) {
            graficoIngresos = new Chart(ctxIngresos, {
                type: 'line',
                data: {
                    labels: diasOrdenados,
                    datasets: [{
                        label: 'Ingresos por día ($)',
                        data: diasOrdenados.map(dia => ingresosPorDia[dia]),
                        borderColor: '#d4af37', // Dorado primario
                        backgroundColor: 'rgba(212, 175, 55, 0.2)', // Dorado con transparencia
                        pointBackgroundColor: '#d4af37',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#f5f5f5', // Blanco/light
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(42, 42, 42, 0.9)',
                            titleColor: '#d4af37',
                            bodyColor: '#f5f5f5',
                            borderColor: '#d4af37',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#aaaaaa',
                                callback: function(value) {
                                    return '$' + value.toLocaleString('es-AR');
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            title: {
                                display: true,
                                text: 'Ingresos ($)',
                                color: '#d4af37'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#aaaaaa',
                                maxRotation: 45
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            title: {
                                display: true,
                                text: 'Fecha',
                                color: '#d4af37'
                            }
                        }
                    }
                }
            });
        }
        
        const serviciosOrdenados = Object.entries(serviciosCount)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);
        
        const ctxServicios = document.getElementById('graficoServicios');
        if (ctxServicios) {
            graficoServicios = new Chart(ctxServicios, {
                type: 'doughnut',
                data: {
                    labels: serviciosOrdenados.map(s => s[0]),
                    datasets: [{
                        data: serviciosOrdenados.map(s => s[1]),
                        backgroundColor: [
                            '#d4af37', // Dorado primario
                            '#2196f3', // Azul info
                            '#4caf50', // Verde success
                            '#ff9800', // Naranja warning
                            '#f44336'  // Rojo error
                        ],
                        borderColor: 'var(--dark)',
                        borderWidth: 2,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutout: '50%',
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#f5f5f5',
                                font: {
                                    size: 11
                                },
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(42, 42, 42, 0.9)',
                            titleColor: '#d4af37',
                            bodyColor: '#f5f5f5',
                            borderColor: '#d4af37',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} turnos (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        const ctxAsistencia = document.getElementById('graficoAsistencia');
        if (ctxAsistencia) {
            const estadosData = [
                estadosCount.asistio,
                estadosCount.no_asistio,
                estadosCount.cancelado,
                estadosCount.pendiente + estadosCount.confirmado
            ];
            
            graficoAsistencia = new Chart(ctxAsistencia, {
                type: 'bar',
                data: {
                    labels: ['Asistió', 'No Asistió', 'Cancelado', 'Pendiente/Confirmado'],
                    datasets: [{
                        label: 'Cantidad de turnos',
                        data: estadosData,
                        backgroundColor: [
                            'rgba(76, 175, 80, 0.8)',    // Verde success
                            'rgba(244, 67, 54, 0.8)',    // Rojo error
                            'rgba(158, 158, 158, 0.8)',  // Gris
                            'rgba(255, 152, 0, 0.8)'     // Naranja warning
                        ],
                        borderColor: [
                            '#4caf50',
                            '#f44336',
                            '#9e9e9e',
                            '#ff9800'
                        ],
                        borderWidth: 1,
                        borderRadius: 5,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(42, 42, 42, 0.9)',
                            titleColor: '#d4af37',
                            bodyColor: '#f5f5f5',
                            borderColor: '#d4af37',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#aaaaaa',
                                precision: 0
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            title: {
                                display: true,
                                text: 'Cantidad de turnos',
                                color: '#d4af37'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#aaaaaa'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }
        
    } catch (error) {
        console.error('Error al renderizar gráficos:', error);
    }
}

function exportarMetricas() {
    showNotification('Exportación de métricas en desarrollo', 'info');
}

// ========== CONFIGURACIÓN DE EVENTOS ==========

function setupNavigation() {
    const navButtons = document.querySelectorAll('.nav-btn');

    navButtons.forEach(button => {
        button.addEventListener('click', function () {
            navButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');

            document.querySelectorAll('.dashboard-section').forEach(section => {
                section.classList.remove('active');
            });

            const sectionId = this.dataset.section;
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('active');

                switch (sectionId) {
                    case 'dashboard':
                        updateDashboard();
                        break;
                    case 'turnos':
                        loadTurnos();
                        cargarGridHorarios();
                        break;
                    case 'servicios':
                        loadServicios();
                          cargarServiciosAdicionales();
                        break;
                    case 'agenda':
                        loadAgenda();
                        break;
                    case 'ofertas':
                        loadOfertas();
                        break;
                    case 'metricas':
                        loadMetricas();
                        break;
                }
            }
        });
    });
}

function setupEventListeners() {
    // 🔥 LIMPIAR event listeners anteriores si existen
    const activarOfertaBtn = document.getElementById('activarOferta');
    if (activarOfertaBtn) {
        // Clonar y reemplazar para eliminar listeners antiguos
        const newBtn = activarOfertaBtn.cloneNode(true);
        activarOfertaBtn.parentNode.replaceChild(newBtn, activarOfertaBtn);
        
        // Agregar nuevo listener con protección
        newBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Deshabilitar botón durante la operación
            this.disabled = true;
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner loading-spinner"></i> Procesando...';
            
            try {
                await activarOferta();
            } finally {
                // Rehabilitar botón
                this.disabled = false;
                this.innerHTML = originalText;
            }
        });

        // Listener para guardar configuración de fidelidad
    const guardarConfigFidelidadBtn = document.getElementById('guardarConfigFidelidad');
    if (guardarConfigFidelidadBtn) {
        guardarConfigFidelidadBtn.addEventListener('click', guardarConfigFidelidad);
    }
    
    // Listener para actualizar ejemplo de turnos
    const turnosParaGratisInput = document.getElementById('turnosParaGratis');
    if (turnosParaGratisInput) {
        turnosParaGratisInput.addEventListener('input', function() {
            const ejemplo = document.getElementById('turnosRequeridosEjemplo');
            if (ejemplo) {
                ejemplo.textContent = `${this.value} turnos`;
            }
        });
    }
}
}

    
    // Hacer lo mismo para otros botones importantes
    const guardarServicioBtn = document.querySelector('#servicioForm button[type="submit"]');
    if (guardarServicioBtn) {
        guardarServicioBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            saveServicio();
        });
    }

function volverAHoy() {
    const hoy = formatDate(new Date());
    
    // Actualizar el campo de fecha
    const fechaHorarios = document.getElementById('fechaHorarios');
    if (fechaHorarios) {
        fechaHorarios.value = hoy;
    }
    
    // Recargar el grid de horarios
    cargarGridHorarios();
    
    // También actualizar el filtro de fecha en la sección de turnos (si existe)
    const filtroFecha = document.getElementById('filtroFecha');
    if (filtroFecha) {
        filtroFecha.value = hoy;
        loadTurnos();
    }
    
    showNotification('Mostrando horarios de hoy', 'info');
}

function resetFormularioOferta() {
    document.getElementById('ofertaNombre').value = 'Corte + Afeitado Especial';
    document.getElementById('ofertaDescripcion').value = '¡Oferta limitada! Corte de cabello + afeitado clásico';
    document.getElementById('precioNormal').value = 4700;
    document.getElementById('precioOferta').value = 3900;
    document.getElementById('duracionHoras').value = 24;
    document.querySelector('input[name="estadoOferta"][value="activa"]').checked = true;
}

    // Filtros de turnos
    const aplicarFiltros = document.getElementById('aplicarFiltros');
    if (aplicarFiltros) {
        aplicarFiltros.addEventListener('click', function () {
            loadTurnos();
        });
    }

    const resetFiltros = document.getElementById('resetFiltros');
    if (resetFiltros) {
        resetFiltros.addEventListener('click', function () {
            document.getElementById('filtroFecha').value = '';
            document.getElementById('filtroEstado').value = 'todos';
            document.getElementById('filtroCliente').value = '';
            loadTurnos();
        });
    }
    
    // Filtros de métricas
    const aplicarFiltrosMetricas = document.getElementById('aplicarFiltrosMetricas');
    if (aplicarFiltrosMetricas) {
        aplicarFiltrosMetricas.addEventListener('click', function () {
            loadMetricas();
        });
    }
    
    const exportarMetricasBtn = document.getElementById('exportarMetricas');
    if (exportarMetricasBtn) {
        exportarMetricasBtn.addEventListener('click', function () {
            exportarMetricas();
        });
    }

    // Fecha de horarios
    const fechaHorarios = document.getElementById('fechaHorarios');
    if (fechaHorarios) {
        fechaHorarios.addEventListener('change', function() {
            cargarGridHorarios();
        });
    }

    // Agenda - Configuración de día
    const guardarConfigDia = document.getElementById('guardarConfigDia');
    if (guardarConfigDia) {
        guardarConfigDia.addEventListener('click', function() {
            guardarConfiguracionDia();
        });
    }
    
    // Mostrar/ocultar horarios según estado del día
    document.querySelectorAll('input[name="estadoDia"]').forEach(radio => {
        radio.addEventListener('change', function () {
            const activo = this.value === 'activo';
            const configHorariosContenedor = document.getElementById('configHorariosContenedor');
            if (configHorariosContenedor) {
                configHorariosContenedor.style.display = activo ? 'block' : 'none';
            }
        });
    });

    // Opciones de repetición
    document.querySelectorAll('.opcion-repeticion').forEach(opcion => {
        opcion.addEventListener('click', function () {
            document.querySelectorAll('.opcion-repeticion').forEach(o => {
                o.classList.remove('active');
            });
            this.classList.add('active');
        });
    });

    // Ofertas - Tipo de duración
    document.querySelectorAll('.opcion-duracion').forEach(opcion => {
        opcion.addEventListener('click', function () {
            document.querySelectorAll('.opcion-duracion').forEach(o => {
                o.classList.remove('active');
            });
            this.classList.add('active');
            
            const tipo = this.dataset.tipo;
            ofertaConfig.tipoDuracion = tipo;
            
            if (tipo === 'horas') {
                document.getElementById('configHoras').style.display = 'block';
                document.getElementById('configRangoFecha').style.display = 'none';
            } else {
                document.getElementById('configHoras').style.display = 'none';
                document.getElementById('configRangoFecha').style.display = 'block';
            }
        });
    });

    // Calcular descuento
    const precioNormal = document.getElementById('precioNormal');
    const precioOferta = document.getElementById('precioOferta');
    
    if (precioNormal) precioNormal.addEventListener('input', calcularDescuento);
    if (precioOferta) precioOferta.addEventListener('input', calcularDescuento);
    
    // Duración en horas
    const duracionHoras = document.getElementById('duracionHoras');
    if (duracionHoras) {
        duracionHoras.addEventListener('input', actualizarTextoDuracion);
    }
    
    // Activar oferta
const activarOfertaBtn = document.getElementById('activarOferta');
if (activarOfertaBtn) {
    activarOfertaBtn.addEventListener('click', async function() {
        if (ofertaConfig.id) {
            // Si hay ID, es una actualización
            await actualizarOferta(ofertaConfig.id);
        } else {
            // Si no hay ID, es una nueva oferta
            await activarOferta();
        }
    });
}

// Función para actualizar oferta
async function actualizarOferta(id) {
    try {
        showLoading();
        
        const nombre = document.getElementById('ofertaNombre').value;
        const descripcion = document.getElementById('ofertaDescripcion').value;
        const precioNormal = parseFloat(document.getElementById('precioNormal').value);
        const precioOferta = parseFloat(document.getElementById('precioOferta').value);
        const estadoActiva = document.querySelector('input[name="estadoOferta"][value="activa"]').checked;
        const tipoDuracion = ofertaConfig.tipoDuracion;
        
        const ofertaData = {
            nombre,
            descripcion,
            precio_normal: precioNormal,
            precio_oferta: precioOferta,
            activa: estadoActiva,
            tipo_duracion: tipoDuracion,
            actualizado_en: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (tipoDuracion === 'horas') {
            const horas = parseInt(document.getElementById('duracionHoras').value);
            const inicio = new Date();
            const fin = new Date();
            fin.setHours(fin.getHours() + horas);
            
            ofertaData.inicio = inicio;
            ofertaData.fin = fin;
            ofertaData.duracion_horas = horas;
        } else {
            const fechaInicio = document.getElementById('fechaInicioOferta').value;
            const fechaFin = document.getElementById('fechaFinOferta').value;
            const horaInicio = document.getElementById('horaInicioOferta').value;
            const horaFin = document.getElementById('horaFinOferta').value;
            
            if (fechaInicio && horaInicio) {
                ofertaData.fecha_inicio = fechaInicio;
                ofertaData.hora_inicio = horaInicio;
                ofertaData.inicio = new Date(`${fechaInicio}T${horaInicio}`);
            }
            
            if (fechaFin && horaFin) {
                ofertaData.fecha_fin = fechaFin;
                ofertaData.hora_fin = horaFin;
                ofertaData.fin = new Date(`${fechaFin}T${horaFin}`);
            }
        }
        
        await db.collection('ofertas').doc(id).update(ofertaData);
        
        // Limpiar ID
        ofertaConfig.id = null;
        
        // Restaurar botón
        document.getElementById('activarOferta').innerHTML = '<i class="fas fa-play-circle"></i> Activar Oferta';
        
        showNotification('Oferta actualizada correctamente', 'success');
        await loadOfertas();
        hideLoading();
        
    } catch (error) {
        console.error('Error al actualizar oferta:', error);
        showNotification('Error al actualizar la oferta: ' + error.message, 'error');
        hideLoading();
    }
}
    
    // Ver vista previa
    const verVistaPreviaBtn = document.getElementById('verVistaPrevia');
    if (verVistaPreviaBtn) {
        verVistaPreviaBtn.addEventListener('click', function() {
            mostrarVistaPreviaOferta();
        });
    }

    // Overlay para cerrar modal
    const overlayDetalle = document.getElementById('overlayDetalle');
    if (overlayDetalle) {
        overlayDetalle.addEventListener('click', AdminApp.cerrarModalDetalle);
    }

async function limpiarDuplicados() {
    try {
        if (!confirm('¿Eliminar registros duplicados?\nEsta acción revisará todas las ofertas y servicios.')) {
            return;
        }
        
        showLoading();
        
        // 1. Limpiar ofertas duplicadas
        const ofertasSnapshot = await db.collection('ofertas').get();
        const ofertasMap = new Map();
        const ofertasDuplicadas = [];
        
        ofertasSnapshot.docs.forEach(doc => {
            const oferta = doc.data();
            const clave = `${oferta.nombre}_${oferta.precio_oferta}_${oferta.tipo_duracion}`;
            
            if (ofertasMap.has(clave)) {
                ofertasDuplicadas.push(doc.id);
            } else {
                ofertasMap.set(clave, doc.id);
            }
        });
        
        // Eliminar duplicados
        for (const id of ofertasDuplicadas) {
            await db.collection('ofertas').doc(id).delete();
            console.log('Oferta duplicada eliminada:', id);
        }
        
        // 2. Limpiar servicios duplicados
        const serviciosSnapshot = await db.collection('servicios').get();
        const serviciosMap = new Map();
        const serviciosDuplicados = [];
        
        serviciosSnapshot.docs.forEach(doc => {
            const servicio = doc.data();
            const clave = `${servicio.nombre}_${servicio.precio}`;
            
            if (serviciosMap.has(clave)) {
                serviciosDuplicados.push(doc.id);
            } else {
                serviciosMap.set(clave, doc.id);
            }
        });
        
        // Eliminar duplicados
        for (const id of serviciosDuplicados) {
            await db.collection('servicios').doc(id).delete();
            console.log('Servicio duplicado eliminado:', id);
        }
        
        showNotification(`Eliminados: ${ofertasDuplicadas.length} ofertas y ${serviciosDuplicados.length} servicios duplicados`, 'success');
        await loadServicios();
        await loadOfertas();
        
    } catch (error) {
        console.error('Error al limpiar duplicados:', error);
        showNotification('Error al limpiar duplicados', 'error');
    } finally {
        hideLoading();
    }
}

// Modificar la función para cargar agenda
async function loadAgenda() {
    try {
        showLoading();
        await cargarConfiguracionAgenda();
        
        // Si no hay fecha seleccionada y estamos en el mes actual, seleccionar hoy
        const hoy = new Date();
        const hoyFormatted = formatDate(hoy);
        
        if (!fechaSeleccionadaAgenda && hoy.getMonth() === mesAgendaActual && hoy.getFullYear() === anioAgendaActual) {
            // Ya se auto-selecciona en generarCalendarioAgenda()
        }
        
        hideLoading();
    } catch (error) {
        console.error('Error al cargar agenda:', error);
        showNotification('Error al cargar la agenda', 'error');
        hideLoading();
    }
}

// Función para sincronizar con calendario de usuario
async function sincronizarConCalendarioUsuario(configAgenda) {
    try {
        console.log('🔄 Sincronizando con calendario de usuario...', configAgenda.fecha);
        
        const configUsuario = {
            fecha: configAgenda.fecha,
            activo: configAgenda.activo,
            hora_inicio: configAgenda.hora_inicio,
            hora_fin: configAgenda.hora_fin,
            descansos: configAgenda.descansos || [],
            tipo: 'configuracion_agenda',
            sincronizado_en: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Guardar en calendario_usuario (accesible por usuarios)
        await db.collection('calendario_usuario').doc(configAgenda.fecha).set(configUsuario);
        
        // También guardar en horarios_agenda (solo admin)
        await db.collection('horarios_agenda').doc(configAgenda.fecha).set(configAgenda);
        
        console.log('✅ Configuración sincronizada a ambas colecciones');
        
    } catch (error) {
        console.error('❌ Error al sincronizar:', error);
    }
}

async function inicializarColecciones() {
    try {
        showLoading();
        
        const hoy = formatDate(new Date());
        
        // Crear configuración por defecto para hoy
        const configDefault = {
            fecha: hoy,
            activo: true,
            hora_inicio: '09:00',
            hora_fin: '19:00',
            descansos: ['12:00', '13:00'],
            tipo: 'configuracion_agenda'
        };
        
        // Guardar en calendario_usuario
        await db.collection('calendario_usuario').doc(hoy).set(configDefault);
        
        // Guardar en horarios_agenda
        await db.collection('horarios_agenda').doc(hoy).set(configDefault);
        
        showNotification('Colecciones inicializadas correctamente', 'success');
        
    } catch (error) {
        console.error('Error al inicializar:', error);
        showNotification('Error: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

// Modificar la función para configurar día desde el calendario
AdminApp.configurarDiaAgenda = function(fecha, scrollToConfig = false) {
    try {
        console.log('🔧 Configurando día:', fecha, 'scrollToConfig:', scrollToConfig);
        
        if (!fecha) return;
        
        // 1. GUARDAR LA NUEVA FECHA
        fechaSeleccionadaAgenda = fecha;
        
        // 2. LIMPIAR TODAS LAS SELECCIONES ANTERIORES
        document.querySelectorAll('.calendar-day').forEach(day => {
            // Remover clase selected
            day.classList.remove('selected');
            
            // Limpiar estilos inline de borde
            day.style.border = '';
            day.style.borderColor = '';
            day.style.boxShadow = '';
            day.style.transform = '';
            day.style.zIndex = '';
            
            // Eliminar indicador visual si existe
            const existingIndicator = day.querySelector('.selected-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
        });
        
        // 3. BUSCAR EL DÍA QUE SE ESTÁ SELECCIONANDO
        let diaElemento = null;
        
        // Primero buscar por data-fecha
        document.querySelectorAll('.calendar-day').forEach(day => {
            if (day.getAttribute('data-fecha') === fecha) {
                diaElemento = day;
            }
        });
        
        // Si no lo encuentra, buscar por número de día
        if (!diaElemento) {
const fechaObj = new Date(fecha + 'T12:00:00');
const diaDelMes = fechaObj.getDate();
const mesActual = fechaObj.getMonth() + 1;
            const anioActual = fechaObj.getFullYear();
            
            document.querySelectorAll('.calendar-day').forEach(day => {
                const dayNumElement = day.querySelector('.day-number');
                if (dayNumElement) {
                    const dayNum = parseInt(dayNumElement.textContent);
                    if (!isNaN(dayNum) && dayNum === diaDelMes) {
                        // Verificar que sea del mes correcto
                        const dayFecha = day.getAttribute('data-fecha');
                        if (dayFecha) {
                            const [year, month] = dayFecha.split('-').map(Number);
                            if (year === anioActual && month === mesActual) {
                                diaElemento = day;
                            }
                        }
                    }
                }
            });
        }
        
        // 4. APLICAR ESTILOS AL NUEVO DÍA SELECCIONADO
        if (diaElemento) {
            console.log('✅ Día encontrado para seleccionar:', diaElemento);
            
            // Agregar clase selected (CSS se encarga del borde)
            diaElemento.classList.add('selected');
            
            // Solo aplicar estilos inline si el CSS falla
            diaElemento.style.border = '3px solid #9c27b0';
            diaElemento.style.boxShadow = '0 0 10px rgba(156, 39, 176, 0.5)';
            
            // Crear indicador visual
            const indicator = document.createElement('div');
            indicator.className = 'selected-indicator';
            indicator.innerHTML = '✓';
            indicator.style.cssText = `
                position: absolute;
                top: 5px;
                right: 5px;
                background-color: #9c27b0;
                color: white;
                width: 18px;
                height: 18px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 11px;
                font-weight: bold;
                z-index: 11;
                pointer-events: none;
            `;
            diaElemento.appendChild(indicator);
            
            // 5. ACTUALIZAR TÍTULO
            const fechaObj = new Date(fecha + 'T12:00:00');
            const fechaFormateada = fechaObj.toLocaleDateString('es-ES', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            const tituloElemento = document.getElementById('fechaConfigTitulo');
            if (tituloElemento) {
                tituloElemento.textContent = fechaFormateada;
            }
            
            // 6. MOSTRAR CARD DE CONFIGURACIÓN
            const cardConfig = document.getElementById('cardConfigDia');
            if (cardConfig) {
                cardConfig.style.display = 'block';
                
                // Scroll automático si se solicitó
                if (scrollToConfig) {
                    console.log('🔄 Ejecutando scroll automático...');
                    
                    setTimeout(() => {
                        cardConfig.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start',
                            inline: 'nearest'
                        });
                    }, 300);
                }
            }
            
            // 7. CARGAR CONFIGURACIÓN DEL DÍA
            cargarConfiguracionDia(fecha);
            
            console.log('✅ Día seleccionado correctamente:', fecha);
            
        } else {
            console.error('❌ No se pudo encontrar el elemento del día para:', fecha);
            showNotification('No se pudo seleccionar el día', 'error');
        }
        
    } catch (error) {
        console.error('❌ Error en configurarDiaAgenda:', error);
        showNotification('Error al seleccionar día: ' + error.message, 'error');
    }
};

// Función para cerrar modal
AdminApp.cerrarModalDetalle = function() {
    const modal = document.getElementById('modalDetalleTurno');
    const overlay = document.getElementById('overlayDetalle');
    
    if (modal) modal.classList.remove('active');
    if (overlay) overlay.classList.remove('active');
};

// Función para cancelar turno
AdminApp.cancelarTurno = async function(id) {
    if (confirm('¿Estás seguro de cancelar este turno?')) {
        await AdminApp.cambiarEstadoTurno(id, 'cancelado');
    }
};

// ========== FUNCIONES PARA DASHBOARD - BOTONES DE ACCIÓN ==========
AdminApp.cambiarEstadoTurno = async function(id, nuevoEstado) {
    try {
        showLoading();
        
        const turnoDoc = await db.collection('turnos').doc(id).get();
        const turno = { id: turnoDoc.id, ...turnoDoc.data() };
        
        await db.collection('turnos').doc(id).update({
            estado: nuevoEstado,
            actualizado_en: firebase.firestore.FieldValue.serverTimestamp()
        });
            
        showNotification(`Turno actualizado a: ${getEstadoTexto(nuevoEstado)}`, 'success');
        
        // Actualizar vistas
        await updateDashboard();
        await loadTurnos();
        await cargarGridHorarios();
        
        // Cerrar modal si está abierto
        AdminApp.cerrarModalDetalle();
        
        hideLoading();
        
    } catch (error) {
        console.error('Error al cambiar estado:', error);
        showNotification('Error al actualizar el turno', 'error');
        hideLoading();
    }
};

// ========== FUNCIONES PARA SERVICIOS (FALTANTES) ==========
AdminApp.editarServicio = editarServicio;
AdminApp.eliminarServicio = eliminarServicio;

// ========== MODAL DE VISTA PREVIA OFERTAS MEJORADO ==========
function mostrarVistaPreviaOferta() {
    const nombre = document.getElementById('ofertaNombre').value;
    const descripcion = document.getElementById('ofertaDescripcion').value;
    const precioNormal = parseFloat(document.getElementById('precioNormal').value);
    const precioOferta = parseFloat(document.getElementById('precioOferta').value);
    
    const ahorro = precioNormal - precioOferta;
    const porcentaje = ((ahorro / precioNormal) * 100).toFixed(0);
    
    // Crear modal de vista previa
    const modalHTML = `
        <div id="modalVistaPrevia" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10001; background: linear-gradient(135deg, #1a1a1a, #2a2a2a); padding: 30px; border-radius: 15px; border: 3px solid rgba(212, 175, 55, 0.8); box-shadow: 0 0 40px rgba(212, 175, 55, 0.4), 0 0 80px rgba(212, 175, 55, 0.2); max-width: 500px; width: 90%;">
            <div style="text-align: center; margin-bottom: 25px;">
                <div style="font-size: 2rem; color: #d4af37; margin-bottom: 15px; text-shadow: 0 0 10px rgba(212, 175, 55, 0.7);">
                    <i class="fas fa-gift"></i> OFERTA ESPECIAL
                </div>
                <h2 style="color: #d4af37; margin-bottom: 15px; text-shadow: 0 0 8px rgba(212, 175, 55, 0.5);">${nombre}</h2>
                <p style="color: #aaa; font-size: 1.1rem;">${descripcion}</p>
            </div>
            
            <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 2px solid rgba(212, 175, 55, 0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="text-align: center; flex: 1;">
                        <div style="color: #888; font-size: 0.9rem;">Precio Normal</div>
                        <div style="text-decoration: line-through; font-size: 1.5rem; color: #aaa;">$${precioNormal.toLocaleString('es-AR')}</div>
                    </div>
                    <div style="font-size: 2rem; color: #d4af37; margin: 0 20px;">→</div>
                    <div style="text-align: center; flex: 1;">
                        <div style="color: #4caf50; font-size: 0.9rem; font-weight: bold; text-shadow: 0 0 8px rgba(76, 175, 80, 0.5);">PRECIO OFERTA</div>
                        <div style="font-size: 2.5rem; color: #d4af37; font-weight: bold; text-shadow: 0 0 12px rgba(212, 175, 55, 0.8);">$${precioOferta.toLocaleString('es-AR')}</div>
                    </div>
                </div>
                
                <div style="text-align: center; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 10px; border: 2px solid rgba(76, 175, 80, 0.3); margin-top: 15px;">
                    <div style="color: #4caf50; font-size: 1.3rem; font-weight: bold; text-shadow: 0 0 8px rgba(76, 175, 80, 0.5);">
                        ¡AHORRÁ $${ahorro.toLocaleString('es-AR')} (${porcentaje}%)!
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button onclick="aceptarOfertaVistaPrevia()" style="flex: 1; background: linear-gradient(135deg, #4caf50, #2e7d32); color: white; border: none; padding: 15px; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 0 15px rgba(76, 175, 80, 0.4); display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <i class="fas fa-check-circle"></i> ACEPTAR OFERTA
                </button>
                <button onclick="cerrarVistaPrevia()" style="flex: 1; background: linear-gradient(135deg, #f44336, #c62828); color: white; border: none; padding: 15px; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 0 15px rgba(244, 67, 54, 0.4); display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <i class="fas fa-times-circle"></i> CERRAR
                </button>
            </div>
            
            <div style="margin-top: 20px; text-align: center; color: #888; font-size: 0.9rem;">
                <i class="fas fa-clock"></i> Vista previa - No se realizará ninguna acción
            </div>
        </div>
        <div id="overlayVistaPrevia" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000;"></div>
        <button class="btn-accion btn-no-asistio" id="cancelarEdicionOferta" style="flex: 1; display: none;">
    <i class="fas fa-times"></i> Cancelar Edición
</button>
    `;
    
    // Agregar al DOM
    const div = document.createElement('div');
    div.innerHTML = modalHTML;
    document.body.appendChild(div);
    
    // Agregar estilos para hover
    const btnAceptar = div.querySelector('button[onclick="aceptarOfertaVistaPrevia()"]');
    const btnCerrar = div.querySelector('button[onclick="cerrarVistaPrevia()"]');
    
    btnAceptar.onmouseover = () => {
        btnAceptar.style.transform = 'translateY(-3px)';
        btnAceptar.style.boxShadow = '0 0 25px rgba(76, 175, 80, 0.7)';
    };
    btnAceptar.onmouseout = () => {
        btnAceptar.style.transform = 'translateY(0)';
        btnAceptar.style.boxShadow = '0 0 15px rgba(76, 175, 80, 0.4)';
    };
    
    btnCerrar.onmouseover = () => {
        btnCerrar.style.transform = 'translateY(-3px)';
        btnCerrar.style.boxShadow = '0 0 25px rgba(244, 67, 54, 0.7)';
    };
    btnCerrar.onmouseout = () => {
        btnCerrar.style.transform = 'translateY(0)';
        btnCerrar.style.boxShadow = '0 0 15px rgba(244, 67, 54, 0.4)';
    };
}

function aceptarOfertaVistaPrevia() {
    // Lanzar confeti
    confetti({
        particleCount: 150,
        spread: 70,
        origin: { y: 0.6 },
        colors: ['#d4af37', '#4caf50', '#2196f3', '#ff9800']
    });
    
    // Mostrar mensaje
    showNotification('¡Oferta aceptada! (Vista previa)', 'success');
    
    // Cerrar modal después de 2 segundos
    setTimeout(cerrarVistaPrevia, 2000);
}

function cerrarVistaPrevia() {
    const modal = document.getElementById('modalVistaPrevia');
    const overlay = document.getElementById('overlayVistaPrevia');
    
    if (modal) modal.remove();
    if (overlay) overlay.remove();
}

// ========== INICIALIZACIÓN Y LISTENERS SERVICIOS ADICIONALES ==========

// Configurar overlay para cerrar modales
document.addEventListener('DOMContentLoaded', function() {
    const overlay = document.getElementById('overlayServiciosAdicionales');
    if (overlay) {
        overlay.addEventListener('click', function() {
            cerrarModalServiciosAdicionales();
            cerrarModalNuevoServicio();
        });
    }

    // Teclado shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            cerrarModalServiciosAdicionales();
            cerrarModalNuevoServicio();
        }
    });
});

// Agregar estas funciones al objeto AdminApp
AdminApp.cerrarModalServiciosAdicionales = cerrarModalServiciosAdicionales;
AdminApp.aplicarServiciosAdicionales = aplicarServiciosAdicionales;
AdminApp.mostrarServiciosAdicionales = mostrarServiciosAdicionales;
</script>
</body>

</html>
